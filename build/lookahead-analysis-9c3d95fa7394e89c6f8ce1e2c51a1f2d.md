---
title: 前瞻性分析指南
subject: Freqtrade 前瞻性分析
subtitle: 验证策略中的前瞻性偏差
short_title: 前瞻性分析
description: 前瞻性分析是一个用于检测和验证交易策略中是否存在前瞻性偏差的工具。本文档详细介绍了如何使用该工具来确保策略的有效性。
---

# 前瞻性分析

本页解释了如何验证你的策略是否存在前瞻性偏差。

前瞻性偏差是任何策略的祸根，因为有时很容易引入这种偏差，但可能很难发现。

回测会初始化所有时间戳（将整个数据框加载到内存中）并一次性计算所有指标。
这意味着如果你的指标或入场/出场信号查看未来的蜡烛图，这将使你的回测结果失真。

`lookahead-analysis` 命令需要历史数据可用。
要了解如何获取你感兴趣的交易对和交易所的数据，
请查看文档的[数据下载](data-download.md)部分。
`lookahead-analysis` 也支持 freqai 策略。

该命令在内部链接回测并探测策略以触发前瞻性偏差。
这是通过不查看策略代码本身，而是通过比较完整回测中改变的指标值和移动的入场/出场点来实现的。

`lookahead-analysis` 可以使用[回测](backtesting.md)的典型选项，但强制使用以下选项：

- `--cache` 强制设置为 "none"。
- `--max-open-trades` 强制至少等于交易对数量。
- `--dry-run-wallet` 强制设置为基本无限（10亿）。
- `--stake-amount` 强制设置为静态 10000（1万）。
- `--enable-protections` 强制关闭。

这些设置是为了避免用户意外产生误报。

## lookahead-analysis 命令参考

```{include} commands/lookahead-analysis.md
```

:::{note}
上述输出已简化为 `lookahead-analysis` 在常规回测命令之上添加的选项。
:::

### 介绍

许多策略在程序员不知情的情况下都陷入了前瞻性偏差的陷阱。
这通常会使策略回测看起来有利可图，有时甚至达到极端程度，但这并不现实，因为策略通过查看在模拟或实盘模式下无法获得的数据来"作弊"。

策略可以"作弊"的原因是因为 freqtrade 回测过程在开始时就会填充完整的数据框，包括所有蜡烛图时间戳。
如果程序员不够谨慎或不了解内部工作原理
（有时这真的很难发现），那么策略就会看到未来的数据。

这个命令旨在尝试验证上述前瞻性偏差的有效性。

### 命令如何工作？

它首先会对所有交易对进行回测，为指标和入场/出场生成基准。
在初始回测运行后，它会检查是否满足 `minimum-trade-amount`，如果不满足则取消该策略的前瞻性分析。
如果发生这种情况，请使用更宽的时间范围来获取更多交易进行分析，或使用发生更多交易的时间范围。

设置基准后，它将为每个入场和出场分别进行额外的回测运行。
当这些验证回测完成后，它将比较信号蜡烛图（包括入场和出场）的指标并报告偏差。
在所有信号都被验证或证伪后，将为用户生成一个结果表。

### 如何发现和消除偏差？如何挽救有偏差的策略？

如果你在网上发现了一个有偏差的策略，想要获得相同的结果，只是没有偏差，
那么在大多数情况下你会失望。
通常策略中的偏差是"好得难以置信"的利润的主要驱动因素。
移除那些因偏差而推高利润的条件或指标通常会使策略显著变差。
如果偏差指标或条件不是策略的核心，或者
有其他不带有偏差的入场和出场信号，你可能能够部分挽救它。

### 前瞻性偏差的例子

- `shift(-10)` 向前看 10 个蜡烛图。
- 在 populate_* 函数中使用 `iloc[]` 访问数据框中的特定行。
- 如果不严格控制循环的数字，for 循环很容易引入前瞻性偏差。
- 聚合函数如 `.mean()`、`.min()` 和 `.max()`，如果没有滚动窗口，
  将在**整个**数据框上计算值，因此信号蜡烛图将"看到"包含未来蜡烛图的值。
  一个无偏差的例子是使用 `rolling()` 向后看蜡烛图：
  例如 `dataframe['volume_mean_12'] = dataframe['volume'].rolling(12).mean()`
- `ta.MACD(dataframe, 12, 26, 1)` 在信号周期为 1 时会引入偏差。

### 结果表中的列是什么意思？

- `filename`：检查的策略文件名
- `strategy`：检查的策略类名
- `has_bias`：前瞻性分析的结果。`No` 表示良好，`Yes` 表示不良。
- `total_signals`：检查的信号数量（默认为 20）
- `biased_entry_signals`：发现的偏差入场信号数量
- `biased_exit_signals`：发现的偏差出场信号数量
- `biased_indicators`：显示在 populate_indicators 中定义的指标本身

如果你有与这些出场配对的偏差入场信号，你可能会在 `biased_exit_signals` 中得到误报。
然而，偏差入场通常也会导致偏差出场，
即使出场本身不产生偏差 -
特别是如果你的入场和出场条件使用相同的偏差指标。

**首先解决入场偏差，然后解决出场偏差。**

### 注意事项

- `lookahead-analysis` 只能验证/证伪它计算和验证的交易。
如果策略有许多不同的信号/信号类型，你需要选择适当的参数以确保所有信号至少触发一次。未触发的信号将不会被验证。
这将导致假阴性，即策略将被报告为无偏差。
- `lookahead-analysis` 可以访问相同的回测选项，这可能会引入问题。
请不要使用任何启用仓位堆叠等选项，因为这会扭曲检查的信号数量。
如果你决定这样做，请确保你永远不会用完 `max_open_trades` 槽位，
并且在回测钱包配置中有足够的资金。
- 在结果表中，`biased_indicators` 列
会错误地将 `set_freqai_targets()` 中定义的 FreqAI 目标指标标记为有偏差。
**这些不是偏差，可以安全地忽略。**
