{"version":2,"kind":"Article","sha256":"45a50edc4c2ac8e52f5904ef3ee966d6aff822647bf135a69116b9de0f4f0901","slug":"advanced-hyperopt","location":"/advanced-hyperopt.md","dependencies":[],"frontmatter":{"title":"高级超参数优化","description":"本文档介绍了 FreqTrade 的高级超参数优化功能,包括自定义损失函数等高级特性。","short_title":"高级超参数优化","subtitle":"深入了解超参数优化功能","subject":"FreqTrade 高级超参数优化指南","authors":[{"id":"Freqtrade","name":"Freqtrade"}],"github":"https://github.com/freqtrade-cn/docs_zh-CN","keywords":["Freqtrade","中文文档","交易机器人","量化交易","加密货币","数字货币","区块链","人工智能","机器学习"],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/freqtrade-cn/docs_zh-CN/blob/main/advanced-hyperopt.md","exports":[{"format":"md","filename":"advanced-hyperopt.md","url":"/build/advanced-hyperopt-38e4886c21e6881ebd27b9adab7149b6.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"高级超参数优化（Hyperopt）","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"VvrrcYs4e6"}],"identifier":"id-hyperopt","label":"高级超参数优化（Hyperopt）","html_id":"id-hyperopt","implicit":true,"key":"A1iW5BbYbL"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"本页介绍一些高级 Hyperopt 主题，可能比创建普通超参数优化类需要更高的编码技能和 Python 知识。","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"madXFDNUtG"}],"key":"PXVX2195pt"},{"type":"heading","depth":3,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"创建和使用自定义损失函数","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"mPywRl0F5F"}],"identifier":"id","label":"创建和使用自定义损失函数","html_id":"id","implicit":true,"key":"zEQEAUgzoF"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"要使用自定义损失函数类，请确保你的自定义 hyperopt 损失类中定义了 ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"Q4SgLBXuWW"},{"type":"inlineCode","value":"hyperopt_loss_function","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"rKCJOsPCHU"},{"type":"text","value":" 函数。\n对于下方的示例，你需要在 hyperopt 命令中添加参数 ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"f5Xwu5flQU"},{"type":"inlineCode","value":"--hyperopt-loss SuperDuperHyperOptLoss","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"odNdZqPwq6"},{"type":"text","value":"，以便使用该函数。","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"Wk57z6oSVK"}],"key":"RUO6s1okgq"},{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"下面是一个示例，与默认 Hyperopt 损失实现完全相同。完整示例可见于 ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"siUvHFI9He"},{"type":"link","url":"https://github.com/freqtrade/freqtrade/blob/develop/freqtrade/templates/sample_hyperopt_loss.py","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"userdata/hyperopts","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"IXCArfRbXZ"}],"urlSource":"https://github.com/freqtrade/freqtrade/blob/develop/freqtrade/templates/sample_hyperopt_loss.py","data":{"kind":"file","org":"freqtrade","repo":"freqtrade","reference":"develop","file":"freqtrade/templates/sample_hyperopt_loss.py","raw":"https://raw.githubusercontent.com/freqtrade/freqtrade/develop/freqtrade/templates/sample_hyperopt_loss.py"},"internal":false,"protocol":"github","key":"Au4GC89TWF"},{"type":"text","value":"。","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"KjiKn8KiSb"}],"key":"W9gMsH45QL"},{"type":"code","lang":"python","value":"from datetime import datetime\nfrom typing import Any, Dict\n\nfrom pandas import DataFrame\n\nfrom freqtrade.constants import Config\nfrom freqtrade.optimize.hyperopt import IHyperOptLoss\n\nTARGET_TRADES = 600\nEXPECTED_MAX_PROFIT = 3.0\nMAX_ACCEPTED_TRADE_DURATION = 300\n\nclass SuperDuperHyperOptLoss(IHyperOptLoss):\n    \"\"\"\n    定义 hyperopt 的默认损失函数\n    \"\"\"\n\n    @staticmethod\n    def hyperopt_loss_function(\n        *,\n        results: DataFrame,\n        trade_count: int,\n        min_date: datetime,\n        max_date: datetime,\n        config: Config,\n        processed: dict[str, DataFrame],\n        backtest_stats: dict[str, Any],\n        starting_balance: float,\n        **kwargs,\n    ) -> float:\n        \"\"\"\n        目标函数，结果越小越好\n        这是传统算法（freqtrade 一直使用的）。权重分配如下：\n        * 0.4 给交易时长\n        * 0.25：避免交易亏损\n        * 1.0 给总利润，相对于上面定义的期望值（`EXPECTED_MAX_PROFIT`）\n        \"\"\"\n        total_profit = results['profit_ratio'].sum()\n        trade_duration = results['trade_duration'].mean()\n\n        trade_loss = 1 - 0.25 * exp(-(trade_count - TARGET_TRADES) ** 2 / 10 ** 5.8)\n        profit_loss = max(0, 1 - total_profit / EXPECTED_MAX_PROFIT)\n        duration_loss = 0.4 * min(trade_duration / MAX_ACCEPTED_TRADE_DURATION, 1)\n        result = trade_loss + profit_loss + duration_loss\n        return result","position":{"start":{"line":20,"column":1},"end":{"line":66,"column":1}},"key":"qBDA1BHi2v"},{"type":"paragraph","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"text","value":"目前，参数说明如下：","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"xTEy95qC8A"}],"key":"KuCSWEqMqd"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":70,"column":1},"end":{"line":80,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":70,"column":1},"end":{"line":72,"column":1}},"children":[{"type":"inlineCode","value":"results","position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"key":"JKZq1AGIfw"},{"type":"text","value":"：包含结果交易的 DataFrame。\n结果中可用的列如下（与回测时 ","position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"key":"Gb7hcz1qib"},{"type":"inlineCode","value":"--export trades","position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"key":"GyRVblVEnv"},{"type":"text","value":" 输出文件一致）：","position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"key":"caqVvuixod"},{"type":"break","position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"key":"FyogjSNAvz"},{"type":"inlineCode","value":"pair, profit_ratio, profit_abs, open_date, open_rate, fee_open, close_date, close_rate, fee_close, amount, trade_duration, is_open, exit_reason, stake_amount, min_rate, max_rate, stop_loss_ratio, stop_loss_abs","position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"key":"YzRTRPKmoM"}],"key":"xkfi8hFGob"},{"type":"listItem","spread":true,"position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"children":[{"type":"inlineCode","value":"trade_count","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"nKGsevsRED"},{"type":"text","value":"：交易数量（等同于 ","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"xU3Rpp2ltk"},{"type":"inlineCode","value":"len(results)","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"OJlhxRrpB9"},{"type":"text","value":"）","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"Zqpf7kzSAU"}],"key":"CnsIYeSDOC"},{"type":"listItem","spread":true,"position":{"start":{"line":74,"column":1},"end":{"line":74,"column":1}},"children":[{"type":"inlineCode","value":"min_date","position":{"start":{"line":74,"column":1},"end":{"line":74,"column":1}},"key":"E9NeDEE8UM"},{"type":"text","value":"：使用的时间范围起始日期","position":{"start":{"line":74,"column":1},"end":{"line":74,"column":1}},"key":"F6Pk1LFFNX"}],"key":"DXiCJMyugf"},{"type":"listItem","spread":true,"position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"children":[{"type":"inlineCode","value":"max_date","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"EdWkjd5iRM"},{"type":"text","value":"：使用的时间范围结束日期","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"cc7svivHtO"}],"key":"nKHMwOQGn0"},{"type":"listItem","spread":true,"position":{"start":{"line":76,"column":1},"end":{"line":76,"column":1}},"children":[{"type":"inlineCode","value":"config","position":{"start":{"line":76,"column":1},"end":{"line":76,"column":1}},"key":"dgIeExLS7K"},{"type":"text","value":"：使用的配置对象（注意：如果某些策略相关参数属于 hyperopt 空间，这里未必会更新全部参数）。","position":{"start":{"line":76,"column":1},"end":{"line":76,"column":1}},"key":"GrcDoI3cDj"}],"key":"erpxMRq6Me"},{"type":"listItem","spread":true,"position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"inlineCode","value":"processed","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"HuTVmjIJcu"},{"type":"text","value":"：以交易对为键的 DataFrame 字典，包含回测用到的数据。","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"FGc0qsNCJZ"}],"key":"fULWYsn1lQ"},{"type":"listItem","spread":true,"position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"children":[{"type":"inlineCode","value":"backtest_stats","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"UwPkNYBzsv"},{"type":"text","value":"：回测统计信息，格式与回测文件“strategy”子结构一致。可用字段见 ","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"j8y0XIUlso"},{"type":"inlineCode","value":"optimize_reports.py","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"rzsn19mccu"},{"type":"text","value":" 中的 ","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"XfZq855rH8"},{"type":"inlineCode","value":"generate_strategy_stats()","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"oBU3ZOPCFL"},{"type":"text","value":"。","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"O7WK5HInHL"}],"key":"tAUnGGquMZ"},{"type":"listItem","spread":true,"position":{"start":{"line":79,"column":1},"end":{"line":80,"column":1}},"children":[{"type":"inlineCode","value":"starting_balance","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"UJVAiyRhcm"},{"type":"text","value":"：回测使用的初始资金。","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"rr6CvVvi6b"}],"key":"EQ3bELYp6z"}],"key":"LyQizZcSCz"},{"type":"paragraph","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"text","value":"该函数需返回一个浮点数（","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"a8KHmY9fPb"},{"type":"inlineCode","value":"float","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"gF1IlDsre9"},{"type":"text","value":"）。数值越小，结果越好。参数和权重分配可自行调整。","position":{"start":{"line":81,"column":1},"end":{"line":81,"column":1}},"key":"W9XCj41DVq"}],"key":"sWKzV8kCP4"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"JWDixjcCj2"}],"key":"fn18TrC7XT"},{"type":"paragraph","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"children":[{"type":"text","value":"该函数每个 epoch 调用一次——请尽量优化代码，避免拖慢 hyperopt。","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"key":"sT8DYQfNHY"}],"key":"apiYgQuG5U"}],"key":"uAmmjZmyfE"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"inlineCode","value":"*args","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"x9LaV0wqjH"},{"type":"text","value":" 和 ","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"Mwc62avhNK"},{"type":"inlineCode","value":"**kwargs","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"iKxcCD7AHX"}],"key":"Gjc7RMTaDg"},{"type":"paragraph","position":{"start":{"line":88,"column":1},"end":{"line":88,"column":1}},"children":[{"type":"text","value":"请保留接口中的 ","position":{"start":{"line":88,"column":1},"end":{"line":88,"column":1}},"key":"QZEc8jYGBa"},{"type":"inlineCode","value":"*args","position":{"start":{"line":88,"column":1},"end":{"line":88,"column":1}},"key":"XIEU4MLONE"},{"type":"text","value":" 和 ","position":{"start":{"line":88,"column":1},"end":{"line":88,"column":1}},"key":"ZFq7IG0LcF"},{"type":"inlineCode","value":"**kwargs","position":{"start":{"line":88,"column":1},"end":{"line":88,"column":1}},"key":"PgAP8GQbWg"},{"type":"text","value":"，以便未来扩展。","position":{"start":{"line":88,"column":1},"end":{"line":88,"column":1}},"key":"ULKeBCt7St"}],"key":"Nmw67vFR41"}],"key":"hLjWc77Vk8"},{"type":"heading","depth":3,"position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"children":[{"type":"text","value":"覆盖预定义空间","position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"key":"TZwfrlqnU0"}],"label":"overriding-pre-defined-spaces","identifier":"overriding-pre-defined-spaces","html_id":"overriding-pre-defined-spaces","key":"Z1KQSBjOHT"},{"type":"paragraph","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"children":[{"type":"text","value":"要覆盖预定义空间（如 ","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"y8bfX1sfjQ"},{"type":"inlineCode","value":"roi_space","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"Sx48odt0wq"},{"type":"text","value":"、","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"sXefNAEJjz"},{"type":"inlineCode","value":"generate_roi_table","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"ci1N2Eq2hl"},{"type":"text","value":"、","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"PE5wWfF1Qo"},{"type":"inlineCode","value":"stoploss_space","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"exYrZmPdUC"},{"type":"text","value":"、","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"Vef7hHYQOv"},{"type":"inlineCode","value":"trailing_space","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"EtXNt0OL13"},{"type":"text","value":"、","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"HqSvUUOTun"},{"type":"inlineCode","value":"max_open_trades_space","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"xFMqsCoO4I"},{"type":"text","value":"），请在策略中定义一个嵌套的 Hyperopt 类，并如下定义所需空间：","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"XCHpvgErGS"}],"key":"v3gDjQq2II"},{"type":"code","lang":"python","value":"from freqtrade.optimize.space import Categorical, Dimension, Integer, SKDecimal\n\nclass MyAwesomeStrategy(IStrategy):\n    class HyperOpt:\n        # 自定义止损空间\n        def stoploss_space():\n            return [SKDecimal(-0.05, -0.01, decimals=3, name='stoploss')]\n\n        # 自定义 ROI 空间\n        def roi_space() -> List[Dimension]:\n            return [\n                Integer(10, 120, name='roi_t1'),\n                Integer(10, 60, name='roi_t2'),\n                Integer(10, 40, name='roi_t3'),\n                SKDecimal(0.01, 0.04, decimals=3, name='roi_p1'),\n                SKDecimal(0.01, 0.07, decimals=3, name='roi_p2'),\n                SKDecimal(0.01, 0.20, decimals=3, name='roi_p3'),\n            ]\n\n        def generate_roi_table(params: Dict) -> dict[int, float]:\n\n            roi_table = {}\n            roi_table[0] = params['roi_p1'] + params['roi_p2'] + params['roi_p3']\n            roi_table[params['roi_t3']] = params['roi_p1'] + params['roi_p2']\n            roi_table[params['roi_t3'] + params['roi_t2']] = params['roi_p1']\n            roi_table[params['roi_t3'] + params['roi_t2'] + params['roi_t1']] = 0\n\n            return roi_table\n\n        def trailing_space() -> List[Dimension]:\n            # 这里所有参数都是必需的，只能修改类型或范围。\n            return [\n                # 固定为 true，如果优化 trailing_stop，则假定始终使用追踪止损。\n                Categorical([True], name='trailing_stop'),\n\n                SKDecimal(0.01, 0.35, decimals=3, name='trailing_stop_positive'),\n                # 'trailing_stop_positive_offset' 应大于 'trailing_stop_positive'，\n                # 所以这里用中间参数表示两者的差值。'trailing_stop_positive_offset' 的值在\n                # generate_trailing_params() 方法中构造。\n                # 这类似于用于构造 ROI 表的 hyperspace 维度。\n                SKDecimal(0.001, 0.1, decimals=3, name='trailing_stop_positive_offset_p1'),\n\n                Categorical([True, False], name='trailing_only_offset_is_reached'),\n        ]\n\n        # 自定义最大持仓数空间\n        def max_open_trades_space(self) -> List[Dimension]:\n            return [\n                Integer(-1, 10, name='max_open_trades'),\n            ]","position":{"start":{"line":97,"column":1},"end":{"line":148,"column":1}},"key":"ctGGlbvEVH"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"sZVL4Haawy"}],"key":"xBrmX03Ov1"},{"type":"paragraph","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"children":[{"type":"text","value":"所有覆盖都是可选的，可根据需要混合使用。","position":{"start":{"line":151,"column":1},"end":{"line":151,"column":1}},"key":"vPajJz4ffC"}],"key":"mrVnHhEann"}],"key":"ashGbgn4rv"},{"type":"heading","depth":4,"position":{"start":{"line":154,"column":1},"end":{"line":154,"column":1}},"children":[{"type":"text","value":"动态参数","position":{"start":{"line":154,"column":1},"end":{"line":154,"column":1}},"key":"O06RMHw8gJ"}],"identifier":"id","label":"动态参数","html_id":"id-1","implicit":true,"key":"a7QbBHg8jF"},{"type":"paragraph","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"children":[{"type":"text","value":"参数也可以动态定义，但在 ","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"nM97Mnwzsw"},{"type":"crossReference","url":"/strategy-callbacks","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"children":[{"type":"inlineCode","value":"bot_start()","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"CSEIi32EZN"},{"type":"text","value":" 回调","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"DfPAxJU9aK"}],"urlSource":"strategy-callbacks.md#bot-start","dataUrl":"/strategy-callbacks.json","identifier":"bot-start","label":"bot-start","remote":true,"protocol":"file","kind":"heading","template":"{name}","resolved":true,"html_id":"bot-start","key":"XMFQJLtGFj"},{"type":"text","value":" 被调用后，实例必须能访问到这些参数。","position":{"start":{"line":156,"column":1},"end":{"line":156,"column":1}},"key":"PK3B3IpdFD"}],"key":"Xx3sjKPcRY"},{"type":"code","lang":"python","value":"\nclass MyAwesomeStrategy(IStrategy):\n\n    def bot_start(self, **kwargs) -> None:\n        self.buy_adx = IntParameter(20, 30, default=30, optimize=True)\n\n    # ...","position":{"start":{"line":158,"column":1},"end":{"line":166,"column":1}},"key":"KMIz6caQv6"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"l7qFExUOoR"}],"key":"CGE4VvGClD"},{"type":"paragraph","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"children":[{"type":"text","value":"以这种方式创建的参数不会出现在 ","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"nMnC0PXgHM"},{"type":"inlineCode","value":"list-strategies","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"LjPgv0iPA2"},{"type":"text","value":" 的参数计数中。","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"ezNapgPO2w"}],"key":"K8rUV0uWXj"}],"key":"Cilty3fIoy"},{"type":"heading","depth":4,"position":{"start":{"line":172,"column":1},"end":{"line":172,"column":1}},"children":[{"type":"text","value":"覆盖 Base estimator","position":{"start":{"line":172,"column":1},"end":{"line":172,"column":1}},"key":"wHfIOQ7zJT"}],"identifier":"id-base-estimator","label":"覆盖 Base estimator","html_id":"id-base-estimator","implicit":true,"key":"QMxYc36fNV"},{"type":"paragraph","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"children":[{"type":"text","value":"你可以通过在 Hyperopt 子类中实现 ","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"key":"me8o7BGDCm"},{"type":"inlineCode","value":"generate_estimator()","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"key":"eESt02rUll"},{"type":"text","value":"，为 Hyperopt 定义自己的 optuna 采样器。","position":{"start":{"line":174,"column":1},"end":{"line":174,"column":1}},"key":"eNbJgLnA2f"}],"key":"z5248cYwSL"},{"type":"code","lang":"python","value":"class MyAwesomeStrategy(IStrategy):\n    class HyperOpt:\n        def generate_estimator(dimensions: List['Dimension'], **kwargs):\n            return \"NSGAIIISampler\"\n","position":{"start":{"line":176,"column":1},"end":{"line":182,"column":1}},"key":"MjTTrTcDFY"},{"type":"paragraph","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"children":[{"type":"text","value":"可用值包括 “NSGAIISampler”、“TPESampler”、“GPSampler”、“CmaEsSampler”、“NSGAIIISampler”、“QMCSampler”（详情见 ","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"F9M3jjxkk5"},{"type":"link","url":"https://optuna.readthedocs.io/en/stable/reference/samplers/index.html","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"children":[{"type":"text","value":"optuna-samplers 文档","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"figvR7WM4c"}],"urlSource":"https://optuna.readthedocs.io/en/stable/reference/samplers/index.html","key":"Kfhey2X044"},{"type":"text","value":"），也可以是继承自 ","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"X9C3XRiLPl"},{"type":"inlineCode","value":"optuna.samplers.BaseSampler","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"j0sAj4jCQY"},{"type":"text","value":" 的类实例。","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"I1T43MTlr8"}],"key":"Z6ThckWGVH"},{"type":"paragraph","position":{"start":{"line":186,"column":1},"end":{"line":186,"column":1}},"children":[{"type":"text","value":"有时需要自行研究以发现更多采样器（如 optunahub 提供的）。","position":{"start":{"line":186,"column":1},"end":{"line":186,"column":1}},"key":"mG7rLTjXNh"}],"key":"dVmHt6PnU3"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"OZ1M1dImFP"}],"key":"keMxx6ZPJc"},{"type":"paragraph","position":{"start":{"line":189,"column":1},"end":{"line":190,"column":1}},"children":[{"type":"text","value":"虽然可以自定义 estimator，但需要你自己研究参数并分析/理解应使用哪些参数。\n如果不确定，建议直接使用默认值（","position":{"start":{"line":189,"column":1},"end":{"line":189,"column":1}},"key":"MIf5aaJkw3"},{"type":"inlineCode","value":"\"NSGAIIISampler\"","position":{"start":{"line":189,"column":1},"end":{"line":189,"column":1}},"key":"kesyyaUQia"},{"type":"text","value":" 被证明最为通用）。","position":{"start":{"line":189,"column":1},"end":{"line":189,"column":1}},"key":"sRq8MBIB9I"}],"key":"flIEJa4gcD"}],"key":"hUHqGjye8j"},{"type":"admonition","kind":"hint","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"使用 Optunahub 的 ","position":{"start":{"line":193,"column":1},"end":{"line":193,"column":1}},"key":"dgGZ34mR51"},{"type":"inlineCode","value":"AutoSampler","position":{"start":{"line":193,"column":1},"end":{"line":193,"column":1}},"key":"T9sSpNUndO"}],"key":"I6iCkPqAOI"},{"type":"paragraph","position":{"start":{"line":195,"column":1},"end":{"line":195,"column":1}},"children":[{"type":"link","url":"https://hub.optuna.org/samplers/auto_sampler/","position":{"start":{"line":195,"column":1},"end":{"line":195,"column":1}},"children":[{"type":"text","value":"AutoSampler 文档","position":{"start":{"line":195,"column":1},"end":{"line":195,"column":1}},"key":"B7y3SdAZI2"}],"urlSource":"https://hub.optuna.org/samplers/auto_sampler/","key":"oHUpTzbbZ3"}],"key":"gV9kJyCBBV"},{"type":"paragraph","position":{"start":{"line":197,"column":1},"end":{"line":197,"column":1}},"children":[{"type":"text","value":"安装必要依赖","position":{"start":{"line":197,"column":1},"end":{"line":197,"column":1}},"key":"K6oYbfjtGw"}],"key":"MN31XHeQ8Q"},{"type":"code","lang":"bash","value":"pip install optunahub cmaes torch scipy","position":{"start":{"line":198,"column":1},"end":{"line":200,"column":1}},"key":"vuLsuaVBsv"},{"type":"paragraph","position":{"start":{"line":201,"column":1},"end":{"line":201,"column":1}},"children":[{"type":"text","value":"在策略中实现 ","position":{"start":{"line":201,"column":1},"end":{"line":201,"column":1}},"key":"TliC5D44D2"},{"type":"inlineCode","value":"generate_estimator()","position":{"start":{"line":201,"column":1},"end":{"line":201,"column":1}},"key":"iMft8pUkFr"}],"key":"wQltY0VkaD"},{"type":"code","lang":"python","value":"# ...\nfrom freqtrade.strategy.interface import IStrategy\nfrom typing import List\nimport optunahub\n# ... \n\nclass my_strategy(IStrategy):\n    class HyperOpt:\n        def generate_estimator(dimensions: List[\"Dimension\"], **kwargs):\n            if \"random_state\" in kwargs.keys():\n                return optunahub.load_module(\"samplers/auto_sampler\").AutoSampler(seed=kwargs[\"random_state\"])\n            else:\n                return optunahub.load_module(\"samplers/auto_sampler\").AutoSampler()\n","position":{"start":{"line":203,"column":1},"end":{"line":218,"column":1}},"key":"rRYwRhNGt9"},{"type":"paragraph","position":{"start":{"line":220,"column":1},"end":{"line":220,"column":1}},"children":[{"type":"text","value":"显然，optuna 支持的其他采样器也可用同样方式集成。","position":{"start":{"line":220,"column":1},"end":{"line":220,"column":1}},"key":"mh1B1hpuEl"}],"key":"wvV0WFbFBd"}],"key":"B7yhBMxXN9"},{"type":"heading","depth":3,"position":{"start":{"line":223,"column":1},"end":{"line":223,"column":1}},"children":[{"type":"text","value":"空间类型选项","position":{"start":{"line":223,"column":1},"end":{"line":223,"column":1}},"key":"j7F2l4Yh5m"}],"identifier":"id","label":"空间类型选项","html_id":"id-2","implicit":true,"key":"kIS8udCffr"},{"type":"paragraph","position":{"start":{"line":225,"column":1},"end":{"line":225,"column":1}},"children":[{"type":"text","value":"对于附加空间，scikit-optimize（结合 Freqtrade）提供以下空间类型：","position":{"start":{"line":225,"column":1},"end":{"line":225,"column":1}},"key":"hc7w5Xv7ff"}],"key":"pnDvFkhDJa"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":227,"column":1},"end":{"line":231,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":227,"column":1},"end":{"line":227,"column":1}},"children":[{"type":"inlineCode","value":"Categorical","position":{"start":{"line":227,"column":1},"end":{"line":227,"column":1}},"key":"MdvlEqBBf7"},{"type":"text","value":" - 从类别列表中选择（如 ","position":{"start":{"line":227,"column":1},"end":{"line":227,"column":1}},"key":"Lf2tBOMsNV"},{"type":"inlineCode","value":"Categorical(['a', 'b', 'c'], name=\"cat\")","position":{"start":{"line":227,"column":1},"end":{"line":227,"column":1}},"key":"LQlIh5nu6i"},{"type":"text","value":"）","position":{"start":{"line":227,"column":1},"end":{"line":227,"column":1}},"key":"YHEc3Mbrwg"}],"key":"P4A9aA5CQv"},{"type":"listItem","spread":true,"position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"children":[{"type":"inlineCode","value":"Integer","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"key":"aqNxxbvV6v"},{"type":"text","value":" - 从整数范围中选择（如 ","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"key":"KQvURyyHFt"},{"type":"inlineCode","value":"Integer(1, 10, name='rsi')","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"key":"THXoI3d0sb"},{"type":"text","value":"）","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"key":"O7lE2ugYFN"}],"key":"Ofzy2uKYhC"},{"type":"listItem","spread":true,"position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"children":[{"type":"inlineCode","value":"SKDecimal","position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"key":"jjUWXjlwtj"},{"type":"text","value":" - 从有限精度的小数范围中选择（如 ","position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"key":"bVkIjflvnU"},{"type":"inlineCode","value":"SKDecimal(0.1, 0.5, decimals=3, name='adx')","position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"key":"S0VLybtTE2"},{"type":"text","value":"）。","position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"key":"JgqTv8ZAS3"},{"type":"emphasis","position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"children":[{"type":"text","value":"仅 Freqtrade 提供。","position":{"start":{"line":229,"column":1},"end":{"line":229,"column":1}},"key":"koNCvA3XZO"}],"key":"JC1l8R0XrU"}],"key":"EObBxrH40l"},{"type":"listItem","spread":true,"position":{"start":{"line":230,"column":1},"end":{"line":231,"column":1}},"children":[{"type":"inlineCode","value":"Real","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"key":"Rp0aJbUfeQ"},{"type":"text","value":" - 从全精度小数范围中选择（如 ","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"key":"Nj6ndwKtdl"},{"type":"inlineCode","value":"Real(0.1, 0.5, name='adx')","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"key":"k25CZUAc1C"},{"type":"text","value":"）","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"key":"hdzGJbfhUI"}],"key":"lVkly3kQpP"}],"key":"QBdAfHUTIe"},{"type":"paragraph","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"children":[{"type":"text","value":"你可以从 ","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"TfLH3JMMob"},{"type":"inlineCode","value":"freqtrade.optimize.space","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"IxDomFHdyL"},{"type":"text","value":" 导入所有这些类型，尽管 ","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"qExpLG8upq"},{"type":"inlineCode","value":"Categorical","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"KoXplbcPKk"},{"type":"text","value":"、","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"xJnYKuXLuT"},{"type":"inlineCode","value":"Integer","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"lT9h9j3g7j"},{"type":"text","value":" 和 ","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"caf08iuZ51"},{"type":"inlineCode","value":"Real","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"dn4y6hZJNq"},{"type":"text","value":" 只是 scikit-optimize 空间的别名。","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"GDDrwAs6yT"},{"type":"inlineCode","value":"SKDecimal","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"GxRpth7yl9"},{"type":"text","value":" 由 freqtrade 提供，用于更快的优化。","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"NH4YcwlqBa"}],"key":"tvrZCSHXJz"},{"type":"code","lang":"python","value":"from freqtrade.optimize.space import Categorical, Dimension, Integer, SKDecimal, Real  # noqa","position":{"start":{"line":234,"column":1},"end":{"line":236,"column":1}},"key":"UOA2hfuLIS"},{"type":"admonition","kind":"hint","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"SKDecimal vs. Real","position":{"start":{"line":238,"column":1},"end":{"line":238,"column":1}},"key":"X7KyBMyLd3"}],"key":"CBOJWfnIkX"},{"type":"paragraph","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"children":[{"type":"text","value":"我们建议几乎所有场景都使用 ","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"w5gld6Av9X"},{"type":"inlineCode","value":"SKDecimal","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"bfe7d8R6qn"},{"type":"text","value":"，而不是 ","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"knjBplsLLW"},{"type":"inlineCode","value":"Real","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"H5GRyFqeNM"},{"type":"text","value":" 空间。虽然 Real 空间提供全精度（高达约 16 位小数），但这种精度很少需要，且会导致 hyperopt 时间过长。","position":{"start":{"line":239,"column":1},"end":{"line":239,"column":1}},"key":"xRFCC8PqQI"}],"key":"wbrLiEDH3J"},{"type":"paragraph","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"children":[{"type":"text","value":"假设定义了一个较小的空间（","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"key":"sZJEZMvHng"},{"type":"inlineCode","value":"SKDecimal(0.10, 0.15, decimals=2, name='xxx')","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"key":"VerqIxkiTE"},{"type":"text","value":"）——SKDecimal 只有 5 种可能（","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"key":"YXpFDA2fzO"},{"type":"inlineCode","value":"[0.10, 0.11, 0.12, 0.13, 0.14, 0.15]","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"key":"fKhoUQi40W"},{"type":"text","value":"）。","position":{"start":{"line":241,"column":1},"end":{"line":241,"column":1}},"key":"mAad8vqbvn"}],"key":"m9MBy4SDxm"},{"type":"paragraph","position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"children":[{"type":"text","value":"相应的 real 空间 ","position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"key":"uLOTE2klp6"},{"type":"inlineCode","value":"Real(0.10, 0.15 name='xxx')","position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"key":"hlDN7WwzQb"},{"type":"text","value":" 则有几乎无限多的可能（","position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"key":"AfXIqKJ6kM"},{"type":"inlineCode","value":"[0.10, 0.010000000001, 0.010000000002, ... 0.014999999999, 0.01500000000]","position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"key":"mmV9pkddCW"},{"type":"text","value":"）。","position":{"start":{"line":243,"column":1},"end":{"line":243,"column":1}},"key":"q6O5B3648G"}],"key":"QPLnpEUnaN"}],"key":"HXBP5Ezz56"}],"key":"jI7hwZRUXs"}],"key":"ycaRY2fdJF"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Freqtrade 高级策略指南","short_title":"高级策略","url":"/strategy-advanced","group":"高级话题"},"next":{"title":"高级委托流分析","short_title":"委托流分析","url":"/advanced-orderflow","group":"高级话题"}}},"domain":"http://localhost:3002"}