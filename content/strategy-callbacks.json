{"version":2,"kind":"Article","sha256":"9a14779aaf418463b87be0c9c2a5415ccbea6a275ef6d8fc749cf8f1a89e2fe3","slug":"strategy-callbacks","location":"/strategy-callbacks.md","dependencies":[],"frontmatter":{"title":"策略回调指南","description":"本文档详细介绍了 Freqtrade 交易机器人中可用的各种策略回调函数,包括它们的用途、调用时机以及使用方法。","short_title":"策略回调","subtitle":"策略回调函数的完整概述","subject":"Freqtrade 策略回调文档","authors":[{"id":"Freqtrade","name":"Freqtrade"}],"github":"https://github.com/freqtrade-cn/docs_zh-CN","keywords":["Freqtrade","中文文档","交易机器人","量化交易","加密货币","数字货币","区块链","人工智能","机器学习"],"edit_url":"https://github.com/freqtrade-cn/docs_zh-CN/blob/main/strategy-callbacks.md","thumbnail":"/freqUI-chart-annotat-6ca425e986932e863842497203176546.png","thumbnailOptimized":"/freqUI-chart-annotat-6ca425e986932e863842497203176546.webp","exports":[{"format":"md","filename":"strategy-callbacks.md","url":"/strategy-callbacks-f1a21e2c9bbce659468855fbc25863ce.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"策略回调","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"N1vFnnefWl"}],"identifier":"id","label":"策略回调","html_id":"id","implicit":true,"key":"QPYlqtFbBa"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"虽然主要的策略函数（","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"CLm5cTZ8EJ"},{"type":"inlineCode","value":"populate_indicators()","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"c1eYMK4IkC"},{"type":"text","value":", ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"qAQxVhy2E8"},{"type":"inlineCode","value":"populate_entry_trend()","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"mWGYgCrwol"},{"type":"text","value":", ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"jNfIqaOnfn"},{"type":"inlineCode","value":"populate_exit_trend()","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ISYvSEA5Ol"},{"type":"text","value":") ）应以向量化方式使用，并且只会在","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ZlI55Ws2pI"},{"type":"crossReference","url":"/bot-basics","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"回测时调用一次","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"zt3m4WJqXa"}],"urlSource":"bot-basics.md#backtesting-hyperopt-execution-logic","dataUrl":"/bot-basics.json","identifier":"backtesting-hyperopt-execution-logic","label":"backtesting-hyperopt-execution-logic","remote":true,"protocol":"file","kind":"heading","template":"{name}","resolved":true,"html_id":"backtesting-hyperopt-execution-logic","key":"wPP9skn8qa"},{"type":"text","value":"，但回调函数会在\"需要时\"被调用。","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"izIDoAROMW"}],"key":"e7numMIUVt"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"因此，你应避免在回调中进行繁重的计算，以免在操作过程中造成延迟。","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"OJUZBA8mhb"}],"key":"a4YiurKtnl"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"根据所用回调的不同，它们可能在进入/退出交易时调用，或在交易期间多次调用。\n当前可用的回调有：","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"Iqzg6VTNF2"}],"key":"amEKYXYrM0"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":18,"column":1},"end":{"line":31,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"机器人启动 ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"np4d06NUqJ"},{"type":"inlineCode","value":"bot_start()","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"cjHbEDyLXN"}],"identifier":"bot-start","label":"bot-start","kind":"heading","template":"{name}","resolved":true,"html_id":"bot-start","key":"tK4XR663Tw"}],"key":"NeptOnZWch"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"机器人循环开始 ","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"DdCjZbMyOt"},{"type":"inlineCode","value":"bot_loop_start()","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"sAAnBpNNld"}],"identifier":"bot-loop-start","label":"bot-loop-start","kind":"heading","template":"{name}","resolved":true,"html_id":"bot-loop-start","key":"OCy3vFzrsm"}],"key":"OLHqinRsTJ"},{"type":"listItem","spread":true,"position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"仓位大小管理 ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"AVez1PbjLu"},{"type":"inlineCode","value":"custom_stake_amount()","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"hbM4UZDcll"}],"identifier":"stake-size-management","label":"stake-size-management","kind":"heading","template":"{name}","resolved":true,"html_id":"stake-size-management","key":"pJhOfXMCtc"}],"key":"dJbLlZzyZj"},{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"自定义退出信号 ","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"qLK6W7Ua2E"},{"type":"inlineCode","value":"custom_exit()","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"iZkfElxL6c"}],"identifier":"custom-exit-signal","label":"custom-exit-signal","kind":"heading","template":"{name}","resolved":true,"html_id":"custom-exit-signal","key":"Vl2cJrqvmL"}],"key":"LGnJWcjwuW"},{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"自定义止损 ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"KKrh1KiHIm"},{"type":"inlineCode","value":"custom_stoploss()","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"nNXOhDSZTz"}],"identifier":"custom-stoploss","label":"custom-stoploss","kind":"heading","template":"{name}","resolved":true,"html_id":"custom-stoploss","key":"cQzsNLA8r0"}],"key":"Puqv3iueGl"},{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"link","url":"#custom-order-price-rules","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"inlineCode","value":"custom_entry_price()","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"l2fs045seX"},{"type":"text","value":" 和 ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"BJzdpLrjH6"},{"type":"inlineCode","value":"custom_exit_price()","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"kWFjybWHET"}],"urlSource":"#custom-order-price-rules","key":"sQkiv0iXv3"}],"key":"ImCiJu6mek"},{"type":"listItem","spread":true,"position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"link","url":"#custom-order-timeout-rules","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"inlineCode","value":"check_entry_timeout()","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"QyTZLdFl1h"},{"type":"text","value":" 和 ","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"Lqk7eWwIYR"},{"type":"inlineCode","value":"check_exit_timeout()","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"mxRi3dOQIi"}],"urlSource":"#custom-order-timeout-rules","key":"ResQN0o8aB"}],"key":"SgjJEShXya"},{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"link","url":"#trade-entry-buy-order-confirmation","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"inlineCode","value":"confirm_trade_entry()","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"SF4d0nBdEK"}],"urlSource":"#trade-entry-buy-order-confirmation","key":"yXz2u6gV6M"}],"key":"XAbkh9Zd65"},{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"link","url":"#trade-exit-sell-order-confirmation","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"inlineCode","value":"confirm_trade_exit()","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"VhxkfEyzfM"}],"urlSource":"#trade-exit-sell-order-confirmation","key":"ugHSZKlO6U"}],"key":"riA1ur6KKJ"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"inlineCode","value":"adjust_trade_position()","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"palKWeTjdS"}],"identifier":"adjust-trade-position","label":"adjust-trade-position","kind":"heading","template":"{name}","resolved":true,"html_id":"adjust-trade-position","key":"nyZuq4qtXD"}],"key":"o7x5gGvlSE"},{"type":"listItem","spread":true,"position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"link","url":"#adjust-entry-price","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"inlineCode","value":"adjust_entry_price()","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"mx40o3E2kw"}],"urlSource":"#adjust-entry-price","key":"OHSnPE5X1s"}],"key":"yMnPuIFkPb"},{"type":"listItem","spread":true,"position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"link","url":"#leverage-callback","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"inlineCode","value":"leverage()","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"EIgqYPFgK4"}],"urlSource":"#leverage-callback","key":"w7uAEZvZjP"}],"key":"OC7TrlONI4"},{"type":"listItem","spread":true,"position":{"start":{"line":30,"column":1},"end":{"line":31,"column":1}},"children":[{"type":"link","url":"#order-filled-callback","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"inlineCode","value":"order_filled()","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"lwnk3m6gwn"}],"urlSource":"#order-filled-callback","key":"EReFqrJHsC"}],"key":"h3B8wAh7oZ"}],"key":"umBFoRxNj2"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"回调调用顺序","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"jdcGtCF1cV"}],"key":"bzLcAs88up"},{"type":"paragraph","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"你可以在 ","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"yL1uBGXcgC"},{"type":"crossReference","url":"/bot-basics","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"bot-basics","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"Yfi5EG3IIx"}],"urlSource":"bot-basics.md#bot-execution-logic","dataUrl":"/bot-basics.json","identifier":"bot-execution-logic","label":"bot-execution-logic","remote":true,"protocol":"file","kind":"heading","template":"{name}","resolved":true,"html_id":"bot-execution-logic","key":"fdsyA1bV4x"},{"type":"text","value":" 中找到回调的调用顺序","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"OTT1HMV0BH"}],"key":"DhEAxecaCy"}],"key":"B0SnM3aytj"},{"type":"include","file":"includes/strategy-imports.md","literal":false,"lang":"markdown","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"策略所需的导入","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TEhuzDyIT1"}],"identifier":"id","label":"策略所需的导入","html_id":"id-1","implicit":true,"key":"B8yNgiDDyg"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"在创建策略时，你需要导入必要的模块和类。以下是一个策略所需的导入：","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ksos1lmQ24"}],"key":"vqxwnMk398"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"默认情况下，我们建议使用以下导入作为策略的基础：\n这将涵盖 freqtrade 功能所需的所有导入。\n当然，你可以根据需要添加更多导入。","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"tvEF1rIuXh"}],"key":"J4s4DUeGjW"},{"type":"code","lang":"python","value":"# flake8: noqa: F401\n# isort: skip_file\n# --- Do not remove these imports ---\nimport numpy as np\nimport pandas as pd\nfrom datetime import datetime, timedelta, timezone\nfrom pandas import DataFrame\nfrom typing import Dict, Optional, Union, Tuple\n\nfrom freqtrade.strategy import (\n    IStrategy,\n    Trade, \n    Order,\n    PairLocks,\n    informative,  # @informative decorator\n    # Hyperopt Parameters\n    BooleanParameter,\n    CategoricalParameter,\n    DecimalParameter,\n    IntParameter,\n    RealParameter,\n    # timeframe helpers\n    timeframe_to_minutes,\n    timeframe_to_next_date,\n    timeframe_to_prev_date,\n    # Strategy helper functions\n    merge_informative_pair,\n    stoploss_from_absolute,\n    stoploss_from_open,\n)\n\n# --------------------------------\n# Add your lib to import here\nimport talib.abstract as ta\nfrom technical import qtpylib","position":{"start":{"line":9,"column":1},"end":{"line":45,"column":1}},"key":"bdveIQVGV8"}],"key":"lTqFqCOBqQ"},{"type":"include","file":"includes/strategy-exit-comparisons.md","literal":false,"lang":"markdown","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"退出逻辑比较","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RIWpVtkIoF"}],"identifier":"id","label":"退出逻辑比较","html_id":"id-2","implicit":true,"key":"sNWJLuGAYU"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Freqtrade 允许你的策略使用基于信号或基于回调的函数来实现不同的退出逻辑。\n本节旨在比较每个不同的函数，帮助你选择最适合你需求的方案。","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"E2PLTqvWPz"}],"key":"boe0k9SRlP"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"inlineCode","value":"populate_exit_trend()","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"UrPM8OWE3P"}],"key":"kvSoVLxpHs"},{"type":"text","value":" - 使用主数据框架中的指标进行向量化的基于信号的退出逻辑","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"HtolRwAF4t"}],"key":"qHPN7rdQe2"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"✅ ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"YY4dqDQNh5"},{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"使用场景","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Ci4vl7Wyz0"}],"key":"iohICYeHD5"},{"type":"text","value":"：基于指标或其他可以向量化计算的数据定义退出信号。","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"tobRY2txmp"}],"key":"ESHtV4WWXY"}],"key":"XbpK8f0j2m"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"🚫 ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"eT0C7hwEae"},{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"不适用场景","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"wFwHMpwQuj"}],"key":"xcnwPRctMn"},{"type":"text","value":"：为每个单独的交易自定义退出条件，或需要交易数据来做出退出决定时。","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"DRh8iFzr3a"}],"key":"eSgrQbAyEm"}],"key":"l4IBBBN1bc"}],"key":"BpEtIWUA1v"}],"key":"f3YvT6wyXE"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"strong","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"inlineCode","value":"custom_exit()","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ltmRWJUBtB"}],"key":"n2mu9qcunq"},{"type":"text","value":" - 自定义退出逻辑，将立即完全退出交易，在每次机器人循环迭代时对每个开放交易调用，直到交易关闭。","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"wkBIF996nK"}],"key":"oFX1Lh9INv"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":12,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"✅ ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"GOnvTdGzh1"},{"type":"strong","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"使用场景","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"EiiySBN1vR"}],"key":"W1c6RqSYyF"},{"type":"text","value":"：为每个单独的交易指定退出条件（包括使用 ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"UAH66mwe39"},{"type":"inlineCode","value":"adjust_trade_position()","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"M9UJE41bZM"},{"type":"text","value":" 的任何额外调整订单），或需要交易数据来做出退出决定时，例如使用利润数据来退出。","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"vPHM6m3byF"}],"key":"u4bFjUZQJY"}],"key":"NQ1sdNM6rI"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"🚫 ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"Ti3Ov0Rpgl"},{"type":"strong","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"不适用场景","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"rKE6LxQnEp"}],"key":"ZmR3FiEq4R"},{"type":"text","value":"：当你想使用向量化的基于指标的数据退出时（改用 ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"BhSQ9u6XnZ"},{"type":"inlineCode","value":"populate_exit_trend()","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"pSs9n5rg4Q"},{"type":"text","value":" 信号），或作为 ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"zLTzEQBft9"},{"type":"inlineCode","value":"custom_stoploss()","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"TcoznOvsnS"},{"type":"text","value":" 的替代，并且要注意回测中基于速率的退出可能不准确。","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"VtLo8TIUk2"}],"key":"ZhQtTiZOQn"}],"key":"pg42Sr6ncf"}],"key":"QCjoPFvaXL"}],"key":"Ql82Qh1d2E"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"strong","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"inlineCode","value":"custom_stoploss()","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"aXyUOKHSsp"}],"key":"V0nO9KGfF1"},{"type":"text","value":" - 自定义追踪止损，在每次迭代时对每个开放交易调用，直到交易关闭。这里返回的值也用于","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"GsQJ9HJCD3"},{"type":"crossReference","url":"/stoploss","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"交易所止损","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"wuyqiDpx0A"}],"urlSource":"stoploss.md#stop-loss-on-exchangefreqtrade","dataUrl":"/stoploss.json","identifier":"stop-loss-on-exchangefreqtrade","label":"stop-loss-on-exchangefreqtrade","remote":true,"protocol":"file","key":"eeUVk9TEtx"},{"type":"text","value":"。","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"MdIHdUBINT"}],"key":"Oasia609BA"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":17,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"✅ ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"yjFBmOFJAI"},{"type":"strong","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"使用场景","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"CZ4r5O7iC0"}],"key":"fHRdywnCjr"},{"type":"text","value":"：自定义止损逻辑，根据交易数据或其他条件设置动态止损。","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"HhtE9FRuh8"}],"key":"phuxpF0a0W"}],"key":"R7ZFrs1jTW"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"🚫 ","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"FKfyO2LL1S"},{"type":"strong","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"不适用场景","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"sq2zFGbygd"}],"key":"UmMMeb64wp"},{"type":"text","value":"：基于特定条件立即退出交易。使用 ","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"N7irTUPFAC"},{"type":"inlineCode","value":"custom_exit()","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"R7mwMIrbjp"},{"type":"text","value":" 来实现这个目的。","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"S0ARnn0hIW"}],"key":"eb1vvGnEd0"}],"key":"RxAXzUhIAu"}],"key":"r19V3vTdqo"}],"key":"uQBvIK72jy"},{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"strong","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"inlineCode","value":"custom_roi()","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"DHx1RO5jZC"}],"key":"UE5iXpYMxy"},{"type":"text","value":" - 自定义 ROI，在每次迭代时对每个开放交易调用，直到交易关闭。","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"gMBVDtYLfg"}],"key":"jRbb4fqNsc"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":23,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"✅ ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"F5oceV0FwG"},{"type":"strong","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"使用场景","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"qcqkUlxNZL"}],"key":"c1UjAjAOCh"},{"type":"text","value":"：指定最小 ROI 阈值（“止盈”），根据利润或其他条件在交易持续时间内某个时间点以这个 ROI 水平退出交易。","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"LjD6NSrv4a"}],"key":"c8mwTWiY52"}],"key":"W8OXYAJZjw"},{"type":"listItem","spread":true,"position":{"start":{"line":25,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"🚫 ","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"RARy4ChkUD"},{"type":"strong","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"不适用场景","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"ZIe5QkznFs"}],"key":"bf3n0G817E"},{"type":"text","value":"：基于特定条件立即退出交易。使用 ","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"EQ1h7xCckr"},{"type":"inlineCode","value":"custom_exit()","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"JOg1I6I4nz"},{"type":"text","value":"。","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"j4Wi32cBDf"}],"key":"WXyAZ58WNb"}],"key":"pkH7z3sxAU"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"🚫 ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"IEm8OcYJ4q"},{"type":"strong","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"不适用场景","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"m1f3T9kGjB"}],"key":"Sf9FBsoJiV"},{"type":"text","value":"：静态 ROI。使用 ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"mjSH1Oogig"},{"type":"inlineCode","value":"minimal_roi","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"ZYbMVPzwj3"},{"type":"text","value":"。","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"qs7F3mlnvq"}],"key":"E7DnTHnl88"}],"key":"SAXnHtvSGs"}],"key":"SvuHp8zhZZ"}],"key":"n3NdFDwydm"}],"key":"g8oU5UjA9N"}],"key":"HwbhQ20H59"},{"type":"heading","depth":3,"position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"text","value":"机器人启动","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"dXz01HmPnx"}],"label":"bot-start","identifier":"bot-start","html_id":"bot-start","key":"z9d7BxoO1P"},{"type":"paragraph","position":{"start":{"line":46,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"text","value":"一个简单的回调，在策略加载时只调用一次。\n这可用于执行只需执行一次的操作，并在数据供应商 (dataprovider) 和钱包设置后运行。","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"nTOyPS0p4m"}],"key":"jd2d663DUc"},{"type":"code","lang":"python","value":"import requests\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    def bot_start(self, **kwargs) -> None:\n        \"\"\"\n        Called only once after bot instantiation.\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        \"\"\"\n        if self.config[\"runmode\"].value in (\"live\", \"dry_run\"):\n            # Assign this to the class by using self.*\n            # can then be used by populate_* methods\n            self.custom_remote_data = requests.get(\"https://some_remote_source.example.com\")\n","position":{"start":{"line":49,"column":1},"end":{"line":66,"column":1}},"key":"weOstE2c5x"},{"type":"paragraph","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"text","value":"在 hyperopt 时，这个回调只会在启动时运行一次。","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"kNp6idhN07"}],"key":"j6Vp5aMB9f"},{"type":"heading","depth":3,"position":{"start":{"line":72,"column":1},"end":{"line":72,"column":1}},"children":[{"type":"text","value":"机器人循环开始","position":{"start":{"line":72,"column":1},"end":{"line":72,"column":1}},"key":"zkIKVbx32x"}],"label":"bot-loop-start","identifier":"bot-loop-start","html_id":"bot-loop-start","key":"JwXWNdC6pe"},{"type":"paragraph","position":{"start":{"line":74,"column":1},"end":{"line":75,"column":1}},"children":[{"type":"text","value":"一个简单的回调，在每次机器人节流循环开始时调用一次（在 dry/live 模式下大约每 5 秒，除非另有配置），或在回测/hyperopt 模式下每根 K 线调用一次。\n这可用于执行与交易对无关的计算（适用于所有交易对）、加载外部数据等。","position":{"start":{"line":74,"column":1},"end":{"line":74,"column":1}},"key":"UVTUB2dYBU"}],"key":"A3xcZkFsI6"},{"type":"code","lang":"python","value":"# Default imports\nimport requests\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    def bot_loop_start(self, current_time: datetime, **kwargs) -> None:\n        \"\"\"\n        Called at the start of the bot iteration (one loop).\n        Might be used to perform pair-independent tasks\n        (e.g. gather some remote resource for comparison)\n        :param current_time: datetime object, containing the current datetime\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        \"\"\"\n        if self.config[\"runmode\"].value in (\"live\", \"dry_run\"):\n            # Assign this to the class by using self.*\n            # can then be used by populate_* methods\n            self.remote_data = requests.get(\"https://some_remote_source.example.com\")\n","position":{"start":{"line":77,"column":1},"end":{"line":98,"column":1}},"key":"hQPxcoOTQN"},{"type":"heading","depth":3,"position":{"start":{"line":102,"column":1},"end":{"line":102,"column":1}},"children":[{"type":"text","value":"仓位大小管理","position":{"start":{"line":102,"column":1},"end":{"line":102,"column":1}},"key":"xcVMuxtTYG"}],"label":"stake-size-management","identifier":"stake-size-management","html_id":"stake-size-management","key":"luCxv7t4u4"},{"type":"paragraph","position":{"start":{"line":104,"column":1},"end":{"line":104,"column":1}},"children":[{"type":"text","value":"在进入交易前调用，使你可以在下新单时管理仓位大小。","position":{"start":{"line":104,"column":1},"end":{"line":104,"column":1}},"key":"gCwNYzkxfa"}],"key":"doLfCF19hi"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n    def custom_stake_amount(self, pair: str, current_time: datetime, current_rate: float,\n                            proposed_stake: float, min_stake: float | None, max_stake: float,\n                            leverage: float, entry_tag: str | None, side: str,\n                            **kwargs) -> float:\n\n        dataframe, _ = self.dp.get_analyzed_dataframe(pair=pair, timeframe=self.timeframe)\n        current_candle = dataframe.iloc[-1].squeeze()\n\n        if current_candle[\"fastk_rsi_1h\"] > current_candle[\"fastd_rsi_1h\"]:\n            if self.config[\"stake_amount\"] == \"unlimited\":\n                # Use entire available wallet during favorable conditions when in compounding mode.\n                return max_stake\n            else:\n                # Compound profits during favorable conditions instead of using a static stake.\n                return self.wallets.get_total_stake_amount() / self.config[\"max_open_trades\"]\n\n        # Use default stake amount.\n        return proposed_stake","position":{"start":{"line":106,"column":1},"end":{"line":128,"column":1}},"key":"AlCSrTirUn"},{"type":"paragraph","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"children":[{"type":"text","value":"如果你的代码抛出异常，Freqtrade 会回退到 ","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"oTHqBWgs5E"},{"type":"inlineCode","value":"proposed_stake","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"ONVxsSN8vC"},{"type":"text","value":" 的值。异常本身会被记录。","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"zJZzJ6aCFy"}],"key":"BqqRlmtKfV"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"ImPaiYMWhA"}],"key":"O9Iqg7Z7nM"},{"type":"paragraph","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"children":[{"type":"text","value":"你不必确保 ","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"v8pbMUmArw"},{"type":"inlineCode","value":"min_stake <= returned_value <= max_stake","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"T7Bdj7JZpe"},{"type":"text","value":"。交易会成功，因为返回值会被限制在支持的范围内，并且此操作会被记录。","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"kSI18QO4eu"}],"key":"WSU7rwsRx9"}],"key":"M92plOPUva"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"VMqMxpH3tL"}],"key":"A04dzgfG2q"},{"type":"paragraph","position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"children":[{"type":"text","value":"返回 ","position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"key":"v3F4AvyMOk"},{"type":"inlineCode","value":"0","position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"key":"WikzFYyi7Z"},{"type":"text","value":" 或 ","position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"key":"T6NXyFiWSq"},{"type":"inlineCode","value":"None","position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"key":"AupxYq1CpR"},{"type":"text","value":" 会阻止下单。","position":{"start":{"line":137,"column":1},"end":{"line":137,"column":1}},"key":"AkIP4WgtVr"}],"key":"DlJ6F17xoY"}],"key":"jooCcaiZp0"},{"type":"heading","depth":3,"position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"children":[{"type":"text","value":"自定义退出信号","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"key":"KVmlJET9wq"}],"label":"custom-exit-signal","identifier":"custom-exit-signal","html_id":"custom-exit-signal","key":"LqemryjSUH"},{"type":"paragraph","position":{"start":{"line":144,"column":1},"end":{"line":144,"column":1}},"children":[{"type":"text","value":"在每次节流迭代（大约每 5 秒）时对开放交易调用，直到交易关闭。","position":{"start":{"line":144,"column":1},"end":{"line":144,"column":1}},"key":"tchEtIwEQt"}],"key":"w9edZMvITF"},{"type":"paragraph","position":{"start":{"line":146,"column":1},"end":{"line":146,"column":1}},"children":[{"type":"text","value":"允许定义自定义退出信号，指示应关闭指定仓位（完全退出）。这在需要为每个单独的交易自定义退出条件，或者需要交易数据来做出退出决定时非常有用。","position":{"start":{"line":146,"column":1},"end":{"line":146,"column":1}},"key":"aj4VvSVshR"}],"key":"FxzJihZvkA"},{"type":"paragraph","position":{"start":{"line":148,"column":1},"end":{"line":148,"column":1}},"children":[{"type":"text","value":"例如，你可以使用 ","position":{"start":{"line":148,"column":1},"end":{"line":148,"column":1}},"key":"sVxKL5y2bl"},{"type":"inlineCode","value":"custom_exit()","position":{"start":{"line":148,"column":1},"end":{"line":148,"column":1}},"key":"eO7IW98yMi"},{"type":"text","value":" 实现 1:2 的风险回报比。","position":{"start":{"line":148,"column":1},"end":{"line":148,"column":1}},"key":"sA9oTXBEzw"}],"key":"rOc9f5ZbWj"},{"type":"paragraph","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"children":[{"type":"text","value":"不过，使用 ","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"Cf8b8YkfSK"},{"type":"inlineCode","value":"custom_exit()","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"iuBLjvRXhn"},{"type":"text","value":" 信号代替止损 ","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"gJbmf9k2CF"},{"type":"emphasis","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"children":[{"type":"text","value":"不推荐","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"sSIAP6MUW1"}],"key":"FBlGpmCdTb"},{"type":"text","value":"。在这方面，它不如使用 ","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"nPloT1wBkv"},{"type":"inlineCode","value":"custom_stoploss()","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"yTIFaMNZe9"},{"type":"text","value":" 有效，后者还允许你在交易所保持止损。","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"eypu9nZYLy"}],"key":"gGF7KGJAxH"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"i8Z3NexvbV"}],"key":"VT9HPbmnHH"},{"type":"paragraph","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"children":[{"type":"text","value":"从此方法返回一个（非空）","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"htXyFlp4ZZ"},{"type":"inlineCode","value":"string","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"q9fZCwiBXI"},{"type":"text","value":" 或 ","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"UFvTfecvY6"},{"type":"inlineCode","value":"True","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"KWPVPWRJFC"},{"type":"text","value":" 等同于在指定时间设置退出信号。如果已经设置了退出信号，或者退出信号被禁用（","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"etetiaDAnA"},{"type":"inlineCode","value":"use_exit_signal=False","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"WZCqvJm0Ur"},{"type":"text","value":"），则不会调用此方法。","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"YnKhwFdO8E"},{"type":"inlineCode","value":"string","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"bIAg4Ow6tc"},{"type":"text","value":" 的最大长度为 64 个字符。超过此限制将导致消息被截断为 64 个字符。","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"bYEPCSnliu"}],"key":"z9gUSIaQA3"},{"type":"paragraph","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"children":[{"type":"inlineCode","value":"custom_exit()","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"TNwc8FHFYF"},{"type":"text","value":" 将忽略 ","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"O6KG72xRhd"},{"type":"inlineCode","value":"exit_profit_only","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"rssuJCUhUw"},{"type":"text","value":"，并且除非 ","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"muQhZHBNYz"},{"type":"inlineCode","value":"use_exit_signal=False","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"qGltnoPfgA"},{"type":"text","value":"，否则始终会被调用，即使有新的进入信号。","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"mMNfNRaRLA"}],"key":"XvQHMFwwgd"}],"key":"YVwjPAdBvz"},{"type":"paragraph","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"children":[{"type":"text","value":"一个示例，说明如何根据当前利润使用不同的指标，并退出已开放超过一天的交易：","position":{"start":{"line":158,"column":1},"end":{"line":158,"column":1}},"key":"fOWJsU1LEg"}],"key":"Dj5H53pPDL"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n    def custom_exit(self, pair: str, trade: Trade, current_time: datetime, current_rate: float,\n                    current_profit: float, **kwargs):\n        dataframe, _ = self.dp.get_analyzed_dataframe(pair, self.timeframe)\n        last_candle = dataframe.iloc[-1].squeeze()\n\n        # Above 20% profit, sell when rsi < 80\n        if current_profit > 0.2:\n            if last_candle[\"rsi\"] < 80:\n                return \"rsi_below_80\"\n\n        # Between 2% and 10%, sell if EMA-long above EMA-short\n        if 0.02 < current_profit < 0.1:\n            if last_candle[\"emalong\"] > last_candle[\"emashort\"]:\n                return \"ema_long_below_80\"\n\n        # Sell any positions at a loss if they are held for more than one day.\n        if current_profit < 0.0 and (current_time - trade.open_date_utc).days >= 1:\n            return \"unclog\"","position":{"start":{"line":160,"column":1},"end":{"line":182,"column":1}},"key":"t9oRzPAMob"},{"type":"paragraph","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"children":[{"type":"text","value":"请参阅 ","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"iw1njOUscc"},{"type":"crossReference","url":"/strategy-advanced","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"children":[{"type":"text","value":"Dataframe 访问","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"mFo0K3gAKh"}],"urlSource":"strategy-advanced.md#dataframe-access","dataUrl":"/strategy-advanced.json","identifier":"dataframe-access","label":"dataframe-access","remote":true,"protocol":"file","key":"ea6tdv6YoP"},{"type":"text","value":" 以获取有关在策略回调中使用 dataframe 的更多信息。","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"wevzhJU3Lt"}],"key":"noN03dTBld"},{"type":"heading","depth":3,"position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"children":[{"type":"text","value":"自定义止损","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"key":"Gu86BFQEit"}],"label":"custom-stoploss","identifier":"custom-stoploss","html_id":"custom-stoploss","key":"DcFId1mBJb"},{"type":"paragraph","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"children":[{"type":"text","value":"在每次迭代（大约每 5 秒）时对开放交易调用，直到交易关闭。","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"key":"SZE21gUD4m"}],"key":"PbafjSozY6"},{"type":"paragraph","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"children":[{"type":"text","value":"必须通过在策略对象上设置 ","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"A9JGokLDVI"},{"type":"inlineCode","value":"use_custom_stoploss=True","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"l6LApWB2tC"},{"type":"text","value":" 来启用自定义止损方法。","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"Ezogrd9OdB"}],"key":"oGpdW73neL"},{"type":"paragraph","position":{"start":{"line":194,"column":1},"end":{"line":194,"column":1}},"children":[{"type":"text","value":"止损价格只能向上移动 - 如果从 ","position":{"start":{"line":194,"column":1},"end":{"line":194,"column":1}},"key":"ubOUGr6pJR"},{"type":"inlineCode","value":"custom_stoploss","position":{"start":{"line":194,"column":1},"end":{"line":194,"column":1}},"key":"z1WKqh93Zi"},{"type":"text","value":" 返回的止损值会导致止损价格低于之前设置的价格，则会被忽略。传统的 ","position":{"start":{"line":194,"column":1},"end":{"line":194,"column":1}},"key":"Ski5fecIUs"},{"type":"inlineCode","value":"stoploss","position":{"start":{"line":194,"column":1},"end":{"line":194,"column":1}},"key":"uBgC9Jj18I"},{"type":"text","value":" 值作为绝对下限，并将作为初始止损（在此方法首次为交易调用之前），并且仍然是强制性的。","position":{"start":{"line":194,"column":1},"end":{"line":194,"column":1}},"key":"woOpdCcgJJ"}],"key":"sZjRPbbrbW"},{"type":"paragraph","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"children":[{"type":"text","value":"由于自定义止损作为常规、变化的止损，其行为类似于 ","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"x6hGA0Zyqr"},{"type":"inlineCode","value":"trailing_stop","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"LTfdntBPHf"},{"type":"text","value":" - 因此，由于此原因退出的交易将具有 ","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"X8KwUpuTjV"},{"type":"inlineCode","value":"\"trailing_stop_loss\"","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"SWABNWOLQF"},{"type":"text","value":" 的退出原因。","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"SKSxY2PsnB"}],"key":"Cf0EeTHJiT"},{"type":"paragraph","position":{"start":{"line":198,"column":1},"end":{"line":198,"column":1}},"children":[{"type":"text","value":"该方法必须返回一个止损值（浮点数/数字），作为当前价格的百分比。","position":{"start":{"line":198,"column":1},"end":{"line":198,"column":1}},"key":"Q6ouwqTrS2"}],"key":"z4DoOj0cXx"},{"type":"paragraph","position":{"start":{"line":200,"column":1},"end":{"line":200,"column":1}},"children":[{"type":"text","value":"例如，如果 ","position":{"start":{"line":200,"column":1},"end":{"line":200,"column":1}},"key":"fwUX0ZmR9N"},{"type":"inlineCode","value":"current_rate","position":{"start":{"line":200,"column":1},"end":{"line":200,"column":1}},"key":"eSQKhuPcrz"},{"type":"text","value":" 是 200 美元，则返回 ","position":{"start":{"line":200,"column":1},"end":{"line":200,"column":1}},"key":"MlJzYUd7lI"},{"type":"inlineCode","value":"0.02","position":{"start":{"line":200,"column":1},"end":{"line":200,"column":1}},"key":"Z3PISUQqwH"},{"type":"text","value":" 将设置止损价格比当前价格低 2%，即 196 美元。","position":{"start":{"line":200,"column":1},"end":{"line":200,"column":1}},"key":"q7uLSEMopB"}],"key":"f52NhIOMnQ"},{"type":"paragraph","position":{"start":{"line":202,"column":1},"end":{"line":202,"column":1}},"children":[{"type":"text","value":"在回测期间，","position":{"start":{"line":202,"column":1},"end":{"line":202,"column":1}},"key":"aqIKBMJo2r"},{"type":"inlineCode","value":"current_rate","position":{"start":{"line":202,"column":1},"end":{"line":202,"column":1}},"key":"W1sA7Ea7jU"},{"type":"text","value":"（和 ","position":{"start":{"line":202,"column":1},"end":{"line":202,"column":1}},"key":"z0rl4s8UOT"},{"type":"inlineCode","value":"current_profit","position":{"start":{"line":202,"column":1},"end":{"line":202,"column":1}},"key":"GKZQ9sjwj1"},{"type":"text","value":"）是针对 K 线的高点（或空头交易的低点）提供的，而最终的止损是针对 K 线的低点（或空头交易的高点）进行评估的。","position":{"start":{"line":202,"column":1},"end":{"line":202,"column":1}},"key":"YnIi5CMH6i"}],"key":"wgBpnw457N"},{"type":"paragraph","position":{"start":{"line":204,"column":1},"end":{"line":206,"column":1}},"children":[{"type":"text","value":"返回值的绝对值被使用（符号被忽略），因此返回 ","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"nBdnIt1Ccx"},{"type":"inlineCode","value":"0.05","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"AdxhAEZC1g"},{"type":"text","value":" 或 ","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"AHXY412Ed6"},{"type":"inlineCode","value":"-0.05","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"V79CqvBMgw"},{"type":"text","value":" 具有相同的结果，即止损比当前价格低 5%。\n返回 ","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"ajWMVRLgi5"},{"type":"inlineCode","value":"None","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"atVDRn89Xl"},{"type":"text","value":" 将被解释为\"不希望更改\"，并且是当你不想修改止损时的唯一安全返回方式。\n","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"Yfdyjb2r6B"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"n7cMwHmofG"},{"type":"text","value":" 和 ","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"K9JYocQXBE"},{"type":"inlineCode","value":"inf","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"huPH60ZUGb"},{"type":"text","value":" 值被视为无效，并将被忽略（与 ","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"KB4D0zUUqH"},{"type":"inlineCode","value":"None","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"CjjrQU4SMe"},{"type":"text","value":" 相同）。","position":{"start":{"line":204,"column":1},"end":{"line":204,"column":1}},"key":"tRDPJ1TL5K"}],"key":"MreoD3MUXf"},{"type":"paragraph","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"children":[{"type":"text","value":"交易所上的止损与 ","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"FHFR4Z1oZJ"},{"type":"inlineCode","value":"trailing_stop","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"i11n990ZGx"},{"type":"text","value":" 类似，并且交易所上的止损会根据 ","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"QQpRKWkMv2"},{"type":"inlineCode","value":"stoploss_on_exchange_interval","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"VnVhoKbgF2"},{"type":"text","value":" 进行更新（","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"OSas3GXZLv"},{"type":"crossReference","url":"/stoploss","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"children":[{"type":"text","value":"有关交易所止损的更多详细信息","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"shFTO7ZdrK"}],"urlSource":"stoploss.md#stop-loss-on-exchangefreqtrade","dataUrl":"/stoploss.json","identifier":"stop-loss-on-exchangefreqtrade","label":"stop-loss-on-exchangefreqtrade","remote":true,"protocol":"file","key":"nZoFT3lZk5"},{"type":"text","value":"）。","position":{"start":{"line":208,"column":1},"end":{"line":208,"column":1}},"key":"qkXxqlSH8c"}],"key":"rh3OsZ9x4C"},{"type":"paragraph","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"children":[{"type":"text","value":"如果你在期货市场上，请注意 ","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"pDaMNod6Fh"},{"type":"crossReference","url":"/stoploss","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"children":[{"type":"text","value":"止损和杠杆","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"yPfsXpm5Qd"}],"urlSource":"stoploss.md#stoploss-and-leverage","dataUrl":"/stoploss.json","identifier":"stoploss-and-leverage","label":"stoploss-and-leverage","remote":true,"protocol":"file","key":"opRJvL4Yoa"},{"type":"text","value":" 部分，因为从 ","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"MKTvrIT2TX"},{"type":"inlineCode","value":"custom_stoploss","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"XVYcUsbnxd"},{"type":"text","value":" 返回的止损值是该交易的风险，而不是相对价格变动。","position":{"start":{"line":210,"column":1},"end":{"line":210,"column":1}},"key":"iXBO7PNLCJ"}],"key":"Dp2AEVyKQo"},{"type":"admonition","kind":"important","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"使用日期","position":{"start":{"line":212,"column":1},"end":{"line":212,"column":1}},"key":"B2lSpJiWBG"}],"key":"OUQ825DW3p"},{"type":"paragraph","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"children":[{"type":"text","value":"所有基于时间的计算都应基于 ","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"key":"QaPoR8lfei"},{"type":"inlineCode","value":"current_time","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"key":"pW3lIbQKRQ"},{"type":"text","value":" - 不鼓励使用 ","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"key":"A7DVopDSYZ"},{"type":"inlineCode","value":"datetime.now()","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"key":"LOMRfDcq9N"},{"type":"text","value":" 或 ","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"key":"MmQbX1v8Lv"},{"type":"inlineCode","value":"datetime.utcnow()","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"key":"jJgjeNLVZW"},{"type":"text","value":"，因为这会影响回测支持。","position":{"start":{"line":213,"column":1},"end":{"line":213,"column":1}},"key":"J9Sfu61O7J"}],"key":"C8AzTJOifg"}],"key":"bOU2u62E1t"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"追踪止损","position":{"start":{"line":216,"column":1},"end":{"line":216,"column":1}},"key":"CX8SMrjiGa"}],"key":"EtEwvc5haQ"},{"type":"paragraph","position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"children":[{"type":"text","value":"在使用自定义止损值时，建议禁用 ","position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"key":"gMBjLNvVjl"},{"type":"inlineCode","value":"trailing_stop","position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"key":"ZwWctDDzMs"},{"type":"text","value":"。两者可以协同工作，但你可能会遇到追踪止损将价格推高，而你的自定义函数不希望这种情况，导致冲突行为。","position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"key":"Eo8kgG8iSc"}],"key":"Bnsj1swx4i"}],"key":"iZ5vtE3s1W"},{"type":"heading","depth":4,"position":{"start":{"line":220,"column":1},"end":{"line":220,"column":1}},"children":[{"type":"text","value":"调整止损后调整仓位","position":{"start":{"line":220,"column":1},"end":{"line":220,"column":1}},"key":"Upkm1LIWit"}],"identifier":"id","label":"调整止损后调整仓位","html_id":"id-3","implicit":true,"key":"QevxMUM1WV"},{"type":"paragraph","position":{"start":{"line":222,"column":1},"end":{"line":223,"column":1}},"children":[{"type":"text","value":"根据你的策略，你可能需要在 ","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"QU5atTkMyu"},{"type":"crossReference","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"children":[{"type":"text","value":"仓位调整","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"xHvG3DXkpy"}],"identifier":"adjust-trade-position","label":"adjust-trade-position","kind":"heading","template":"{name}","resolved":true,"html_id":"adjust-trade-position","key":"jBqjqJitmG"},{"type":"text","value":" 后调整止损的方向。\n为此，freqtrade 将在订单成交后额外调用 ","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"P8CwL1Sv4L"},{"type":"inlineCode","value":"after_fill=True","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"JmxjPGqgTG"},{"type":"text","value":"，这将允许策略在任意方向移动止损（也可以扩大止损与当前价格之间的差距，这在其他情况下是禁止的）。","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"jBfLlS56BD"}],"key":"xk49oRGwoQ"},{"type":"admonition","kind":"important","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"向后兼容性","position":{"start":{"line":225,"column":1},"end":{"line":225,"column":1}},"key":"r0dILgdeHZ"}],"key":"sdv0W7HS4D"},{"type":"paragraph","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"children":[{"type":"text","value":"只有在你的 ","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"QTS691Ez4e"},{"type":"inlineCode","value":"custom_stoploss","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"TrllhhPUeX"},{"type":"text","value":" 函数定义中包含 ","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"IWwK2FYftm"},{"type":"inlineCode","value":"after_fill","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"cqlUuNiHup"},{"type":"text","value":" 参数时，才会进行此调用。","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"XLEQRohqd8"}],"key":"G9PSFIxTKV"},{"type":"paragraph","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"children":[{"type":"text","value":"因此，这不会影响（也不会让现有运行的策略感到意外）。","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"key":"FDOzGeXy7S"}],"key":"MuuV72EqU9"}],"key":"D0FLkvE9IF"},{"type":"heading","depth":4,"position":{"start":{"line":231,"column":1},"end":{"line":231,"column":1}},"children":[{"type":"text","value":"自定义止损示例","position":{"start":{"line":231,"column":1},"end":{"line":231,"column":1}},"key":"OvtMhYSa7l"}],"identifier":"id","label":"自定义止损示例","html_id":"id-4","implicit":true,"key":"bWE0IWQNxM"},{"type":"paragraph","position":{"start":{"line":233,"column":1},"end":{"line":234,"column":1}},"children":[{"type":"text","value":"下一节将展示一些使用自定义止损函数的示例。\n当然，还有更多可能性，所有示例都可以随意组合。","position":{"start":{"line":233,"column":1},"end":{"line":233,"column":1}},"key":"YJfuoeQhKJ"}],"key":"bLTMB6REpv"},{"type":"heading","depth":5,"position":{"start":{"line":236,"column":1},"end":{"line":236,"column":1}},"children":[{"type":"text","value":"通过自定义止损实现追踪止损","position":{"start":{"line":236,"column":1},"end":{"line":236,"column":1}},"key":"PEH62z5fhi"}],"identifier":"id","label":"通过自定义止损实现追踪止损","html_id":"id-5","implicit":true,"key":"jUoAyrBELK"},{"type":"paragraph","position":{"start":{"line":238,"column":1},"end":{"line":238,"column":1}},"children":[{"type":"text","value":"要模拟 4% 的常规追踪止损（在达到的最高价格后追踪 4%），你可以使用以下非常简单的方法：","position":{"start":{"line":238,"column":1},"end":{"line":238,"column":1}},"key":"kUoUuTa4ik"}],"key":"tQkVRDts9E"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* 方法\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool, \n                        **kwargs) -> float | None:\n        \"\"\"\n        自定义止损逻辑，返回相对于 current_rate 的新距离（作为比率）。\n        例如，返回 -0.05 将创建一个比 current_rate 低 5% 的止损。\n        自定义止损绝不能低于 self.stoploss，后者作为硬性最大损失。\n\n        完整文档请访问 https://www.freqtrade.io/en/latest/strategy-advanced/\n\n        如果策略未实现，则返回初始止损值。\n        仅在 use_custom_stoploss 设置为 True 时调用。\n\n        :param pair: 当前分析的交易对\n        :param trade: 交易对象。\n        :param current_time: 当前时间的 datetime 对象\n        :param current_rate: 基于 exit_pricing 中的定价设置计算的比率。\n        :param current_profit: 当前利润（作为比率），基于 current_rate 计算。\n        :param after_fill: 如果止损在订单成交后调用，则为 True。\n        :param **kwargs: 保持此参数，以免未来更新破坏你的策略。\n        :return float: 相对于 current_rate 的新止损值\n        \"\"\"\n        return -0.04 * trade.leverage","position":{"start":{"line":240,"column":1},"end":{"line":272,"column":1}},"key":"BzIwgbPgxv"},{"type":"heading","depth":5,"position":{"start":{"line":274,"column":1},"end":{"line":274,"column":1}},"children":[{"type":"text","value":"基于时间的追踪止损","position":{"start":{"line":274,"column":1},"end":{"line":274,"column":1}},"key":"JIZ0GY9NEa"}],"identifier":"id","label":"基于时间的追踪止损","html_id":"id-6","implicit":true,"key":"Z3gYAgF7Bq"},{"type":"paragraph","position":{"start":{"line":276,"column":1},"end":{"line":276,"column":1}},"children":[{"type":"text","value":"在前 60 分钟内使用初始止损，之后更改为 10% 的追踪止损，并在 2 小时（120 分钟）后使用 5% 的追踪止损。","position":{"start":{"line":276,"column":1},"end":{"line":276,"column":1}},"key":"ldUUVzgAI4"}],"key":"FS9zk531R2"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* 方法\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool, \n                        **kwargs) -> float | None:\n\n        # 确保最长的间隔在前 - 这些条件从上到下评估。\n        if current_time - timedelta(minutes=120) > trade.open_date_utc:\n            return -0.05 * trade.leverage\n        elif current_time - timedelta(minutes=60) > trade.open_date_utc:\n            return -0.10 * trade.leverage\n        return None","position":{"start":{"line":278,"column":1},"end":{"line":297,"column":1}},"key":"li5vrEU8W6"},{"type":"heading","depth":5,"position":{"start":{"line":299,"column":1},"end":{"line":299,"column":1}},"children":[{"type":"text","value":"基于时间的追踪止损，带有成交后调整","position":{"start":{"line":299,"column":1},"end":{"line":299,"column":1}},"key":"kkEMXxVxjg"}],"identifier":"id","label":"基于时间的追踪止损，带有成交后调整","html_id":"id-7","implicit":true,"key":"qqfcUvfhdh"},{"type":"paragraph","position":{"start":{"line":301,"column":1},"end":{"line":302,"column":1}},"children":[{"type":"text","value":"在前 60 分钟内使用初始止损，之后更改为 10% 的追踪止损，并在 2 小时（120 分钟）后使用 5% 的追踪止损。\n如果额外订单成交，将止损设置为新 ","position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"key":"F4y6CKJWHG"},{"type":"inlineCode","value":"open_rate","position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"key":"IbE6U6TmKg"},{"type":"text","value":" 下方 10%（","position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"key":"LTW16gj6xl"},{"type":"link","url":"#position-adjust-calculations","position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"children":[{"type":"text","value":"所有入场的平均值","position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"key":"BteZTTslvU"}],"urlSource":"#position-adjust-calculations","key":"BacqAPo5v6"},{"type":"text","value":"）。","position":{"start":{"line":301,"column":1},"end":{"line":301,"column":1}},"key":"E5xOeeeoQ1"}],"key":"fD57AE2RK5"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* 方法\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool, \n                        **kwargs) -> float | None:\n\n        if after_fill: \n            # 在额外订单后，从新开仓率下方 10% 的止损开始\n            return stoploss_from_open(0.10, current_profit, is_short=trade.is_short, leverage=trade.leverage)\n        # 确保最长的间隔在前 - 这些条件从上到下评估。\n        if current_time - timedelta(minutes=120) > trade.open_date_utc:\n            return -0.05 * trade.leverage\n        elif current_time - timedelta(minutes=60) > trade.open_date_utc:\n            return -0.10 * trade.leverage\n        return None","position":{"start":{"line":304,"column":1},"end":{"line":326,"column":1}},"key":"EpfcSErSSz"},{"type":"heading","depth":5,"position":{"start":{"line":328,"column":1},"end":{"line":328,"column":1}},"children":[{"type":"text","value":"每个交易对不同的止损","position":{"start":{"line":328,"column":1},"end":{"line":328,"column":1}},"key":"IyFYJTRQKI"}],"identifier":"id","label":"每个交易对不同的止损","html_id":"id-8","implicit":true,"key":"MbxMfwQFSP"},{"type":"paragraph","position":{"start":{"line":330,"column":1},"end":{"line":330,"column":1}},"children":[{"type":"text","value":"根据交易对使用不同的止损。","position":{"start":{"line":330,"column":1},"end":{"line":330,"column":1}},"key":"vPD5KOU8i8"}],"key":"rjzQ2RtRoV"},{"type":"paragraph","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"children":[{"type":"text","value":"在此示例中，我们将为 ","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"key":"i4Snzw8da8"},{"type":"inlineCode","value":"ETH/BTC","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"key":"HJce0XIsnb"},{"type":"text","value":" 和 ","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"key":"HA54KRGZOj"},{"type":"inlineCode","value":"XRP/BTC","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"key":"QGrVVAuVla"},{"type":"text","value":" 使用 10% 的追踪止损，为 ","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"key":"IfIviF2nMk"},{"type":"inlineCode","value":"LTC/BTC","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"key":"xtASP0fhjU"},{"type":"text","value":" 使用 5% 的追踪止损，并为所有其他交易对使用 15% 的追踪止损。","position":{"start":{"line":332,"column":1},"end":{"line":332,"column":1}},"key":"nDEJqcJRsR"}],"key":"DjwVmtnFmq"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* 方法\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool,\n                        **kwargs) -> float | None:\n\n        if pair in (\"ETH/BTC\", \"XRP/BTC\"):\n            return -0.10 * trade.leverage\n        elif pair in (\"LTC/BTC\"):\n            return -0.05 * trade.leverage\n        return -0.15 * trade.leverage","position":{"start":{"line":334,"column":1},"end":{"line":352,"column":1}},"key":"ac2e9YZKTK"},{"type":"heading","depth":5,"position":{"start":{"line":354,"column":1},"end":{"line":354,"column":1}},"children":[{"type":"text","value":"带正偏移的追踪止损","position":{"start":{"line":354,"column":1},"end":{"line":354,"column":1}},"key":"KiQ9l7sesc"}],"identifier":"id","label":"带正偏移的追踪止损","html_id":"id-9","implicit":true,"key":"a3akmdF5qj"},{"type":"paragraph","position":{"start":{"line":356,"column":1},"end":{"line":356,"column":1}},"children":[{"type":"text","value":"在利润超过 4% 之前使用初始止损，然后使用当前利润的 50% 作为追踪止损，最小为 2.5%，最大为 5%。","position":{"start":{"line":356,"column":1},"end":{"line":356,"column":1}},"key":"wkNdy8e8uA"}],"key":"dvuxX3nokk"},{"type":"paragraph","position":{"start":{"line":358,"column":1},"end":{"line":358,"column":1}},"children":[{"type":"text","value":"请注意，止损只能增加，低于当前止损的值将被忽略。","position":{"start":{"line":358,"column":1},"end":{"line":358,"column":1}},"key":"zdVXOwfR2t"}],"key":"aseRPWWvY3"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* 方法\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool,\n                        **kwargs) -> float | None:\n\n        if current_profit < 0.04:\n            return None # 返回 None 以继续使用初始止损\n\n        # 达到所需偏移后，允许止损追踪一半的利润\n        desired_stoploss = current_profit / 2\n\n        # 使用最小 2.5% 和最大 5%\n        return max(min(desired_stoploss, 0.05), 0.025) * trade.leverage","position":{"start":{"line":360,"column":1},"end":{"line":381,"column":1}},"key":"H4Egw6wxOx"},{"type":"heading","depth":5,"position":{"start":{"line":383,"column":1},"end":{"line":383,"column":1}},"children":[{"type":"text","value":"阶梯式止损","position":{"start":{"line":383,"column":1},"end":{"line":383,"column":1}},"key":"qKHRAqu6sR"}],"identifier":"id","label":"阶梯式止损","html_id":"id-10","implicit":true,"key":"NTBZUy40rq"},{"type":"paragraph","position":{"start":{"line":385,"column":1},"end":{"line":385,"column":1}},"children":[{"type":"text","value":"此示例不是连续追踪当前价格，而是根据当前利润设置固定的止损价格水平。","position":{"start":{"line":385,"column":1},"end":{"line":385,"column":1}},"key":"UH9yEoojp8"}],"key":"KinqMadNyu"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":387,"column":1},"end":{"line":391,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":387,"column":1},"end":{"line":387,"column":1}},"children":[{"type":"text","value":"在达到 20% 利润之前使用常规止损","position":{"start":{"line":387,"column":1},"end":{"line":387,"column":1}},"key":"gwAWnOg3R5"}],"key":"KSqwZOjWtp"},{"type":"listItem","spread":true,"position":{"start":{"line":388,"column":1},"end":{"line":388,"column":1}},"children":[{"type":"text","value":"一旦利润 > 20% - 将止损设置为开仓价格上方 7%。","position":{"start":{"line":388,"column":1},"end":{"line":388,"column":1}},"key":"TqZZK2ZKeQ"}],"key":"WQpeaVo3mA"},{"type":"listItem","spread":true,"position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"children":[{"type":"text","value":"一旦利润 > 25% - 将止损设置为开仓价格上方 15%。","position":{"start":{"line":389,"column":1},"end":{"line":389,"column":1}},"key":"xZ3gHkwHCr"}],"key":"xh3hCZvBmj"},{"type":"listItem","spread":true,"position":{"start":{"line":390,"column":1},"end":{"line":391,"column":1}},"children":[{"type":"text","value":"一旦利润 > 40% - 将止损设置为开仓价格上方 25%。","position":{"start":{"line":390,"column":1},"end":{"line":390,"column":1}},"key":"omBfzTa2P8"}],"key":"YGK6Bv5Oru"}],"key":"HwZddPWIjC"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool,\n                        **kwargs) -> float | None:\n\n        # evaluate highest to lowest, so that highest possible stop is used\n        if current_profit > 0.40:\n            return stoploss_from_open(0.25, current_profit, is_short=trade.is_short, leverage=trade.leverage)\n        elif current_profit > 0.25:\n            return stoploss_from_open(0.15, current_profit, is_short=trade.is_short, leverage=trade.leverage)\n        elif current_profit > 0.20:\n            return stoploss_from_open(0.07, current_profit, is_short=trade.is_short, leverage=trade.leverage)\n\n        # return maximum stoploss value, keeping current stoploss price unchanged\n        return None","position":{"start":{"line":392,"column":1},"end":{"line":415,"column":1}},"key":"TbGRmxtnyB"},{"type":"heading","depth":5,"position":{"start":{"line":417,"column":1},"end":{"line":417,"column":1}},"children":[{"type":"text","value":"使用数据框架中的指标实现自定义止损示例","position":{"start":{"line":417,"column":1},"end":{"line":417,"column":1}},"key":"OAHIbjZ5JH"}],"identifier":"id","label":"使用数据框架中的指标实现自定义止损示例","html_id":"id-11","implicit":true,"key":"lGsUMC2Ku1"},{"type":"paragraph","position":{"start":{"line":419,"column":1},"end":{"line":419,"column":1}},"children":[{"type":"text","value":"绝对止损值可以从存储在数据框架中的指标派生。此示例使用价格下方的抛物线 SAR 作为止损。","position":{"start":{"line":419,"column":1},"end":{"line":419,"column":1}},"key":"XMeLXd3NbD"}],"key":"RfgFQ8nOFq"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:\n        # <...>\n        dataframe[\"sar\"] = ta.SAR(dataframe)\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool,\n                        **kwargs) -> float | None:\n\n        dataframe, _ = self.dp.get_analyzed_dataframe(pair, self.timeframe)\n        last_candle = dataframe.iloc[-1].squeeze()\n\n        # Use parabolic sar as absolute stoploss price\n        stoploss_price = last_candle[\"sar\"]\n\n        # Convert absolute price to percentage relative to current_rate\n        if stoploss_price < current_rate:\n            return stoploss_from_absolute(stoploss_price, current_rate, is_short=trade.is_short)\n\n        # return maximum stoploss value, keeping current stoploss price unchanged\n        return None","position":{"start":{"line":421,"column":1},"end":{"line":448,"column":1}},"key":"gp6uepCrHt"},{"type":"paragraph","position":{"start":{"line":450,"column":1},"end":{"line":450,"column":1}},"children":[{"type":"text","value":"有关在策略回调中使用数据框架的更多信息，请参见","position":{"start":{"line":450,"column":1},"end":{"line":450,"column":1}},"key":"MfjU1xvg4b"},{"type":"crossReference","url":"/strategy-advanced","position":{"start":{"line":450,"column":1},"end":{"line":450,"column":1}},"children":[{"type":"text","value":"数据框架访问","position":{"start":{"line":450,"column":1},"end":{"line":450,"column":1}},"key":"NOZVrzXO77"}],"urlSource":"strategy-advanced.md#dataframe-access","dataUrl":"/strategy-advanced.json","identifier":"dataframe-access","label":"dataframe-access","remote":true,"protocol":"file","key":"ahaqux0pjF"},{"type":"text","value":"。","position":{"start":{"line":450,"column":1},"end":{"line":450,"column":1}},"key":"dfaUNmHAQ5"}],"key":"jcFoNmAwj3"},{"type":"heading","depth":4,"position":{"start":{"line":452,"column":1},"end":{"line":452,"column":1}},"children":[{"type":"text","value":"止损计算的常用辅助函数","position":{"start":{"line":452,"column":1},"end":{"line":452,"column":1}},"key":"xSv3ZZPFK5"}],"identifier":"id","label":"止损计算的常用辅助函数","html_id":"id-12","implicit":true,"key":"bzOfkafv9q"},{"type":"heading","depth":5,"position":{"start":{"line":454,"column":1},"end":{"line":454,"column":1}},"children":[{"type":"text","value":"相对于开仓价格的止损","position":{"start":{"line":454,"column":1},"end":{"line":454,"column":1}},"key":"NinTzavY2e"}],"identifier":"id","label":"相对于开仓价格的止损","html_id":"id-13","implicit":true,"key":"eyd7610KAy"},{"type":"paragraph","position":{"start":{"line":456,"column":1},"end":{"line":457,"column":1}},"children":[{"type":"text","value":"从 ","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"eGxzUiq7nN"},{"type":"inlineCode","value":"custom_stoploss()","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"j5huYDIg8h"},{"type":"text","value":" 返回的止损值必须指定相对于 ","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"gDYpHLiAcC"},{"type":"inlineCode","value":"current_rate","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"nXjc8jPtmA"},{"type":"text","value":" 的百分比，但有时你可能想要指定相对于_开仓_价格的止损。\n","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"QWGH1wV0cT"},{"type":"inlineCode","value":"stoploss_from_open()","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"N8TpEqA98G"},{"type":"text","value":" 是一个辅助函数，用于计算可以从 ","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"b7bLPkQ2XO"},{"type":"inlineCode","value":"custom_stoploss","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"DOkAhjXBFW"},{"type":"text","value":" 返回的止损值，该值将等同于开仓点上方所需的交易利润。","position":{"start":{"line":456,"column":1},"end":{"line":456,"column":1}},"key":"Iowh07JxMp"}],"key":"CFDulnWabu"},{"type":"admonition","kind":"hint","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"从自定义止损函数返回相对于开仓价格的止损","position":{"start":{"line":459,"column":1},"end":{"line":459,"column":1}},"key":"BB4EHk3Zso"}],"key":"oJeGsdYB4t"},{"type":"paragraph","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"children":[{"type":"text","value":"假设开仓价格为 $100，","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"key":"MJqRyxXsZC"},{"type":"inlineCode","value":"current_price","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"key":"vAKXAzzm0b"},{"type":"text","value":" 为 $121（","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"key":"jVv4zB0YfS"},{"type":"inlineCode","value":"current_profit","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"key":"dFsJx0nBSI"},{"type":"text","value":" 将为 ","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"key":"OZN80fDidl"},{"type":"inlineCode","value":"0.21","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"key":"MLpGWqO12l"},{"type":"text","value":"）。","position":{"start":{"line":461,"column":1},"end":{"line":461,"column":1}},"key":"y45kNSu0Ry"}],"key":"UKCBTQ571B"},{"type":"paragraph","position":{"start":{"line":463,"column":1},"end":{"line":463,"column":1}},"children":[{"type":"text","value":"如果我们想要在开仓价格上方 7% 设置止损价格，我们可以调用 ","position":{"start":{"line":463,"column":1},"end":{"line":463,"column":1}},"key":"IZcKPRn7BV"},{"type":"inlineCode","value":"stoploss_from_open(0.07, current_profit, False)","position":{"start":{"line":463,"column":1},"end":{"line":463,"column":1}},"key":"xNakVj4A4N"},{"type":"text","value":"，它将返回 ","position":{"start":{"line":463,"column":1},"end":{"line":463,"column":1}},"key":"yc2mdBbqpK"},{"type":"inlineCode","value":"0.1157024793","position":{"start":{"line":463,"column":1},"end":{"line":463,"column":1}},"key":"VHwdybgqNm"},{"type":"text","value":"。$121 下方 11.57% 是 $107，这与 $100 上方 7% 相同。","position":{"start":{"line":463,"column":1},"end":{"line":463,"column":1}},"key":"nkwQ7IFuhP"}],"key":"OuYtb1UzpN"},{"type":"paragraph","position":{"start":{"line":465,"column":1},"end":{"line":465,"column":1}},"children":[{"type":"text","value":"此函数会考虑杠杆 - 所以在 10 倍杠杆下，实际止损将是 $100 上方 0.7%（0.7% * 10x = 7%）。","position":{"start":{"line":465,"column":1},"end":{"line":465,"column":1}},"key":"KrhtcdWA8m"}],"key":"FDduJM8qhP"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    use_custom_stoploss = True\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool,\n                        **kwargs) -> float | None:\n\n        # once the profit has risen above 10%, keep the stoploss at 7% above the open price\n        if current_profit > 0.10:\n            return stoploss_from_open(0.07, current_profit, is_short=trade.is_short, leverage=trade.leverage)\n\n        return 1\n","position":{"start":{"line":467,"column":1},"end":{"line":486,"column":1}},"key":"UfBfCpxOEY"},{"type":"paragraph","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"children":[{"type":"text","value":"完整示例可以在文档的","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"key":"PBPAkNc8HF"},{"type":"crossReference","url":"/strategy-callbacks","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"children":[{"type":"text","value":"自定义止损","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"key":"AVn49bVU3P"}],"urlSource":"strategy-callbacks.md#custom-stoploss","dataUrl":"/strategy-callbacks.json","identifier":"custom-stoploss","label":"custom-stoploss","remote":true,"protocol":"file","kind":"heading","template":"{name}","resolved":true,"html_id":"custom-stoploss","key":"wbMbJBML2l"},{"type":"text","value":"部分找到。","position":{"start":{"line":488,"column":1},"end":{"line":488,"column":1}},"key":"QAgx3npeDK"}],"key":"rtVgplSqZS"}],"key":"Qm0WpvUQoG"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"ycMO6uCZ1S"}],"key":"XYLKLkfVo1"},{"type":"paragraph","position":{"start":{"line":492,"column":1},"end":{"line":493,"column":1}},"children":[{"type":"text","value":"向 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"Ni86DyCR0d"},{"type":"inlineCode","value":"stoploss_from_open()","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"sZUyfbHlqv"},{"type":"text","value":" 提供无效输入可能会产生\"CustomStoploss 函数未返回有效止损\"警告。\n如果 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"XHDdikyY2t"},{"type":"inlineCode","value":"current_profit","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"ybwQBDG7dG"},{"type":"text","value":" 参数低于指定的 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"bvFf0KUdOf"},{"type":"inlineCode","value":"open_relative_stop","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"IsABnwtqu8"},{"type":"text","value":"，这种情况可能会发生。当交易关闭被 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"Z2MM13zpFc"},{"type":"inlineCode","value":"confirm_trade_exit()","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"LnjijniuMs"},{"type":"text","value":" 方法阻止时，可能会出现这种情况。可以通过在 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"PXA30P64WU"},{"type":"inlineCode","value":"confirm_trade_exit()","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"ZyK1caDUoe"},{"type":"text","value":" 中检查 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"SvLMpWsO8P"},{"type":"inlineCode","value":"exit_reason","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"lNy3I4TEKa"},{"type":"text","value":" 来永不阻止止损卖出，或者使用 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"ogwSblRVa4"},{"type":"inlineCode","value":"return stoploss_from_open(...) or 1","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"MNovIEiwHz"},{"type":"text","value":" 惯用法来解决警告，这将在 ","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"sRiNxoJtTI"},{"type":"inlineCode","value":"current_profit < open_relative_stop","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"EXw7JEUabU"},{"type":"text","value":" 时请求不更改止损。","position":{"start":{"line":492,"column":1},"end":{"line":492,"column":1}},"key":"eoeZzo6Pgx"}],"key":"EW008fr3q8"}],"key":"bryNttmr9L"},{"type":"heading","depth":5,"position":{"start":{"line":496,"column":1},"end":{"line":496,"column":1}},"children":[{"type":"text","value":"从绝对价格计算止损百分比","position":{"start":{"line":496,"column":1},"end":{"line":496,"column":1}},"key":"DhUdQIxkKh"}],"identifier":"id","label":"从绝对价格计算止损百分比","html_id":"id-14","implicit":true,"key":"Hz5TCisiKC"},{"type":"paragraph","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"children":[{"type":"text","value":"从 ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"JMUuLPPGil"},{"type":"inlineCode","value":"custom_stoploss()","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"b3eU3pxSLT"},{"type":"text","value":" 返回的止损值始终指定相对于 ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"ikbTdfwD3f"},{"type":"inlineCode","value":"current_rate","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"A5nlhaL0PC"},{"type":"text","value":" 的百分比。为了在指定的绝对价格水平设置止损，我们需要使用 ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"iPu1wkZDV4"},{"type":"inlineCode","value":"stop_rate","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"kGHEPQXnWM"},{"type":"text","value":" 来计算相对于 ","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"Dddk0EasvP"},{"type":"inlineCode","value":"current_rate","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"TM0doH86k0"},{"type":"text","value":" 的百分比，这将给出与从开仓价格指定百分比相同的结果。","position":{"start":{"line":498,"column":1},"end":{"line":498,"column":1}},"key":"gwepUPoS1U"}],"key":"ml7BvCJ8Ut"},{"type":"paragraph","position":{"start":{"line":500,"column":1},"end":{"line":500,"column":1}},"children":[{"type":"text","value":"辅助函数 ","position":{"start":{"line":500,"column":1},"end":{"line":500,"column":1}},"key":"r9ZcUEg4f2"},{"type":"inlineCode","value":"stoploss_from_absolute()","position":{"start":{"line":500,"column":1},"end":{"line":500,"column":1}},"key":"vY3hc2oenG"},{"type":"text","value":" 可用于将绝对价格转换为可以从 ","position":{"start":{"line":500,"column":1},"end":{"line":500,"column":1}},"key":"weRgVFTNpP"},{"type":"inlineCode","value":"custom_stoploss()","position":{"start":{"line":500,"column":1},"end":{"line":500,"column":1}},"key":"G9K7kZnqa5"},{"type":"text","value":" 返回的当前价格相对止损。","position":{"start":{"line":500,"column":1},"end":{"line":500,"column":1}},"key":"thVOAfJ5JA"}],"key":"H1U0NAmFdk"},{"type":"admonition","kind":"hint","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"从自定义止损函数返回使用绝对价格的止损","position":{"start":{"line":502,"column":1},"end":{"line":502,"column":1}},"key":"gSKitCVKhK"}],"key":"Tu8JhdrALn"},{"type":"paragraph","position":{"start":{"line":504,"column":1},"end":{"line":505,"column":1}},"children":[{"type":"text","value":"如果我们想要在当前价格下方 2xATR 追踪止损价格，我们可以调用 ","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"key":"Io3ErRKAIJ"},{"type":"inlineCode","value":"stoploss_from_absolute(current_rate + (side * candle[\"atr\"] * 2), current_rate=current_rate, is_short=trade.is_short, leverage=trade.leverage)","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"key":"NeZZL0VFxj"},{"type":"text","value":"。\n对于期货，我们需要调整方向（向上或向下）以及调整杠杆，因为 ","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"key":"niBiIkcVpl"},{"type":"crossReference","url":"/strategy-callbacks","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"children":[{"type":"inlineCode","value":"custom_stoploss","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"key":"n11a1LafRJ"}],"urlSource":"strategy-callbacks.md#custom-stoploss","dataUrl":"/strategy-callbacks.json","identifier":"custom-stoploss","label":"custom-stoploss","remote":true,"protocol":"file","kind":"heading","template":"{name}","resolved":true,"html_id":"custom-stoploss","key":"pidh1eVlrJ"},{"type":"text","value":" 回调返回的是","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"key":"en8yDrPVGg"},{"type":"crossReference","url":"/stoploss","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"children":[{"type":"text","value":"\"此交易的风险\"","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"key":"AN7BgZwxdQ"}],"urlSource":"stoploss.md#stoploss-and-leverage","dataUrl":"/stoploss.json","identifier":"stoploss-and-leverage","label":"stoploss-and-leverage","remote":true,"protocol":"file","key":"cth0TmjfpA"},{"type":"text","value":" - 而不是相对价格变动。","position":{"start":{"line":504,"column":1},"end":{"line":504,"column":1}},"key":"RsXtngg9ot"}],"key":"km7qCjfLmS"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    use_custom_stoploss = True\n\n    def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:\n        dataframe[\"atr\"] = ta.ATR(dataframe, timeperiod=14)\n        return dataframe\n\n    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,\n                        current_rate: float, current_profit: float, after_fill: bool,\n                        **kwargs) -> float | None:\n        dataframe, _ = self.dp.get_analyzed_dataframe(pair, self.timeframe)\n        trade_date = timeframe_to_prev_date(self.timeframe, trade.open_date_utc)\n        candle = dataframe.iloc[-1].squeeze()\n        side = 1 if trade.is_short else -1\n        return stoploss_from_absolute(current_rate + (side * candle[\"atr\"] * 2), \n                                        current_rate=current_rate, \n                                        is_short=trade.is_short,\n                                        leverage=trade.leverage)\n","position":{"start":{"line":507,"column":1},"end":{"line":530,"column":1}},"key":"fm9hLGHjUQ"}],"key":"GCVdvahPCj"},{"type":"thematicBreak","position":{"start":{"line":534,"column":1},"end":{"line":534,"column":1}},"key":"wErh2yKqVr"},{"type":"heading","depth":3,"position":{"start":{"line":536,"column":1},"end":{"line":536,"column":1}},"children":[{"type":"text","value":"自定义 ROI","position":{"start":{"line":536,"column":1},"end":{"line":536,"column":1}},"key":"snoUTdf7FO"}],"identifier":"id-roi","label":"自定义 ROI","html_id":"id-roi","implicit":true,"key":"irhLo1Wfxy"},{"type":"paragraph","position":{"start":{"line":538,"column":1},"end":{"line":538,"column":1}},"children":[{"type":"text","value":"对开放交易每次迭代（大约每 5 秒）调用，直到交易关闭。","position":{"start":{"line":538,"column":1},"end":{"line":538,"column":1}},"key":"YTZ3R0sfRd"}],"key":"ENMRrYtS9Z"},{"type":"paragraph","position":{"start":{"line":540,"column":1},"end":{"line":540,"column":1}},"children":[{"type":"text","value":"必须通过在策略对象上设置 ","position":{"start":{"line":540,"column":1},"end":{"line":540,"column":1}},"key":"BQeIiGRjhF"},{"type":"inlineCode","value":"use_custom_roi=True","position":{"start":{"line":540,"column":1},"end":{"line":540,"column":1}},"key":"XIBKxJC5od"},{"type":"text","value":" 来启用自定义 ROI 方法的使用。","position":{"start":{"line":540,"column":1},"end":{"line":540,"column":1}},"key":"jD1aBMPlWq"}],"key":"Xuse8WfAAw"},{"type":"paragraph","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"children":[{"type":"text","value":"此方法允许你定义退出交易的自定义最小 ROI 阈值，以比率表示（例如，","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"w9xQWHHiiF"},{"type":"inlineCode","value":"0.05","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"FeYccfkrb7"},{"type":"text","value":" 表示 5% 利润）。如果同时定义了 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"wqyrd486ZR"},{"type":"inlineCode","value":"minimal_roi","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"zygG3TgK3t"},{"type":"text","value":" 和 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"rCWMYeGyTy"},{"type":"inlineCode","value":"custom_roi","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"v2cimAci3h"},{"type":"text","value":"，则较低的阈值将触发退出。例如，如果 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"R5o9CuFomj"},{"type":"inlineCode","value":"minimal_roi","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"vdzhMfPt8A"},{"type":"text","value":" 设置为 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"HAIsfs8zdR"},{"type":"inlineCode","value":"{\"0\": 0.10}","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"eknMw3eqi5"},{"type":"text","value":"（0 分钟时为 10%）且 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"uSCRDCPrfq"},{"type":"inlineCode","value":"custom_roi","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"X0pLCRhu8w"},{"type":"text","value":" 返回 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"r9UZqhrktI"},{"type":"inlineCode","value":"0.05","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"bHkO0dJgli"},{"type":"text","value":"，则当利润达到 5% 时交易将退出。同样，如果 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"XPaZ6O3GLq"},{"type":"inlineCode","value":"custom_roi","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"z2hrpXJCKd"},{"type":"text","value":" 返回 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"LgBlnsnmaY"},{"type":"inlineCode","value":"0.10","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"hjLyf0Cw2O"},{"type":"text","value":" 且 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"R2rVAXmvfd"},{"type":"inlineCode","value":"minimal_roi","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"e1kKcr3wi7"},{"type":"text","value":" 设置为 ","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"UfIsm31Fl4"},{"type":"inlineCode","value":"{\"0\": 0.05}","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"KtrbhcfMb9"},{"type":"text","value":"（0 分钟时为 5%），则当利润达到 5% 时交易将关闭。","position":{"start":{"line":542,"column":1},"end":{"line":542,"column":1}},"key":"Z67BTZE8bV"}],"key":"GCno4tr4Nx"},{"type":"paragraph","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"children":[{"type":"text","value":"该方法必须返回一个表示新 ROI 阈值的浮点数比率，或返回 ","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"Ylpx2i86ir"},{"type":"inlineCode","value":"None","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"CsigasKvPZ"},{"type":"text","value":" 以回退到 ","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"xTm7zrirTB"},{"type":"inlineCode","value":"minimal_roi","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"n9WIOD91Te"},{"type":"text","value":" 逻辑。返回 ","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"gbiED0J3sn"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"hYV1uZ6H93"},{"type":"text","value":" 或 ","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"KtMZRHVMXi"},{"type":"inlineCode","value":"inf","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"fB4UybeNaG"},{"type":"text","value":" 值被视为无效，将被视为 ","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"v3flgDwE2k"},{"type":"inlineCode","value":"None","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"F1cmGWbGKI"},{"type":"text","value":"，导致机器人使用 ","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"o996lhYmog"},{"type":"inlineCode","value":"minimal_roi","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"CSQAk2WhtJ"},{"type":"text","value":" 配置。","position":{"start":{"line":544,"column":1},"end":{"line":544,"column":1}},"key":"IeGR4FGRvR"}],"key":"nqvZI4B36B"},{"type":"heading","depth":4,"position":{"start":{"line":546,"column":1},"end":{"line":546,"column":1}},"children":[{"type":"text","value":"自定义 ROI 示例","position":{"start":{"line":546,"column":1},"end":{"line":546,"column":1}},"key":"eOp6mF2lEK"}],"identifier":"id-roi","label":"自定义 ROI 示例","html_id":"id-roi-1","implicit":true,"key":"buz4K8OwJl"},{"type":"paragraph","position":{"start":{"line":548,"column":1},"end":{"line":548,"column":1}},"children":[{"type":"text","value":"以下示例说明如何使用 ","position":{"start":{"line":548,"column":1},"end":{"line":548,"column":1}},"key":"cwdNviMJYK"},{"type":"inlineCode","value":"custom_roi","position":{"start":{"line":548,"column":1},"end":{"line":548,"column":1}},"key":"w2k3eeSuGh"},{"type":"text","value":" 函数实现不同的 ROI 逻辑。","position":{"start":{"line":548,"column":1},"end":{"line":548,"column":1}},"key":"pG5YTCLQbA"}],"key":"f8nqtg1IZl"},{"type":"heading","depth":5,"position":{"start":{"line":550,"column":1},"end":{"line":550,"column":1}},"children":[{"type":"text","value":"按交易方向自定义 ROI","position":{"start":{"line":550,"column":1},"end":{"line":550,"column":1}},"key":"pt65NqHpqN"}],"identifier":"id-roi","label":"按交易方向自定义 ROI","html_id":"id-roi-2","implicit":true,"key":"IM5D3TdbZU"},{"type":"paragraph","position":{"start":{"line":552,"column":1},"end":{"line":552,"column":1}},"children":[{"type":"text","value":"根据 ","position":{"start":{"line":552,"column":1},"end":{"line":552,"column":1}},"key":"RMOIF0OGna"},{"type":"inlineCode","value":"side","position":{"start":{"line":552,"column":1},"end":{"line":552,"column":1}},"key":"kxLvri9diw"},{"type":"text","value":" 使用不同的 ROI 阈值。在此示例中，多头入场为 5%，空头入场为 2%。","position":{"start":{"line":552,"column":1},"end":{"line":552,"column":1}},"key":"oNn6y3a1TP"}],"key":"qnUofGh477"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    use_custom_roi = True\n\n    # ... populate_* methods\n\n    def custom_roi(self, pair: str, trade: Trade, current_time: datetime, trade_duration: int,\n                   entry_tag: str | None, side: str, **kwargs) -> float | None:\n        \"\"\"\n        自定义 ROI 逻辑，返回新的最小 ROI 阈值（以比率表示，例如 0.05 表示 +5%）。\n        仅在 use_custom_roi 设置为 True 时调用。\n\n        如果与 minimal_roi 同时使用，当达到较低的阈值时将触发退出。\n        示例：如果 minimal_roi = {\"0\": 0.01} 且 custom_roi 返回 0.05，\n        当利润达到 5% 时将触发退出。\n\n        :param pair: 当前分析的交易对。\n        :param trade: 交易对象。\n        :param current_time: datetime 对象，包含当前日期时间。\n        :param trade_duration: 当前交易持续时间（分钟）。\n        :param entry_tag: 如果买入信号提供了可选的 entry_tag（buy_tag）。\n        :param side: 'long' 或 'short' - 表示当前交易的方向。\n        :param **kwargs: 确保保留此参数，以便更新不会破坏你的策略。\n        :return float: 新的 ROI 值（比率），或 None 以回退到 minimal_roi 逻辑。\n        \"\"\"\n        return 0.05 if side == \"long\" else 0.02","position":{"start":{"line":554,"column":1},"end":{"line":583,"column":1}},"key":"RzkMZhkHBZ"},{"type":"heading","depth":5,"position":{"start":{"line":585,"column":1},"end":{"line":585,"column":1}},"children":[{"type":"text","value":"按交易对自定义 ROI","position":{"start":{"line":585,"column":1},"end":{"line":585,"column":1}},"key":"kXN7cLI62R"}],"identifier":"id-roi","label":"按交易对自定义 ROI","html_id":"id-roi-3","implicit":true,"key":"wHAsUUb4PZ"},{"type":"paragraph","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"children":[{"type":"text","value":"根据 ","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"key":"j48SArKhmC"},{"type":"inlineCode","value":"pair","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"key":"o6dsllMoYv"},{"type":"text","value":" 使用不同的 ROI 阈值。","position":{"start":{"line":587,"column":1},"end":{"line":587,"column":1}},"key":"dH4RK6lgmC"}],"key":"IzuLrF6eww"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    use_custom_roi = True\n\n    # ... populate_* methods\n\n    def custom_roi(self, pair: str, trade: Trade, current_time: datetime, trade_duration: int,\n                   entry_tag: str | None, side: str, **kwargs) -> float | None:\n\n        stake = trade.stake_currency\n        roi_map = {\n            f\"BTC/{stake}\": 0.02, # BTC 为 2%\n            f\"ETH/{stake}\": 0.03, # ETH 为 3%\n            f\"XRP/{stake}\": 0.04, # XRP 为 4%\n        }\n\n        return roi_map.get(pair, 0.01) # 其他交易对为 1%","position":{"start":{"line":589,"column":1},"end":{"line":609,"column":1}},"key":"HUKmqqjtrw"},{"type":"heading","depth":5,"position":{"start":{"line":611,"column":1},"end":{"line":611,"column":1}},"children":[{"type":"text","value":"按入场标签自定义 ROI","position":{"start":{"line":611,"column":1},"end":{"line":611,"column":1}},"key":"kT0g1qS02N"}],"identifier":"id-roi","label":"按入场标签自定义 ROI","html_id":"id-roi-4","implicit":true,"key":"hXDbhyIhtE"},{"type":"paragraph","position":{"start":{"line":613,"column":1},"end":{"line":613,"column":1}},"children":[{"type":"text","value":"根据买入信号提供的 ","position":{"start":{"line":613,"column":1},"end":{"line":613,"column":1}},"key":"QuP42JdWPe"},{"type":"inlineCode","value":"entry_tag","position":{"start":{"line":613,"column":1},"end":{"line":613,"column":1}},"key":"b6EnOsStKl"},{"type":"text","value":" 使用不同的 ROI 阈值。","position":{"start":{"line":613,"column":1},"end":{"line":613,"column":1}},"key":"QBWmObvkmM"}],"key":"HO0zu7RiUl"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    use_custom_roi = True\n\n    # ... populate_* methods\n\n    def custom_roi(self, pair: str, trade: Trade, current_time: datetime, trade_duration: int,\n                   entry_tag: str | None, side: str, **kwargs) -> float | None:\n\n        roi_by_tag = {\n            \"breakout\": 0.08,       # 如果标签是 \"breakout\" 则为 8%\n            \"rsi_overbought\": 0.05, # 如果标签是 \"rsi_overbought\" 则为 5%\n            \"mean_reversion\": 0.03, # 如果标签是 \"mean_reversion\" 则为 3%\n        }\n\n        return roi_by_tag.get(entry_tag, 0.01)  # 如果标签未知则为 1%","position":{"start":{"line":615,"column":1},"end":{"line":634,"column":1}},"key":"kUYYovz0vS"},{"type":"heading","depth":5,"position":{"start":{"line":636,"column":1},"end":{"line":636,"column":1}},"children":[{"type":"text","value":"基于 ATR 的自定义 ROI","position":{"start":{"line":636,"column":1},"end":{"line":636,"column":1}},"key":"fnvTN2V6H3"}],"identifier":"id-atr-roi","label":"基于 ATR 的自定义 ROI","html_id":"id-atr-roi","implicit":true,"key":"chZ3lnDCLO"},{"type":"paragraph","position":{"start":{"line":638,"column":1},"end":{"line":638,"column":1}},"children":[{"type":"text","value":"ROI 值可以从存储在数据框架中的指标派生。此示例使用 ATR 比率作为 ROI。","position":{"start":{"line":638,"column":1},"end":{"line":638,"column":1}},"key":"W8Yto1D9Ln"}],"key":"TWedp0kYDG"},{"type":"code","lang":"python","value":"# Default imports\n# <...>\nimport talib.abstract as ta\n\nclass AwesomeStrategy(IStrategy):\n\n    use_custom_roi = True\n\n    def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:\n        # <...>\n        dataframe[\"atr\"] = ta.ATR(dataframe, timeperiod=10)\n\n    def custom_roi(self, pair: str, trade: Trade, current_time: datetime, trade_duration: int,\n                   entry_tag: str | None, side: str, **kwargs) -> float | None:\n\n        dataframe, _ = self.dp.get_analyzed_dataframe(pair, self.timeframe)\n        last_candle = dataframe.iloc[-1].squeeze()\n        atr_ratio = last_candle[\"atr\"] / last_candle[\"close\"]\n\n        return atr_ratio # 返回 ATR 值作为比率","position":{"start":{"line":640,"column":1},"end":{"line":661,"column":1}},"key":"I250VUMTQG"},{"type":"thematicBreak","position":{"start":{"line":663,"column":1},"end":{"line":663,"column":1}},"key":"hA6Jem81De"},{"type":"heading","depth":3,"position":{"start":{"line":665,"column":1},"end":{"line":665,"column":1}},"children":[{"type":"text","value":"自定义订单价格规则","position":{"start":{"line":665,"column":1},"end":{"line":665,"column":1}},"key":"YLTKycod2v"}],"identifier":"id","label":"自定义订单价格规则","html_id":"id-15","implicit":true,"key":"k9ZTEStRAH"},{"type":"paragraph","position":{"start":{"line":667,"column":1},"end":{"line":667,"column":1}},"children":[{"type":"text","value":"默认情况下，freqtrade 使用订单簿自动设置订单价格（","position":{"start":{"line":667,"column":1},"end":{"line":667,"column":1}},"key":"MdCP6mU3pN"},{"type":"crossReference","url":"/configuration","position":{"start":{"line":667,"column":1},"end":{"line":667,"column":1}},"children":[{"type":"text","value":"相关文档","position":{"start":{"line":667,"column":1},"end":{"line":667,"column":1}},"key":"w1Em9UIZyC"}],"urlSource":"configuration.md#prices-used-for-orders","dataUrl":"/configuration.json","identifier":"prices-used-for-orders","label":"prices-used-for-orders","remote":true,"protocol":"file","key":"ISvq6qmEQP"},{"type":"text","value":"），你也可以选择基于你的策略创建自定义订单价格。","position":{"start":{"line":667,"column":1},"end":{"line":667,"column":1}},"key":"rvyNKjrhs0"}],"key":"pKHCm4OILb"},{"type":"paragraph","position":{"start":{"line":669,"column":1},"end":{"line":669,"column":1}},"children":[{"type":"text","value":"你可以通过在策略文件中创建 ","position":{"start":{"line":669,"column":1},"end":{"line":669,"column":1}},"key":"Xt4ug4hTWO"},{"type":"inlineCode","value":"custom_entry_price()","position":{"start":{"line":669,"column":1},"end":{"line":669,"column":1}},"key":"iu7BEYJxeb"},{"type":"text","value":" 函数自定义入场价格，以及 ","position":{"start":{"line":669,"column":1},"end":{"line":669,"column":1}},"key":"TFghHRxnXB"},{"type":"inlineCode","value":"custom_exit_price()","position":{"start":{"line":669,"column":1},"end":{"line":669,"column":1}},"key":"T91yV67Ovw"},{"type":"text","value":" 函数自定义出场价格。","position":{"start":{"line":669,"column":1},"end":{"line":669,"column":1}},"key":"oKkIGdOBK4"}],"key":"NV0VJpzryv"},{"type":"paragraph","position":{"start":{"line":671,"column":1},"end":{"line":671,"column":1}},"children":[{"type":"text","value":"每个方法都会在向交易所下单前被调用。","position":{"start":{"line":671,"column":1},"end":{"line":671,"column":1}},"key":"X3FRw88eaP"}],"key":"lVK4jgFG8Q"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"i0lxafmXcy"}],"key":"kCjFWFfmSh"},{"type":"paragraph","position":{"start":{"line":674,"column":1},"end":{"line":674,"column":1}},"children":[{"type":"text","value":"如果你的自定义定价函数返回 None 或无效值，价格将回退到 ","position":{"start":{"line":674,"column":1},"end":{"line":674,"column":1}},"key":"OsIsSt53ee"},{"type":"inlineCode","value":"proposed_rate","position":{"start":{"line":674,"column":1},"end":{"line":674,"column":1}},"key":"z1AcZJVbLu"},{"type":"text","value":"，即基于常规定价配置的价格。","position":{"start":{"line":674,"column":1},"end":{"line":674,"column":1}},"key":"kuI7nsqCsr"}],"key":"DsbmuDnZNI"},{"type":"paragraph","position":{"start":{"line":676,"column":1},"end":{"line":676,"column":1}},"children":[{"type":"text","value":"使用 custom_entry_price 时，Trade 对象会在与该交易相关的第一个入场订单创建时可用，对于第一次入场，","position":{"start":{"line":676,"column":1},"end":{"line":676,"column":1}},"key":"CQxxdso8Wx"},{"type":"inlineCode","value":"trade","position":{"start":{"line":676,"column":1},"end":{"line":676,"column":1}},"key":"ORJxVYc8Yp"},{"type":"text","value":" 参数值为 ","position":{"start":{"line":676,"column":1},"end":{"line":676,"column":1}},"key":"JGryYmCSLr"},{"type":"inlineCode","value":"None","position":{"start":{"line":676,"column":1},"end":{"line":676,"column":1}},"key":"xiiZ3hBgg9"},{"type":"text","value":"。","position":{"start":{"line":676,"column":1},"end":{"line":676,"column":1}},"key":"A1gkP4MCoJ"}],"key":"KcJX2tIPcY"}],"key":"m3AMwRLwes"},{"type":"heading","depth":4,"position":{"start":{"line":679,"column":1},"end":{"line":679,"column":1}},"children":[{"type":"text","value":"自定义订单入场和出场价格示例","position":{"start":{"line":679,"column":1},"end":{"line":679,"column":1}},"key":"M48irbwmMp"}],"identifier":"id","label":"自定义订单入场和出场价格示例","html_id":"id-16","implicit":true,"key":"E5EMjPQcWv"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    def custom_entry_price(self, pair: str, trade: Trade | None, current_time: datetime, proposed_rate: float,\n                           entry_tag: str | None, side: str, **kwargs) -> float:\n\n        dataframe, last_updated = self.dp.get_analyzed_dataframe(pair=pair,\n                                                                timeframe=self.timeframe)\n        new_entryprice = dataframe[\"bollinger_10_lowerband\"].iat[-1]\n\n        return new_entryprice\n\n    def custom_exit_price(self, pair: str, trade: Trade,\n                          current_time: datetime, proposed_rate: float,\n                          current_profit: float, exit_tag: str | None, **kwargs) -> float:\n\n        dataframe, last_updated = self.dp.get_analyzed_dataframe(pair=pair,\n                                                                timeframe=self.timeframe)\n        new_exitprice = dataframe[\"bollinger_10_upperband\"].iat[-1]\n\n        return new_exitprice\n","position":{"start":{"line":681,"column":1},"end":{"line":707,"column":1}},"key":"GDtSBs1NTN"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"CdtkCIussT"}],"key":"uY7Kkxr4d8"},{"type":"paragraph","position":{"start":{"line":710,"column":1},"end":{"line":710,"column":1}},"children":[{"type":"text","value":"修改入场和出场价格仅适用于限价单。根据选择的价格，这可能导致大量未成交订单。默认情况下，当前价格与自定义价格之间的最大允许距离为 2%，该值可通过配置中的 ","position":{"start":{"line":710,"column":1},"end":{"line":710,"column":1}},"key":"ItogZwkZ8y"},{"type":"inlineCode","value":"custom_price_max_distance_ratio","position":{"start":{"line":710,"column":1},"end":{"line":710,"column":1}},"key":"eBYbsyZoub"},{"type":"text","value":" 参数更改。","position":{"start":{"line":710,"column":1},"end":{"line":710,"column":1}},"key":"szJKwV1h1v"}],"key":"WR3lGOGXeK"},{"type":"paragraph","position":{"start":{"line":712,"column":1},"end":{"line":712,"column":1}},"children":[{"type":"strong","position":{"start":{"line":712,"column":1},"end":{"line":712,"column":1}},"children":[{"type":"text","value":"示例","position":{"start":{"line":712,"column":1},"end":{"line":712,"column":1}},"key":"yTQ3ceVzV1"}],"key":"CS7FKbPVkG"},{"type":"text","value":"：","position":{"start":{"line":712,"column":1},"end":{"line":712,"column":1}},"key":"lz6gVmKzQ7"}],"key":"F0fp4d8EJy"},{"type":"paragraph","position":{"start":{"line":714,"column":1},"end":{"line":714,"column":1}},"children":[{"type":"text","value":"如果 new_entryprice 是 97，proposed_rate 是 100，","position":{"start":{"line":714,"column":1},"end":{"line":714,"column":1}},"key":"ZMu1pGVcYb"},{"type":"inlineCode","value":"custom_price_max_distance_ratio","position":{"start":{"line":714,"column":1},"end":{"line":714,"column":1}},"key":"NDqUVx2LN0"},{"type":"text","value":" 设置为 2%，则保留的有效自定义入场价格将是 98，比当前（建议）价格低 2%。","position":{"start":{"line":714,"column":1},"end":{"line":714,"column":1}},"key":"DUrZzSuB5T"}],"key":"q7Cp6cM9gS"}],"key":"inEQLXh6UP"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"回测","position":{"start":{"line":717,"column":1},"end":{"line":717,"column":1}},"key":"jIOcx9Ioq8"}],"key":"DN6aH3qavg"},{"type":"paragraph","position":{"start":{"line":718,"column":1},"end":{"line":718,"column":1}},"children":[{"type":"text","value":"自定义价格在回测中受支持（自 2021.12 起），如果价格落在 K 线的最高/最低范围内，订单将会成交。","position":{"start":{"line":718,"column":1},"end":{"line":718,"column":1}},"key":"NTUwLGfbI8"}],"key":"yjpPWGKhP6"},{"type":"paragraph","position":{"start":{"line":720,"column":1},"end":{"line":720,"column":1}},"children":[{"type":"text","value":"未能立即成交的订单将受到常规超时处理，这会在每根（详细）K 线发生一次。","position":{"start":{"line":720,"column":1},"end":{"line":720,"column":1}},"key":"GhmZ9kw4ug"}],"key":"l4odInteAZ"},{"type":"paragraph","position":{"start":{"line":722,"column":1},"end":{"line":722,"column":1}},"children":[{"type":"inlineCode","value":"custom_exit_price()","position":{"start":{"line":722,"column":1},"end":{"line":722,"column":1}},"key":"V3xmd4onTV"},{"type":"text","value":" 仅针对类型为 exit_signal、自定义退出和部分退出的卖出调用。所有其他退出类型将使用常规回测价格。","position":{"start":{"line":722,"column":1},"end":{"line":722,"column":1}},"key":"fqFWMCq5u0"}],"key":"vKx81RTN7L"}],"key":"Wezkq9HbuL"},{"type":"thematicBreak","position":{"start":{"line":726,"column":1},"end":{"line":726,"column":1}},"key":"ldnbLNyaTA"},{"type":"heading","depth":3,"position":{"start":{"line":728,"column":1},"end":{"line":728,"column":1}},"children":[{"type":"text","value":"自定义订单超时规则","position":{"start":{"line":728,"column":1},"end":{"line":728,"column":1}},"key":"JqKWDD4YZh"}],"identifier":"id","label":"自定义订单超时规则","html_id":"id-17","implicit":true,"key":"xX9pf2kP1l"},{"type":"paragraph","position":{"start":{"line":730,"column":1},"end":{"line":730,"column":1}},"children":[{"type":"text","value":"简单的、基于时间的订单超时可以通过策略或在配置的 ","position":{"start":{"line":730,"column":1},"end":{"line":730,"column":1}},"key":"s8SSTOmy1y"},{"type":"inlineCode","value":"unfilledtimeout","position":{"start":{"line":730,"column":1},"end":{"line":730,"column":1}},"key":"I4BVpukVPm"},{"type":"text","value":" 部分进行配置。","position":{"start":{"line":730,"column":1},"end":{"line":730,"column":1}},"key":"nSbGvQaqR8"}],"key":"Pm1v7fSsNp"},{"type":"paragraph","position":{"start":{"line":732,"column":1},"end":{"line":732,"column":1}},"children":[{"type":"text","value":"然而，freqtrade 还为两种订单类型提供了自定义回调，允许你基于自定义标准决定订单是否超时。","position":{"start":{"line":732,"column":1},"end":{"line":732,"column":1}},"key":"wp2dgj7Uvy"}],"key":"rhqrOlJtbe"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"zBZpFSyAgB"}],"key":"NwtSq3youx"},{"type":"paragraph","position":{"start":{"line":735,"column":1},"end":{"line":735,"column":1}},"children":[{"type":"text","value":"回测会在订单价格落在 K 线的最高/最低范围内时成交订单。","position":{"start":{"line":735,"column":1},"end":{"line":735,"column":1}},"key":"BCvKz7RujZ"}],"key":"CtzdaXw5rn"},{"type":"paragraph","position":{"start":{"line":737,"column":1},"end":{"line":737,"column":1}},"children":[{"type":"text","value":"以下回调将针对不会立即成交的订单（使用自定义定价）在每个（详细）K 线调用一次。","position":{"start":{"line":737,"column":1},"end":{"line":737,"column":1}},"key":"MYjprsJnT4"}],"key":"Pt1VO0adeb"}],"key":"DjyzbUGPgv"},{"type":"heading","depth":4,"position":{"start":{"line":740,"column":1},"end":{"line":740,"column":1}},"children":[{"type":"text","value":"自定义订单超时示例","position":{"start":{"line":740,"column":1},"end":{"line":740,"column":1}},"key":"xEu57FRKXD"}],"identifier":"id","label":"自定义订单超时示例","html_id":"id-18","implicit":true,"key":"vr1PjtY6bP"},{"type":"paragraph","position":{"start":{"line":742,"column":1},"end":{"line":742,"column":1}},"children":[{"type":"text","value":"对每个未成交订单调用，直到订单成交或取消。","position":{"start":{"line":742,"column":1},"end":{"line":742,"column":1}},"key":"dmlXl9fO3Y"}],"key":"CMpxLPbX7t"},{"type":"paragraph","position":{"start":{"line":744,"column":1},"end":{"line":744,"column":1}},"children":[{"type":"inlineCode","value":"check_entry_timeout()","position":{"start":{"line":744,"column":1},"end":{"line":744,"column":1}},"key":"gvgfeX9dtQ"},{"type":"text","value":" 用于交易入场，而 ","position":{"start":{"line":744,"column":1},"end":{"line":744,"column":1}},"key":"fzDiqgAVOA"},{"type":"inlineCode","value":"check_exit_timeout()","position":{"start":{"line":744,"column":1},"end":{"line":744,"column":1}},"key":"no88NXYirt"},{"type":"text","value":" 用于交易出场订单。","position":{"start":{"line":744,"column":1},"end":{"line":744,"column":1}},"key":"EXPSoGXYiq"}],"key":"BoPIPYZcdu"},{"type":"paragraph","position":{"start":{"line":746,"column":1},"end":{"line":746,"column":1}},"children":[{"type":"text","value":"下面是一个简单的示例，它根据资产价格应用不同的未成交超时。","position":{"start":{"line":746,"column":1},"end":{"line":746,"column":1}},"key":"zJmHIDMb93"}],"key":"Ty79XIbecx"},{"type":"paragraph","position":{"start":{"line":748,"column":1},"end":{"line":748,"column":1}},"children":[{"type":"text","value":"它对高价资产应用较短的超时，而对低价币种允许更长的成交时间。","position":{"start":{"line":748,"column":1},"end":{"line":748,"column":1}},"key":"oV4rTXoUka"}],"key":"l8O6qHE6EI"},{"type":"paragraph","position":{"start":{"line":750,"column":1},"end":{"line":750,"column":1}},"children":[{"type":"text","value":"函数必须返回 ","position":{"start":{"line":750,"column":1},"end":{"line":750,"column":1}},"key":"eL3Dr1OvmD"},{"type":"inlineCode","value":"True","position":{"start":{"line":750,"column":1},"end":{"line":750,"column":1}},"key":"uXjvYjSLP7"},{"type":"text","value":"（取消订单）或 ","position":{"start":{"line":750,"column":1},"end":{"line":750,"column":1}},"key":"wigs0mlvze"},{"type":"inlineCode","value":"False","position":{"start":{"line":750,"column":1},"end":{"line":750,"column":1}},"key":"mUlgTuARqq"},{"type":"text","value":"（保持订单活跃）。","position":{"start":{"line":750,"column":1},"end":{"line":750,"column":1}},"key":"eintAFFsEa"}],"key":"lLxz2EgM0F"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    # 设置 unfilledtimeout 为 25 小时，因为下面的最大超时是 24 小时。\n    unfilledtimeout = {\n        \"entry\": 60 * 25,\n        \"exit\": 60 * 25\n    }\n\n    def check_entry_timeout(self, pair: str, trade: Trade, order: Order,\n                            current_time: datetime, **kwargs) -> bool:\n        if trade.open_rate > 100 and trade.open_date_utc < current_time - timedelta(minutes=5):\n            return True\n        elif trade.open_rate > 10 and trade.open_date_utc < current_time - timedelta(minutes=3):\n            return True\n        elif trade.open_rate < 1 and trade.open_date_utc < current_time - timedelta(hours=24):\n           return True\n        return False\n\n\n    def check_exit_timeout(self, pair: str, trade: Trade, order: Order,\n                           current_time: datetime, **kwargs) -> bool:\n        if trade.open_rate > 100 and trade.open_date_utc < current_time - timedelta(minutes=5):\n            return True\n        elif trade.open_rate > 10 and trade.open_date_utc < current_time - timedelta(minutes=3):\n            return True\n        elif trade.open_rate < 1 and trade.open_date_utc < current_time - timedelta(hours=24):\n           return True\n        return False","position":{"start":{"line":752,"column":1},"end":{"line":785,"column":1}},"key":"psxKlaJQw7"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"RkbXMXw2eD"}],"key":"JYsQC0Cesr"},{"type":"paragraph","position":{"start":{"line":788,"column":1},"end":{"line":788,"column":1}},"children":[{"type":"text","value":"对于上面的示例，","position":{"start":{"line":788,"column":1},"end":{"line":788,"column":1}},"key":"COytuAsU8m"},{"type":"inlineCode","value":"unfilledtimeout","position":{"start":{"line":788,"column":1},"end":{"line":788,"column":1}},"key":"fT9XIBAufJ"},{"type":"text","value":" 必须设置为大于 24 小时的值，否则该类型的超时将首先应用。","position":{"start":{"line":788,"column":1},"end":{"line":788,"column":1}},"key":"z56k7PFA6T"}],"key":"SVPO5G1k2e"}],"key":"APwgdemNdx"},{"type":"heading","depth":4,"position":{"start":{"line":791,"column":1},"end":{"line":791,"column":1}},"children":[{"type":"text","value":"自定义订单超时示例（使用额外数据）","position":{"start":{"line":791,"column":1},"end":{"line":791,"column":1}},"key":"jGZpn53Ggh"}],"identifier":"id","label":"自定义订单超时示例（使用额外数据）","html_id":"id-19","implicit":true,"key":"K6mDROTfKy"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    # 设置 unfilledtimeout 为 25 小时，因为下面的最大超时是 24 小时。\n    unfilledtimeout = {\n        \"entry\": 60 * 25,\n        \"exit\": 60 * 25\n    }\n\n    def check_entry_timeout(self, pair: str, trade: Trade, order: Order,\n                            current_time: datetime, **kwargs) -> bool:\n        ob = self.dp.orderbook(pair, 1)\n        current_price = ob[\"bids\"][0][0]\n        # 如果价格比订单价格高出 2% 以上，取消买单。\n        if current_price > order.price * 1.02:\n            return True\n        return False\n\n\n    def check_exit_timeout(self, pair: str, trade: Trade, order: Order,\n                           current_time: datetime, **kwargs) -> bool:\n        ob = self.dp.orderbook(pair, 1)\n        current_price = ob[\"asks\"][0][0]\n        # 如果价格比订单价格低 2% 以上，取消卖单。\n        if current_price < order.price * 0.98:\n            return True\n        return False","position":{"start":{"line":793,"column":1},"end":{"line":824,"column":1}},"key":"SzOIsXdemY"},{"type":"thematicBreak","position":{"start":{"line":826,"column":1},"end":{"line":826,"column":1}},"key":"tAA9RhjywX"},{"type":"heading","depth":3,"position":{"start":{"line":828,"column":1},"end":{"line":828,"column":1}},"children":[{"type":"text","value":"机器人订单确认","position":{"start":{"line":828,"column":1},"end":{"line":828,"column":1}},"key":"NTxhijBrim"}],"identifier":"id","label":"机器人订单确认","html_id":"id-20","implicit":true,"key":"GcsmZMb7pZ"},{"type":"paragraph","position":{"start":{"line":830,"column":1},"end":{"line":831,"column":1}},"children":[{"type":"text","value":"确认交易入场/出场。\n这些是在订单下单之前最后调用的方法。","position":{"start":{"line":830,"column":1},"end":{"line":830,"column":1}},"key":"ptkLiRoJpr"}],"key":"dbo3cQQNRL"},{"type":"heading","depth":4,"position":{"start":{"line":833,"column":1},"end":{"line":833,"column":1}},"children":[{"type":"text","value":"交易入场（买单）确认","position":{"start":{"line":833,"column":1},"end":{"line":833,"column":1}},"key":"S1mPmgxsCU"}],"identifier":"id","label":"交易入场（买单）确认","html_id":"id-21","implicit":true,"key":"jcJFPuCBLf"},{"type":"paragraph","position":{"start":{"line":835,"column":1},"end":{"line":835,"column":1}},"children":[{"type":"inlineCode","value":"confirm_trade_entry()","position":{"start":{"line":835,"column":1},"end":{"line":835,"column":1}},"key":"XhWvV9tWn4"},{"type":"text","value":" 可用于在最后一刻中止交易入场（可能是因为价格不符合预期）。","position":{"start":{"line":835,"column":1},"end":{"line":835,"column":1}},"key":"jDg0TEfA42"}],"key":"MM21jpn147"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    def confirm_trade_entry(self, pair: str, order_type: str, amount: float, rate: float,\n                            time_in_force: str, current_time: datetime, entry_tag: str | None,\n                            side: str, **kwargs) -> bool:\n        \"\"\"\n        Called right before placing a entry order.\n        Timing for this function is critical, so avoid doing heavy computations or\n        network requests in this method.\n\n        For full documentation please go to https://www.freqtrade.io/en/latest/strategy-advanced/\n\n        When not implemented by a strategy, returns True (always confirming).\n\n        :param pair: Pair that's about to be bought/shorted.\n        :param order_type: Order type (as configured in order_types). usually limit or market.\n        :param amount: Amount in target (base) currency that's going to be traded.\n        :param rate: Rate that's going to be used when using limit orders \n                     or current rate for market orders.\n        :param time_in_force: Time in force. Defaults to GTC (Good-til-cancelled).\n        :param current_time: datetime object, containing the current datetime\n        :param entry_tag: Optional entry_tag (buy_tag) if provided with the buy signal.\n        :param side: \"long\" or \"short\" - indicating the direction of the proposed trade\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        :return bool: When True is returned, then the buy-order is placed on the exchange.\n            False aborts the process\n        \"\"\"\n        return True\n","position":{"start":{"line":837,"column":1},"end":{"line":871,"column":1}},"key":"ZsXpFR5hDI"},{"type":"heading","depth":4,"position":{"start":{"line":873,"column":1},"end":{"line":873,"column":1}},"children":[{"type":"text","value":"交易出场（卖单）确认","position":{"start":{"line":873,"column":1},"end":{"line":873,"column":1}},"key":"WVGXO3A3IQ"}],"identifier":"id","label":"交易出场（卖单）确认","html_id":"id-22","implicit":true,"key":"r3LHvr3BxI"},{"type":"paragraph","position":{"start":{"line":875,"column":1},"end":{"line":875,"column":1}},"children":[{"type":"inlineCode","value":"confirm_trade_exit()","position":{"start":{"line":875,"column":1},"end":{"line":875,"column":1}},"key":"CYdugjCb4W"},{"type":"text","value":" 可用于在最后一刻中止交易出场（可能是因为价格不符合预期）。","position":{"start":{"line":875,"column":1},"end":{"line":875,"column":1}},"key":"vZSkhqUnRw"}],"key":"V88MXkAkt8"},{"type":"paragraph","position":{"start":{"line":877,"column":1},"end":{"line":878,"column":1}},"children":[{"type":"inlineCode","value":"confirm_trade_exit()","position":{"start":{"line":877,"column":1},"end":{"line":877,"column":1}},"key":"Tun5DyMFr3"},{"type":"text","value":" 可能会在同一迭代中多次调用同一交易，如果适用不同的退出原因。\n退出原因（如果适用）将按以下顺序排列：","position":{"start":{"line":877,"column":1},"end":{"line":877,"column":1}},"key":"oKE1zHIGqy"}],"key":"DjCf3aQZKH"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":880,"column":1},"end":{"line":884,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":880,"column":1},"end":{"line":880,"column":1}},"children":[{"type":"inlineCode","value":"exit_signal","position":{"start":{"line":880,"column":1},"end":{"line":880,"column":1}},"key":"KfAEqWOLay"},{"type":"text","value":" / ","position":{"start":{"line":880,"column":1},"end":{"line":880,"column":1}},"key":"OU042Z4F9J"},{"type":"inlineCode","value":"custom_exit","position":{"start":{"line":880,"column":1},"end":{"line":880,"column":1}},"key":"jt8InEOfQW"}],"key":"Ck8oj9wYJq"},{"type":"listItem","spread":true,"position":{"start":{"line":881,"column":1},"end":{"line":881,"column":1}},"children":[{"type":"inlineCode","value":"stop_loss","position":{"start":{"line":881,"column":1},"end":{"line":881,"column":1}},"key":"qfxGck5nKJ"}],"key":"bQCdP2vG8m"},{"type":"listItem","spread":true,"position":{"start":{"line":882,"column":1},"end":{"line":882,"column":1}},"children":[{"type":"inlineCode","value":"roi","position":{"start":{"line":882,"column":1},"end":{"line":882,"column":1}},"key":"jZkiEK3Wrx"}],"key":"mQeiCVdDQb"},{"type":"listItem","spread":true,"position":{"start":{"line":883,"column":1},"end":{"line":884,"column":1}},"children":[{"type":"inlineCode","value":"trailing_stop_loss","position":{"start":{"line":883,"column":1},"end":{"line":883,"column":1}},"key":"zSjz6ux4jb"}],"key":"WG4rWY6CkG"}],"key":"sWWWXmBGlZ"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    def confirm_trade_exit(self, pair: str, trade: Trade, order_type: str, amount: float,\n                           rate: float, time_in_force: str, exit_reason: str,\n                           current_time: datetime, **kwargs) -> bool:\n        \"\"\"\n        Called right before placing a regular exit order.\n        Timing for this function is critical, so avoid doing heavy computations or\n        network requests in this method.\n\n        For full documentation please go to https://www.freqtrade.io/en/latest/strategy-advanced/\n\n        When not implemented by a strategy, returns True (always confirming).\n\n        :param pair: Pair for trade that's about to be exited.\n        :param trade: trade object.\n        :param order_type: Order type (as configured in order_types). usually limit or market.\n        :param amount: Amount in base currency.\n        :param rate: Rate that's going to be used when using limit orders\n                     or current rate for market orders.\n        :param time_in_force: Time in force. Defaults to GTC (Good-til-cancelled).\n        :param exit_reason: Exit reason.\n            Can be any of [\"roi\", \"stop_loss\", \"stoploss_on_exchange\", \"trailing_stop_loss\",\n                           \"exit_signal\", \"force_exit\", \"emergency_exit\"]\n        :param current_time: datetime object, containing the current datetime\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        :return bool: When True, then the exit-order is placed on the exchange.\n            False aborts the process\n        \"\"\"\n        if exit_reason == \"force_exit\" and trade.calc_profit_ratio(rate) < 0:\n            # Reject force-sells with negative profit\n            # This is just a sample, please adjust to your needs\n            # (this does not necessarily make sense, assuming you know when you're force-selling)\n            return False\n        return True\n","position":{"start":{"line":885,"column":1},"end":{"line":926,"column":1}},"key":"bXkmUY0uU9"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"XpfTU89FQt"}],"key":"BR7xDFBUfq"},{"type":"paragraph","position":{"start":{"line":929,"column":1},"end":{"line":929,"column":1}},"children":[{"type":"inlineCode","value":"confirm_trade_exit()","position":{"start":{"line":929,"column":1},"end":{"line":929,"column":1}},"key":"JaO3V5QD9p"},{"type":"text","value":" 可以阻止止损退出，导致重大损失，因为这将忽略止损退出。","position":{"start":{"line":929,"column":1},"end":{"line":929,"column":1}},"key":"vWMcTr0zET"}],"key":"pVF6B0iJJl"},{"type":"paragraph","position":{"start":{"line":931,"column":1},"end":{"line":931,"column":1}},"children":[{"type":"inlineCode","value":"confirm_trade_exit()","position":{"start":{"line":931,"column":1},"end":{"line":931,"column":1}},"key":"KGDFbLVRUH"},{"type":"text","value":" 不会为清算调用 - 因为清算是由交易所强制执行的，因此无法拒绝。","position":{"start":{"line":931,"column":1},"end":{"line":931,"column":1}},"key":"LmZMSz0kSe"}],"key":"tlrXuIPXZh"}],"key":"BzG65yppJG"},{"type":"heading","depth":3,"position":{"start":{"line":936,"column":1},"end":{"line":936,"column":1}},"children":[{"type":"text","value":"调整交易仓位","position":{"start":{"line":936,"column":1},"end":{"line":936,"column":1}},"key":"DvIg6QqkkV"}],"label":"adjust-trade-position","identifier":"adjust-trade-position","html_id":"adjust-trade-position","key":"nCLIkvKeDH"},{"type":"paragraph","position":{"start":{"line":938,"column":1},"end":{"line":940,"column":1}},"children":[{"type":"inlineCode","value":"position_adjustment_enable","position":{"start":{"line":938,"column":1},"end":{"line":938,"column":1}},"key":"a8qTuHvg7a"},{"type":"text","value":" 策略属性启用了策略中 ","position":{"start":{"line":938,"column":1},"end":{"line":938,"column":1}},"key":"mbKgNPqkaC"},{"type":"inlineCode","value":"adjust_trade_position()","position":{"start":{"line":938,"column":1},"end":{"line":938,"column":1}},"key":"i9ez3yOH0B"},{"type":"text","value":" 回调的使用。\n出于性能原因，默认情况下它是禁用的，如果启用，freqtrade 将在启动时显示警告消息。\n","position":{"start":{"line":938,"column":1},"end":{"line":938,"column":1}},"key":"YmwjxdqTDj"},{"type":"inlineCode","value":"adjust_trade_position()","position":{"start":{"line":938,"column":1},"end":{"line":938,"column":1}},"key":"sb7txEFfHG"},{"type":"text","value":" 可用于执行额外的订单，例如使用 DCA（美元成本平均）管理风险或增加或减少仓位。","position":{"start":{"line":938,"column":1},"end":{"line":938,"column":1}},"key":"oJBmPXe2vV"}],"key":"sGqyolajxn"},{"type":"paragraph","position":{"start":{"line":942,"column":1},"end":{"line":942,"column":1}},"children":[{"type":"text","value":"额外订单也会导致额外费用，并且这些订单不计入 ","position":{"start":{"line":942,"column":1},"end":{"line":942,"column":1}},"key":"eZqG4Kdiv4"},{"type":"inlineCode","value":"max_open_trades","position":{"start":{"line":942,"column":1},"end":{"line":942,"column":1}},"key":"UpGBoAhNp7"},{"type":"text","value":"。","position":{"start":{"line":942,"column":1},"end":{"line":942,"column":1}},"key":"LOHpLEwEJJ"}],"key":"QgdrnCdv7c"},{"type":"paragraph","position":{"start":{"line":944,"column":1},"end":{"line":944,"column":1}},"children":[{"type":"text","value":"当有未成交订单（买单或卖单）等待执行时，也会调用此回调 - 如果数量、价格或方向不同，将取消现有的未成交订单以放置新订单。部分成交的订单也将被取消，并将被回调返回的新数量替换。","position":{"start":{"line":944,"column":1},"end":{"line":944,"column":1}},"key":"nRQFUadbfK"}],"key":"pUtZSOsUjB"},{"type":"paragraph","position":{"start":{"line":946,"column":1},"end":{"line":946,"column":1}},"children":[{"type":"inlineCode","value":"adjust_trade_position()","position":{"start":{"line":946,"column":1},"end":{"line":946,"column":1}},"key":"uBLUuNnB84"},{"type":"text","value":" 在交易期间非常频繁地被调用，因此你必须尽可能保持实现的性能。","position":{"start":{"line":946,"column":1},"end":{"line":946,"column":1}},"key":"Ea7OXJWF7i"}],"key":"YtsXowDZKy"},{"type":"paragraph","position":{"start":{"line":948,"column":1},"end":{"line":949,"column":1}},"children":[{"type":"text","value":"仓位调整将始终应用于交易的方向，因此正值将始终增加你的仓位（负值将减少你的仓位），无论它是多头还是空头交易。\n调整订单可以通过返回一个 2 元素元组来分配标签，第一个元素是调整数量，第二个元素是标签（例如 ","position":{"start":{"line":948,"column":1},"end":{"line":948,"column":1}},"key":"bY6fU65Qqy"},{"type":"inlineCode","value":"return 250, \"increase_favorable_conditions\"","position":{"start":{"line":948,"column":1},"end":{"line":948,"column":1}},"key":"biGfDOexbM"},{"type":"text","value":"）。","position":{"start":{"line":948,"column":1},"end":{"line":948,"column":1}},"key":"t7KICmiwR6"}],"key":"U0X4FCuGKr"},{"type":"paragraph","position":{"start":{"line":951,"column":1},"end":{"line":951,"column":1}},"children":[{"type":"text","value":"无法修改杠杆，返回的仓位金额假定为应用杠杆之前。","position":{"start":{"line":951,"column":1},"end":{"line":951,"column":1}},"key":"S0GDBwJXHV"}],"key":"CXwJJfWVcU"},{"type":"paragraph","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"children":[{"type":"text","value":"当前分配给仓位的组合仓位金额保存在 ","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"key":"t2FWxhca2E"},{"type":"inlineCode","value":"trade.stake_amount","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"key":"BWUHREAMfz"},{"type":"text","value":" 中。因此，","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"key":"wqZgtrrUE3"},{"type":"inlineCode","value":"trade.stake_amount","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"key":"OO5A2Dxdp3"},{"type":"text","value":" 将在每次通过 ","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"key":"t2XB7pydRr"},{"type":"inlineCode","value":"adjust_trade_position()","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"key":"u9ki8Q6U43"},{"type":"text","value":" 进行额外入场和部分出场时更新。","position":{"start":{"line":953,"column":1},"end":{"line":953,"column":1}},"key":"potMBpnu9g"}],"key":"P5g1vZwyp3"},{"type":"admonition","kind":"danger","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"松散逻辑","position":{"start":{"line":955,"column":1},"end":{"line":955,"column":1}},"key":"KLiaXbmYE8"}],"key":"lHTtbTc0OC"},{"type":"paragraph","position":{"start":{"line":956,"column":1},"end":{"line":956,"column":1}},"children":[{"type":"text","value":"在模拟和实盘运行中，此函数将每 ","position":{"start":{"line":956,"column":1},"end":{"line":956,"column":1}},"key":"ZV04NZLxTR"},{"type":"inlineCode","value":"throttle_process_secs","position":{"start":{"line":956,"column":1},"end":{"line":956,"column":1}},"key":"XbIxYeHzro"},{"type":"text","value":"（默认为 5 秒）调用一次。如果你有松散的逻辑（例如，如果最后一根 K 线的 RSI 低于 30，则增加仓位），你的机器人将每 5 秒进行一次额外重新入场，直到你用完资金，达到 ","position":{"start":{"line":956,"column":1},"end":{"line":956,"column":1}},"key":"RUw2cUpLCF"},{"type":"inlineCode","value":"max_position_adjustment","position":{"start":{"line":956,"column":1},"end":{"line":956,"column":1}},"key":"hQo20t7rlT"},{"type":"text","value":" 限制，或者出现 RSI 大于 30 的新 K 线。","position":{"start":{"line":956,"column":1},"end":{"line":956,"column":1}},"key":"x7oRDX5FHy"}],"key":"OfmKd6Zcdg"},{"type":"paragraph","position":{"start":{"line":958,"column":1},"end":{"line":958,"column":1}},"children":[{"type":"text","value":"部分出场也可能发生同样的情况。","position":{"start":{"line":958,"column":1},"end":{"line":958,"column":1}},"key":"AnBw5PgQGZ"}],"key":"qdlvgsXLyQ"},{"type":"paragraph","position":{"start":{"line":960,"column":1},"end":{"line":960,"column":1}},"children":[{"type":"text","value":"因此，请确保有严格的逻辑和/或检查最后成交的订单以及是否已有未成交订单。","position":{"start":{"line":960,"column":1},"end":{"line":960,"column":1}},"key":"ihtYaUdL4m"}],"key":"BKALpOVLfL"}],"key":"Laia3aWNoi"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"多次仓位调整的性能","position":{"start":{"line":963,"column":1},"end":{"line":963,"column":1}},"key":"WsXSezydHw"}],"key":"ncVO1GP3su"},{"type":"paragraph","position":{"start":{"line":964,"column":1},"end":{"line":964,"column":1}},"children":[{"type":"text","value":"仓位调整可以是增加策略输出的好方法 - 但如果广泛使用此功能，也可能有缺点。","position":{"start":{"line":964,"column":1},"end":{"line":964,"column":1}},"key":"bsNqjcB6TE"}],"key":"uSr3N1Q2Qu"},{"type":"paragraph","position":{"start":{"line":966,"column":1},"end":{"line":966,"column":1}},"children":[{"type":"text","value":"每个订单将在交易期间附加到交易对象 - 因此增加内存使用。","position":{"start":{"line":966,"column":1},"end":{"line":966,"column":1}},"key":"qkqav3avnc"}],"key":"Wa45GGBNgL"},{"type":"paragraph","position":{"start":{"line":968,"column":1},"end":{"line":968,"column":1}},"children":[{"type":"text","value":"因此，不建议使用长时间持续和 10 次甚至 100 次仓位调整的交易，应该定期关闭以避免影响性能。","position":{"start":{"line":968,"column":1},"end":{"line":968,"column":1}},"key":"gHfay00M5B"}],"key":"pe40IWQgJ0"}],"key":"BDmpN90gmY"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"回测","position":{"start":{"line":971,"column":1},"end":{"line":971,"column":1}},"key":"P7JvGgW2tl"}],"key":"XvO3xVSyNN"},{"type":"paragraph","position":{"start":{"line":972,"column":1},"end":{"line":972,"column":1}},"children":[{"type":"text","value":"在回测期间，此回调在 ","position":{"start":{"line":972,"column":1},"end":{"line":972,"column":1}},"key":"afgArKOkJ2"},{"type":"inlineCode","value":"timeframe","position":{"start":{"line":972,"column":1},"end":{"line":972,"column":1}},"key":"pYsXUU6Ttn"},{"type":"text","value":" 或 ","position":{"start":{"line":972,"column":1},"end":{"line":972,"column":1}},"key":"ytsUbrGkUS"},{"type":"inlineCode","value":"timeframe_detail","position":{"start":{"line":972,"column":1},"end":{"line":972,"column":1}},"key":"tOg9eKf4tX"},{"type":"text","value":" 中的每根 K 线调用一次，因此运行时性能将受到影响。","position":{"start":{"line":972,"column":1},"end":{"line":972,"column":1}},"key":"gyC9OjnuLH"}],"key":"N2f6uUm9V7"},{"type":"paragraph","position":{"start":{"line":974,"column":1},"end":{"line":974,"column":1}},"children":[{"type":"text","value":"这也可能导致实盘和回测之间的结果不同，因为回测只能在每根 K 线调整一次交易，而实盘可以在每根 K 线多次调整交易。","position":{"start":{"line":974,"column":1},"end":{"line":974,"column":1}},"key":"gXH4JfgnRg"}],"key":"if4gQffoAi"}],"key":"v7gXXt5YMQ"},{"type":"heading","depth":4,"position":{"start":{"line":977,"column":1},"end":{"line":977,"column":1}},"children":[{"type":"text","value":"增加仓位","position":{"start":{"line":977,"column":1},"end":{"line":977,"column":1}},"key":"JHfM9l22AB"}],"identifier":"id","label":"增加仓位","html_id":"id-23","implicit":true,"key":"nDgjU37m18"},{"type":"paragraph","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"children":[{"type":"text","value":"当需要进行额外入场订单时（即增加仓位——多头为买单，空头为卖单），策略应返回一个介于 ","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"key":"DC24rF0n46"},{"type":"inlineCode","value":"min_stake","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"key":"mwmwnmsozU"},{"type":"text","value":" 和 ","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"key":"ZTl3qaAPCz"},{"type":"inlineCode","value":"max_stake","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"key":"OPKBt7wCNv"},{"type":"text","value":" 之间的正数 ","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"key":"A7dc6mVoLi"},{"type":"strong","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"children":[{"type":"text","value":"stake_amount","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"key":"mXg5qSiqbg"}],"key":"i9sbf890da"},{"type":"text","value":"（以仓位货币计价）。","position":{"start":{"line":979,"column":1},"end":{"line":979,"column":1}},"key":"tIf39IEBee"}],"key":"XSKsqUfFK5"},{"type":"paragraph","position":{"start":{"line":981,"column":1},"end":{"line":982,"column":1}},"children":[{"type":"text","value":"如果钱包中没有足够的资金（返回值高于 ","position":{"start":{"line":981,"column":1},"end":{"line":981,"column":1}},"key":"bI5OwiM3Aj"},{"type":"inlineCode","value":"max_stake","position":{"start":{"line":981,"column":1},"end":{"line":981,"column":1}},"key":"QAW6n1Z2MB"},{"type":"text","value":"），则该信号会被忽略。\n","position":{"start":{"line":981,"column":1},"end":{"line":981,"column":1}},"key":"hI3qPr1CRb"},{"type":"inlineCode","value":"max_entry_position_adjustment","position":{"start":{"line":981,"column":1},"end":{"line":981,"column":1}},"key":"zZrMQqU4sA"},{"type":"text","value":" 属性用于限制机器人每笔交易（在首次入场订单之外）可执行的额外入场次数。默认值为 -1，表示机器人对调整入场次数没有限制。","position":{"start":{"line":981,"column":1},"end":{"line":981,"column":1}},"key":"Gl8gtHXqfL"}],"key":"fzm4xBIX2u"},{"type":"paragraph","position":{"start":{"line":984,"column":1},"end":{"line":984,"column":1}},"children":[{"type":"text","value":"一旦达到你在 ","position":{"start":{"line":984,"column":1},"end":{"line":984,"column":1}},"key":"bNKF31b77g"},{"type":"inlineCode","value":"max_entry_position_adjustment","position":{"start":{"line":984,"column":1},"end":{"line":984,"column":1}},"key":"LCgHRhEbQi"},{"type":"text","value":" 上设置的最大额外入场次数，额外入场将被忽略，但回调仍会被调用以寻找部分出场机会。","position":{"start":{"line":984,"column":1},"end":{"line":984,"column":1}},"key":"CQuhudj45V"}],"key":"BxTKUSxiCN"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"关于仓位大小","position":{"start":{"line":986,"column":1},"end":{"line":986,"column":1}},"key":"FqMK7i0vpB"}],"key":"S4nVYatGh3"},{"type":"paragraph","position":{"start":{"line":987,"column":1},"end":{"line":987,"column":1}},"children":[{"type":"text","value":"使用固定仓位大小意味着首次订单将使用该金额，就像没有仓位调整一样。","position":{"start":{"line":987,"column":1},"end":{"line":987,"column":1}},"key":"tlEjHm7nEq"}],"key":"xhGL7ekwio"},{"type":"paragraph","position":{"start":{"line":989,"column":1},"end":{"line":989,"column":1}},"children":[{"type":"text","value":"如果你希望通过 DCA 进行额外买入，请确保钱包中留有足够的资金。","position":{"start":{"line":989,"column":1},"end":{"line":989,"column":1}},"key":"yNXOqQE13K"}],"key":"jm64AEfbIv"},{"type":"paragraph","position":{"start":{"line":991,"column":1},"end":{"line":991,"column":1}},"children":[{"type":"text","value":"对 DCA 订单使用 “unlimited” 仓位金额时，需要你实现 ","position":{"start":{"line":991,"column":1},"end":{"line":991,"column":1}},"key":"LW21GRVHuu"},{"type":"inlineCode","value":"custom_stake_amount()","position":{"start":{"line":991,"column":1},"end":{"line":991,"column":1}},"key":"DpesnPvC1P"},{"type":"text","value":" 回调，以避免初始订单占用全部资金。","position":{"start":{"line":991,"column":1},"end":{"line":991,"column":1}},"key":"hJwdYexnPW"}],"key":"cMXUb19BPI"}],"key":"XR9vpxVkbs"},{"type":"heading","depth":4,"position":{"start":{"line":994,"column":1},"end":{"line":994,"column":1}},"children":[{"type":"text","value":"减少仓位","position":{"start":{"line":994,"column":1},"end":{"line":994,"column":1}},"key":"o7lUa2LgvG"}],"identifier":"id","label":"减少仓位","html_id":"id-24","implicit":true,"key":"XRbxHmOXs6"},{"type":"paragraph","position":{"start":{"line":996,"column":1},"end":{"line":996,"column":1}},"children":[{"type":"text","value":"策略应返回一个负的 stake_amount（以仓位货币计价）用于部分出场。","position":{"start":{"line":996,"column":1},"end":{"line":996,"column":1}},"key":"NJuWgQl5iy"}],"key":"Q62e89BaNJ"},{"type":"paragraph","position":{"start":{"line":998,"column":1},"end":{"line":998,"column":1}},"children":[{"type":"text","value":"返回当前持有的全部仓位（","position":{"start":{"line":998,"column":1},"end":{"line":998,"column":1}},"key":"htoHwlf16L"},{"type":"inlineCode","value":"-trade.stake_amount","position":{"start":{"line":998,"column":1},"end":{"line":998,"column":1}},"key":"oVDovEPwYX"},{"type":"text","value":"）将导致完全出场。","position":{"start":{"line":998,"column":1},"end":{"line":998,"column":1}},"key":"TD4YMVZYGS"}],"key":"ib4iRlef6c"},{"type":"paragraph","position":{"start":{"line":1000,"column":1},"end":{"line":1000,"column":1}},"children":[{"type":"text","value":"返回超过上述值（即剩余 stake_amount 变为负数）将导致机器人忽略该信号。","position":{"start":{"line":1000,"column":1},"end":{"line":1000,"column":1}},"key":"HNdLEQvTJu"}],"key":"h8zA7FIDsx"},{"type":"paragraph","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"children":[{"type":"text","value":"对于部分出场，重要的是要知道用于计算部分出场订单币种数量的公式是 ","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"pxz0ks1Skw"},{"type":"inlineCode","value":"部分出场数量 = negative_stake_amount * trade.amount / trade.stake_amount","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"qu3OVaKb1K"},{"type":"text","value":"，其中 ","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"SvwRQoievq"},{"type":"inlineCode","value":"negative_stake_amount","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"NTLtLKsIB8"},{"type":"text","value":" 是 ","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"emsdl7ZJ47"},{"type":"inlineCode","value":"adjust_trade_position","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"GzaNWITtpl"},{"type":"text","value":" 函数返回的值。正如公式所示，该公式与当前仓位盈亏无关，只与 ","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"jQVUuhz29N"},{"type":"inlineCode","value":"trade.amount","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"zaCOodErsB"},{"type":"text","value":" 和 ","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"wkTbTNzCm6"},{"type":"inlineCode","value":"trade.stake_amount","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"JSjWGeVVGn"},{"type":"text","value":" 有关，这两个值不会受到价格波动影响。","position":{"start":{"line":1002,"column":1},"end":{"line":1002,"column":1}},"key":"QAgOQ5sRtQ"}],"key":"ckqdDNLxPi"},{"type":"paragraph","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"children":[{"type":"text","value":"例如，假设你以 50 的开盘价买入 2 个 SHITCOIN/USDT，意味着该交易的仓位金额为 100 USDT。现在价格涨到 200，你想卖出一半。这时你需要返回 ","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"key":"gR42eo9UHO"},{"type":"inlineCode","value":"trade.stake_amount","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"key":"IDzYVHywd9"},{"type":"text","value":" 的 -50%（0.5 * 100 USDT），即 -50。机器人会计算需要卖出的数量，即 ","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"key":"yxBnIVpPmc"},{"type":"inlineCode","value":"50 * 2 / 100","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"key":"FPFqQ2j55S"},{"type":"text","value":"，等于 1 个 SHITCOIN/USDT。如果你返回 -200（2 * 200 的 50%），机器人会忽略，因为 ","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"key":"fyH95AKpGS"},{"type":"inlineCode","value":"trade.stake_amount","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"key":"vXc1pPKWzs"},{"type":"text","value":" 只有 100 USDT，而你要求卖出 200 USDT，相当于卖出 4 个 SHITCOIN/USDT。","position":{"start":{"line":1004,"column":1},"end":{"line":1004,"column":1}},"key":"NfInUrONum"}],"key":"TlURM4vU4A"},{"type":"paragraph","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"children":[{"type":"text","value":"回到上面的例子，当前价格为 200，你的交易当前 USDT 价值为 400 USDT。假设你想部分卖出 100 USDT，以取回初始投资并将利润留在交易中，希望价格继续上涨。这时你需要先计算要卖出的确切数量。由于你想按当前价格卖出价值 100 USDT 的币，部分卖出的确切数量为 ","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"key":"M7x0ACczZq"},{"type":"inlineCode","value":"100 * 2 / 400","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"key":"JxIk1Gu8bK"},{"type":"text","value":"，等于 0.5 个 SHITCOIN/USDT。既然知道了要卖出的数量（0.5），你在 ","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"key":"RxGlpW1eWb"},{"type":"inlineCode","value":"adjust_trade_position","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"key":"Q83h7CKEu5"},{"type":"text","value":" 函数中需要返回的值是 ","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"key":"L1SgudYEr0"},{"type":"inlineCode","value":"-部分出场数量 * trade.stake_amount / trade.amount","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"key":"B64hVMWdD0"},{"type":"text","value":"，即 -25。机器人会卖出 0.5 个 SHITCOIN/USDT，交易中保留 1.5 个。你将从部分出场中获得 100 USDT。","position":{"start":{"line":1006,"column":1},"end":{"line":1006,"column":1}},"key":"NcsoelquZr"}],"key":"DcZlNFBCgo"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"止损计算","position":{"start":{"line":1008,"column":1},"end":{"line":1008,"column":1}},"key":"s9AxTEgjpl"}],"key":"OpQ9WlvFhH"},{"type":"paragraph","position":{"start":{"line":1010,"column":1},"end":{"line":1010,"column":1}},"children":[{"type":"text","value":"止损仍然以初始开仓价为基准计算，而不是均价。","position":{"start":{"line":1010,"column":1},"end":{"line":1010,"column":1}},"key":"E2k8ZugE3n"}],"key":"Zvj7o1lXzc"},{"type":"paragraph","position":{"start":{"line":1012,"column":1},"end":{"line":1012,"column":1}},"children":[{"type":"text","value":"常规止损规则仍然适用（不能下移止损）。","position":{"start":{"line":1012,"column":1},"end":{"line":1012,"column":1}},"key":"xrB0o4xdUq"}],"key":"de9kdkqGr2"},{"type":"paragraph","position":{"start":{"line":1014,"column":1},"end":{"line":1014,"column":1}},"children":[{"type":"text","value":"虽然 ","position":{"start":{"line":1014,"column":1},"end":{"line":1014,"column":1}},"key":"Kb2V99QCSR"},{"type":"inlineCode","value":"/stopentry","position":{"start":{"line":1014,"column":1},"end":{"line":1014,"column":1}},"key":"o36JWXw8va"},{"type":"text","value":" 命令会阻止机器人进入新交易，但仓位调整功能会继续在已有交易上买入新订单。","position":{"start":{"line":1014,"column":1},"end":{"line":1014,"column":1}},"key":"wV0KHSV5NL"}],"key":"sOyFDP212b"}],"key":"wOaf0OSteA"},{"type":"code","lang":"python","value":"# Default imports\n\nclass DigDeeperStrategy(IStrategy):\n\n    position_adjustment_enable = True\n\n    # Attempts to handle large drops with DCA. High stoploss is required.\n    stoploss = -0.30\n\n    # ... populate_* methods\n\n    # Example specific variables\n    max_entry_position_adjustment = 3\n    # This number is explained a bit further down\n    max_dca_multiplier = 5.5\n\n    # This is called when placing the initial order (opening trade)\n    def custom_stake_amount(self, pair: str, current_time: datetime, current_rate: float,\n                            proposed_stake: float, min_stake: float | None, max_stake: float,\n                            leverage: float, entry_tag: str | None, side: str,\n                            **kwargs) -> float:\n\n        # We need to leave most of the funds for possible further DCA orders\n        # This also applies to fixed stakes\n        return proposed_stake / self.max_dca_multiplier\n\n    def adjust_trade_position(self, trade: Trade, current_time: datetime,\n                              current_rate: float, current_profit: float,\n                              min_stake: float | None, max_stake: float,\n                              current_entry_rate: float, current_exit_rate: float,\n                              current_entry_profit: float, current_exit_profit: float,\n                              **kwargs\n                              ) -> float | None | tuple[float | None, str | None]:\n        \"\"\"\n        Custom trade adjustment logic, returning the stake amount that a trade should be\n        increased or decreased.\n        This means extra entry or exit orders with additional fees.\n        Only called when `position_adjustment_enable` is set to True.\n\n        For full documentation please go to https://www.freqtrade.io/en/latest/strategy-advanced/\n\n        When not implemented by a strategy, returns None\n\n        :param trade: trade object.\n        :param current_time: datetime object, containing the current datetime\n        :param current_rate: Current entry rate (same as current_entry_profit)\n        :param current_profit: Current profit (as ratio), calculated based on current_rate \n                               (same as current_entry_profit).\n        :param min_stake: Minimal stake size allowed by exchange (for both entries and exits)\n        :param max_stake: Maximum stake allowed (either through balance, or by exchange limits).\n        :param current_entry_rate: Current rate using entry pricing.\n        :param current_exit_rate: Current rate using exit pricing.\n        :param current_entry_profit: Current profit using entry pricing.\n        :param current_exit_profit: Current profit using exit pricing.\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        :return float: Stake amount to adjust your trade,\n                       Positive values to increase position, Negative values to decrease position.\n                       Return None for no action.\n                       Optionally, return a tuple with a 2nd element with an order reason\n        \"\"\"\n        if trade.has_open_orders:\n            # Only act if no orders are open\n            return\n\n        if current_profit > 0.05 and trade.nr_of_successful_exits == 0:\n            # Take half of the profit at +5%\n            return -(trade.stake_amount / 2), \"half_profit_5%\"\n\n        if current_profit > -0.05:\n            return None\n\n        # Obtain pair dataframe (just to show how to access it)\n        dataframe, _ = self.dp.get_analyzed_dataframe(trade.pair, self.timeframe)\n        # Only buy when not actively falling price.\n        last_candle = dataframe.iloc[-1].squeeze()\n        previous_candle = dataframe.iloc[-2].squeeze()\n        if last_candle[\"close\"] < previous_candle[\"close\"]:\n            return None\n\n        filled_entries = trade.select_filled_orders(trade.entry_side)\n        count_of_entries = trade.nr_of_successful_entries\n        # Allow up to 3 additional increasingly larger buys (4 in total)\n        # Initial buy is 1x\n        # If that falls to -5% profit, we buy 1.25x more, average profit should increase to roughly -2.2%\n        # If that falls down to -5% again, we buy 1.5x more\n        # If that falls once again down to -5%, we buy 1.75x more\n        # Total stake for this trade would be 1 + 1.25 + 1.5 + 1.75 = 5.5x of the initial allowed stake.\n        # That is why max_dca_multiplier is 5.5\n        # Hope you have a deep wallet!\n        try:\n            # This returns first order stake size\n            stake_amount = filled_entries[0].stake_amount_filled\n            # This then calculates current safety order size\n            stake_amount = stake_amount * (1 + (count_of_entries * 0.25))\n            return stake_amount, \"1/3rd_increase\"\n        except Exception as exception:\n            return None\n\n        return None\n","position":{"start":{"line":1017,"column":1},"end":{"line":1118,"column":1}},"key":"S7ff1VYdiK"},{"type":"heading","depth":4,"position":{"start":{"line":1120,"column":1},"end":{"line":1120,"column":1}},"children":[{"type":"text","value":"仓位调整计算","position":{"start":{"line":1120,"column":1},"end":{"line":1120,"column":1}},"key":"pCrNDko4Zm"}],"identifier":"id","label":"仓位调整计算","html_id":"id-25","implicit":true,"key":"gt2Dr5qrOK"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":1122,"column":1},"end":{"line":1126,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":1122,"column":1},"end":{"line":1122,"column":1}},"children":[{"type":"text","value":"入场价格使用加权平均计算。","position":{"start":{"line":1122,"column":1},"end":{"line":1122,"column":1}},"key":"NkS3f58xfX"}],"key":"FpIBNs7x2l"},{"type":"listItem","spread":true,"position":{"start":{"line":1123,"column":1},"end":{"line":1123,"column":1}},"children":[{"type":"text","value":"出场不会影响平均入场价格。","position":{"start":{"line":1123,"column":1},"end":{"line":1123,"column":1}},"key":"CNfb2U4UTu"}],"key":"PWCLMwb9ry"},{"type":"listItem","spread":true,"position":{"start":{"line":1124,"column":1},"end":{"line":1124,"column":1}},"children":[{"type":"text","value":"部分出场的相对利润是相对于此时的平均入场价格。","position":{"start":{"line":1124,"column":1},"end":{"line":1124,"column":1}},"key":"oTcDDeqoc0"}],"key":"aeh905PyuX"},{"type":"listItem","spread":true,"position":{"start":{"line":1125,"column":1},"end":{"line":1126,"column":1}},"children":[{"type":"text","value":"最终出场的相对利润是基于总投资资本计算的。（见下面的例子）","position":{"start":{"line":1125,"column":1},"end":{"line":1125,"column":1}},"key":"tFf1Ak4LD1"}],"key":"EW6vd1Uqst"}],"key":"qmg5IdfvCt"},{"type":"admonition","kind":"hint","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"计算示例","position":{"start":{"line":1127,"column":1},"end":{"line":1127,"column":1}},"key":"h8ucgSVvyd"}],"key":"GJM9DIpqzk"},{"type":"paragraph","position":{"start":{"line":1128,"column":1},"end":{"line":1128,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":1128,"column":1},"end":{"line":1128,"column":1}},"children":[{"type":"text","value":"此示例假设零手续费，且为一个虚拟币的多头仓位。","position":{"start":{"line":1128,"column":1},"end":{"line":1128,"column":1}},"key":"uzAVk1RzL2"}],"key":"mSeLwn0mvG"}],"key":"ISMy5ldbwD"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":1130,"column":1},"end":{"line":1136,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":1130,"column":1},"end":{"line":1130,"column":1}},"children":[{"type":"text","value":"买入 100@8$","position":{"start":{"line":1130,"column":1},"end":{"line":1130,"column":1}},"key":"SnXyCBgkN0"}],"key":"F5zhZv03Ak"},{"type":"listItem","spread":true,"position":{"start":{"line":1131,"column":1},"end":{"line":1131,"column":1}},"children":[{"type":"text","value":"买入 100@9$ -> 平均价格：8.5$","position":{"start":{"line":1131,"column":1},"end":{"line":1131,"column":1}},"key":"G5pwVKQOzw"}],"key":"PYeN9fwxQZ"},{"type":"listItem","spread":true,"position":{"start":{"line":1132,"column":1},"end":{"line":1132,"column":1}},"children":[{"type":"text","value":"卖出 100@10$ -> 平均价格：8.5$，已实现利润 150$，17.65%","position":{"start":{"line":1132,"column":1},"end":{"line":1132,"column":1}},"key":"V2PeD67jEG"}],"key":"xyuoREvZUs"},{"type":"listItem","spread":true,"position":{"start":{"line":1133,"column":1},"end":{"line":1133,"column":1}},"children":[{"type":"text","value":"买入 150@11$ -> 平均价格：10$，已实现利润 150$，17.65%","position":{"start":{"line":1133,"column":1},"end":{"line":1133,"column":1}},"key":"cOODxR62zT"}],"key":"KamZAqhcBY"},{"type":"listItem","spread":true,"position":{"start":{"line":1134,"column":1},"end":{"line":1134,"column":1}},"children":[{"type":"text","value":"卖出 100@12$ -> 平均价格：10$，总已实现利润 350$，20%","position":{"start":{"line":1134,"column":1},"end":{"line":1134,"column":1}},"key":"KCySeoMruM"}],"key":"ZC2A5HtWIu"},{"type":"listItem","spread":true,"position":{"start":{"line":1135,"column":1},"end":{"line":1136,"column":1}},"children":[{"type":"text","value":"卖出 150@14$ -> 平均价格：10$，总已实现利润 950$，40%  <- ","position":{"start":{"line":1135,"column":1},"end":{"line":1135,"column":1}},"key":"DUJyWtUKBm"},{"type":"emphasis","position":{"start":{"line":1135,"column":1},"end":{"line":1135,"column":1}},"children":[{"type":"text","value":"这将是最后的\"出场\"消息","position":{"start":{"line":1135,"column":1},"end":{"line":1135,"column":1}},"key":"t6VlL1C9Cc"}],"key":"Fr7IMv2bvK"}],"key":"UlQPdyx3YT"}],"key":"VBMxrhotmX"},{"type":"paragraph","position":{"start":{"line":1137,"column":1},"end":{"line":1137,"column":1}},"children":[{"type":"text","value":"这笔交易的总利润是 950$，总投资为 3350$（","position":{"start":{"line":1137,"column":1},"end":{"line":1137,"column":1}},"key":"HEjqjEw2yS"},{"type":"inlineCode","value":"100@8$ + 100@9$ + 150@11$","position":{"start":{"line":1137,"column":1},"end":{"line":1137,"column":1}},"key":"uK52elkQrP"},{"type":"text","value":"）。因此，最终相对利润为 28.35%（","position":{"start":{"line":1137,"column":1},"end":{"line":1137,"column":1}},"key":"qT4jHl0vhJ"},{"type":"inlineCode","value":"950 / 3350","position":{"start":{"line":1137,"column":1},"end":{"line":1137,"column":1}},"key":"l50NyE14Xp"},{"type":"text","value":"）。","position":{"start":{"line":1137,"column":1},"end":{"line":1137,"column":1}},"key":"h1HGB9Gcgd"}],"key":"Y8HHZmrZUk"}],"key":"Rb6Ix8gLE3"},{"type":"heading","depth":3,"position":{"start":{"line":1140,"column":1},"end":{"line":1140,"column":1}},"children":[{"type":"text","value":"调整订单价格","position":{"start":{"line":1140,"column":1},"end":{"line":1140,"column":1}},"key":"TOS314tLbL"}],"identifier":"id","label":"调整订单价格","html_id":"id-26","implicit":true,"key":"wGBr23q0v8"},{"type":"paragraph","position":{"start":{"line":1142,"column":1},"end":{"line":1142,"column":1}},"children":[{"type":"text","value":"策略开发者可以使用 ","position":{"start":{"line":1142,"column":1},"end":{"line":1142,"column":1}},"key":"F8dN2kmNL9"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1142,"column":1},"end":{"line":1142,"column":1}},"key":"QJPBzoUC7Z"},{"type":"text","value":" 回调在新K线到达时刷新/替换限价订单。","position":{"start":{"line":1142,"column":1},"end":{"line":1142,"column":1}},"key":"eCF9QPAqPx"}],"key":"Cm459L3RD3"},{"type":"paragraph","position":{"start":{"line":1144,"column":1},"end":{"line":1144,"column":1}},"children":[{"type":"text","value":"除非订单在当前K线内已被（重新）放置，否则此回调在每次迭代时都会被调用一次 - 限制每个订单的最大（重新）放置次数为每根K线一次。","position":{"start":{"line":1144,"column":1},"end":{"line":1144,"column":1}},"key":"KIpNFdoSCY"}],"key":"kAwpAzpIRC"},{"type":"paragraph","position":{"start":{"line":1146,"column":1},"end":{"line":1146,"column":1}},"children":[{"type":"text","value":"这也意味着第一次调用将在初始订单放置后的下一根K线开始时进行。","position":{"start":{"line":1146,"column":1},"end":{"line":1146,"column":1}},"key":"WMI4FNoHQY"}],"key":"sBAtKWlZgF"},{"type":"paragraph","position":{"start":{"line":1148,"column":1},"end":{"line":1148,"column":1}},"children":[{"type":"text","value":"请注意，","position":{"start":{"line":1148,"column":1},"end":{"line":1148,"column":1}},"key":"HfIPeucD4S"},{"type":"inlineCode","value":"custom_entry_price()","position":{"start":{"line":1148,"column":1},"end":{"line":1148,"column":1}},"key":"voRcjSjVL3"},{"type":"text","value":"/","position":{"start":{"line":1148,"column":1},"end":{"line":1148,"column":1}},"key":"teHBsYnpBD"},{"type":"inlineCode","value":"custom_exit_price()","position":{"start":{"line":1148,"column":1},"end":{"line":1148,"column":1}},"key":"CZd1JFmpDP"},{"type":"text","value":" 仍然是在信号发出时决定初始限价订单价格目标的方法。","position":{"start":{"line":1148,"column":1},"end":{"line":1148,"column":1}},"key":"XGP1JfypOk"}],"key":"O8PSbVhgRt"},{"type":"paragraph","position":{"start":{"line":1150,"column":1},"end":{"line":1150,"column":1}},"children":[{"type":"text","value":"可以通过返回 ","position":{"start":{"line":1150,"column":1},"end":{"line":1150,"column":1}},"key":"g8zfMTEo7B"},{"type":"inlineCode","value":"None","position":{"start":{"line":1150,"column":1},"end":{"line":1150,"column":1}},"key":"rLralgMExt"},{"type":"text","value":" 来取消此回调中的订单。","position":{"start":{"line":1150,"column":1},"end":{"line":1150,"column":1}},"key":"QPxsmarTCF"}],"key":"H9JnyVCvsS"},{"type":"paragraph","position":{"start":{"line":1152,"column":1},"end":{"line":1152,"column":1}},"children":[{"type":"text","value":"返回 ","position":{"start":{"line":1152,"column":1},"end":{"line":1152,"column":1}},"key":"KoG4vb2PvJ"},{"type":"inlineCode","value":"current_order_rate","position":{"start":{"line":1152,"column":1},"end":{"line":1152,"column":1}},"key":"gvxFekpGvj"},{"type":"text","value":" 将保持订单在交易所\"原样\"。","position":{"start":{"line":1152,"column":1},"end":{"line":1152,"column":1}},"key":"HD9rOA5SWG"}],"key":"a6Y5QA3G5B"},{"type":"paragraph","position":{"start":{"line":1154,"column":1},"end":{"line":1154,"column":1}},"children":[{"type":"text","value":"返回任何其他价格将取消现有订单，并替换为新订单。","position":{"start":{"line":1154,"column":1},"end":{"line":1154,"column":1}},"key":"EwfP3c1Nch"}],"key":"Kq9Xl6BueV"},{"type":"paragraph","position":{"start":{"line":1156,"column":1},"end":{"line":1157,"column":1}},"children":[{"type":"text","value":"如果原始订单的取消失败，则不会替换订单 - 尽管订单很可能已在交易所被取消。如果这种情况发生在初始入场时，将导致订单被删除，而在仓位调整订单中，将导致交易规模保持不变。","position":{"start":{"line":1156,"column":1},"end":{"line":1156,"column":1}},"key":"IjV4lrqwxp"},{"type":"break","position":{"start":{"line":1156,"column":1},"end":{"line":1156,"column":1}},"key":"DSdpNv18fG"},{"type":"text","value":"如果订单已部分成交，则不会替换订单。但是，如果需要/希望，你可以使用 ","position":{"start":{"line":1156,"column":1},"end":{"line":1156,"column":1}},"key":"ISKhmrJDGI"},{"type":"crossReference","position":{"start":{"line":1156,"column":1},"end":{"line":1156,"column":1}},"children":[{"type":"inlineCode","value":"adjust_trade_position()","position":{"start":{"line":1156,"column":1},"end":{"line":1156,"column":1}},"key":"jd5BqCHVhD"}],"identifier":"adjust-trade-position","label":"adjust-trade-position","kind":"heading","template":"{name}","resolved":true,"html_id":"adjust-trade-position","key":"ow7vlirBG8"},{"type":"text","value":" 来调整交易规模到预期的仓位大小。","position":{"start":{"line":1156,"column":1},"end":{"line":1156,"column":1}},"key":"kYkhbgfXuP"}],"key":"mVwCt7O7e8"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"常规超时","position":{"start":{"line":1159,"column":1},"end":{"line":1159,"column":1}},"key":"Oq90MHcx0Q"}],"key":"ajg1toCZ84"},{"type":"paragraph","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"children":[{"type":"text","value":"入场 ","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"key":"EJGfWQimZg"},{"type":"inlineCode","value":"unfilledtimeout","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"key":"sDGc1V3RgV"},{"type":"text","value":" 机制（以及 ","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"key":"mdkwYOYUHI"},{"type":"inlineCode","value":"check_entry_timeout()","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"key":"DlkFalHrTO"},{"type":"text","value":"/","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"key":"QlTsQoVFd0"},{"type":"inlineCode","value":"check_exit_timeout()","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"key":"sbBq2h0wzt"},{"type":"text","value":"）优先于此回调。","position":{"start":{"line":1160,"column":1},"end":{"line":1160,"column":1}},"key":"gYtodIkmZI"}],"key":"CrhLT8Fq3c"},{"type":"paragraph","position":{"start":{"line":1162,"column":1},"end":{"line":1162,"column":1}},"children":[{"type":"text","value":"通过上述方法取消的订单不会调用此回调。请确保更新超时值以符合你的预期。","position":{"start":{"line":1162,"column":1},"end":{"line":1162,"column":1}},"key":"lawIQfRziA"}],"key":"hDEtqXQ3bP"}],"key":"ATYh98ckkq"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n\n    # ... populate_* methods\n\n    def adjust_order_price(\n        self,\n        trade: Trade,\n        order: Order | None,\n        pair: str,\n        current_time: datetime,\n        proposed_rate: float,\n        current_order_rate: float,\n        entry_tag: str | None,\n        side: str,\n        is_entry: bool,\n        **kwargs,\n    ) -> float | None:\n        \"\"\"\n        Exit and entry order price re-adjustment logic, returning the user desired limit price.\n        This only executes when a order was already placed, still open (unfilled fully or partially)\n        and not timed out on subsequent candles after entry trigger.\n\n        For full documentation please go to https://www.freqtrade.io/en/latest/strategy-callbacks/\n\n        When not implemented by a strategy, returns current_order_rate as default.\n        If current_order_rate is returned then the existing order is maintained.\n        If None is returned then order gets canceled but not replaced by a new one.\n\n        :param pair: Pair that's currently analyzed\n        :param trade: Trade object.\n        :param order: Order object\n        :param current_time: datetime object, containing the current datetime\n        :param proposed_rate: Rate, calculated based on pricing settings in entry_pricing.\n        :param current_order_rate: Rate of the existing order in place.\n        :param entry_tag: Optional entry_tag (buy_tag) if provided with the buy signal.\n        :param side: 'long' or 'short' - indicating the direction of the proposed trade\n        :param is_entry: True if the order is an entry order, False if it's an exit order.\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        :return float or None: New entry price value if provided\n        \"\"\"\n\n        # Limit entry orders to use and follow SMA200 as price target for the first 10 minutes since entry trigger for BTC/USDT pair.\n        if (\n            is_entry\n            and pair == \"BTC/USDT\" \n            and entry_tag == \"long_sma200\" \n            and side == \"long\" \n            and (current_time - timedelta(minutes=10)) <= trade.open_date_utc\n        ):\n            # just cancel the order if it has been filled more than half of the amount\n            if order.filled > order.remaining:\n                return None\n            else:\n                dataframe, _ = self.dp.get_analyzed_dataframe(pair=pair, timeframe=self.timeframe)\n                current_candle = dataframe.iloc[-1].squeeze()\n                # desired price\n                return current_candle[\"sma_200\"]\n        # default: maintain existing order\n        return current_order_rate","position":{"start":{"line":1165,"column":1},"end":{"line":1227,"column":1}},"key":"KBg7YqSCn6"},{"type":"admonition","kind":"danger","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"与 ","position":{"start":{"line":1229,"column":1},"end":{"line":1229,"column":1}},"key":"e5EJDPeJP1"},{"type":"inlineCode","value":"adjust_*_price()","position":{"start":{"line":1229,"column":1},"end":{"line":1229,"column":1}},"key":"JeypTXMJhF"},{"type":"text","value":" 的不兼容性","position":{"start":{"line":1229,"column":1},"end":{"line":1229,"column":1}},"key":"ecUB2w7p6S"}],"key":"ZABFXC6ci6"},{"type":"paragraph","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"children":[{"type":"text","value":"如果你同时实现了 ","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"Q7qVSrgY91"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"IkuztgbuiB"},{"type":"text","value":" 和 ","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"K3eCwATvFF"},{"type":"inlineCode","value":"adjust_entry_price()","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"HsLsqgHjBU"},{"type":"text","value":"/","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"bG1mS0XZGF"},{"type":"inlineCode","value":"adjust_exit_price()","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"ObVLxGTs7H"},{"type":"text","value":"，则只会使用 ","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"UN8bj2NCwr"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"clp6UfMhRE"},{"type":"text","value":"。","position":{"start":{"line":1230,"column":1},"end":{"line":1230,"column":1}},"key":"hviJJ2kClE"}],"key":"VyHnpbApJ0"},{"type":"paragraph","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"children":[{"type":"text","value":"如果你需要调整入场/出场价格，你可以选择在 ","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"key":"JMsja6AYD0"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"key":"gFxWDht6JL"},{"type":"text","value":" 中实现逻辑，或者使用分开的 ","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"key":"qFa7i9Z0LR"},{"type":"inlineCode","value":"adjust_entry_price()","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"key":"P6OvovfDOZ"},{"type":"text","value":" / ","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"key":"OxIn6yhZlr"},{"type":"inlineCode","value":"adjust_exit_price()","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"key":"L2bvQLxdBS"},{"type":"text","value":" 回调，但不能同时使用两者。","position":{"start":{"line":1232,"column":1},"end":{"line":1232,"column":1}},"key":"doLZgFeXCa"}],"key":"PLEQXASAEM"},{"type":"paragraph","position":{"start":{"line":1234,"column":1},"end":{"line":1234,"column":1}},"children":[{"type":"text","value":"混合使用这些功能是不支持的，会在机器人启动时引发错误。","position":{"start":{"line":1234,"column":1},"end":{"line":1234,"column":1}},"key":"DJcTGjLXS5"}],"key":"EmcNre0YA8"}],"key":"vyYhHbjddi"},{"type":"heading","depth":4,"position":{"start":{"line":1237,"column":1},"end":{"line":1237,"column":1}},"children":[{"type":"text","value":"调整入场价格","position":{"start":{"line":1237,"column":1},"end":{"line":1237,"column":1}},"key":"uoGk4gMK5U"}],"identifier":"id","label":"调整入场价格","html_id":"id-27","implicit":true,"key":"BimaxSQAWQ"},{"type":"paragraph","position":{"start":{"line":1239,"column":1},"end":{"line":1239,"column":1}},"children":[{"type":"text","value":"策略开发者可以使用 ","position":{"start":{"line":1239,"column":1},"end":{"line":1239,"column":1}},"key":"or8YTyWWMd"},{"type":"inlineCode","value":"adjust_entry_price()","position":{"start":{"line":1239,"column":1},"end":{"line":1239,"column":1}},"key":"uC5gKQtDKh"},{"type":"text","value":" 回调在新K线到达时刷新/替换入场限价订单。","position":{"start":{"line":1239,"column":1},"end":{"line":1239,"column":1}},"key":"NSOcmfiNAq"}],"key":"OOuIxr57PK"},{"type":"paragraph","position":{"start":{"line":1241,"column":1},"end":{"line":1241,"column":1}},"children":[{"type":"text","value":"这是 ","position":{"start":{"line":1241,"column":1},"end":{"line":1241,"column":1}},"key":"Hf4PHmMtYb"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1241,"column":1},"end":{"line":1241,"column":1}},"key":"C1UfmX7PqF"},{"type":"text","value":" 的一个子集，仅用于入场订单。","position":{"start":{"line":1241,"column":1},"end":{"line":1241,"column":1}},"key":"uVML21rP9w"}],"key":"QtJN2deaCZ"},{"type":"paragraph","position":{"start":{"line":1243,"column":1},"end":{"line":1243,"column":1}},"children":[{"type":"text","value":"其余所有行为与 ","position":{"start":{"line":1243,"column":1},"end":{"line":1243,"column":1}},"key":"mESQ5gXw5V"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1243,"column":1},"end":{"line":1243,"column":1}},"key":"elpjjrtfF5"},{"type":"text","value":" 相同。","position":{"start":{"line":1243,"column":1},"end":{"line":1243,"column":1}},"key":"dgRN8Yl0W5"}],"key":"JtzTdqYfLG"},{"type":"paragraph","position":{"start":{"line":1245,"column":1},"end":{"line":1245,"column":1}},"children":[{"type":"text","value":"交易开始日期（","position":{"start":{"line":1245,"column":1},"end":{"line":1245,"column":1}},"key":"QQVU6xkplt"},{"type":"inlineCode","value":"trade.open_date_utc","position":{"start":{"line":1245,"column":1},"end":{"line":1245,"column":1}},"key":"zxqD6B0qXL"},{"type":"text","value":"）将保持在第一个订单放置的时间。","position":{"start":{"line":1245,"column":1},"end":{"line":1245,"column":1}},"key":"wBgwRwECA1"}],"key":"HQ1HvvQkVu"},{"type":"paragraph","position":{"start":{"line":1247,"column":1},"end":{"line":1247,"column":1}},"children":[{"type":"text","value":"请确保注意这一点 - 并相应地调整其他回调中的逻辑，使用第一个成交订单的日期。","position":{"start":{"line":1247,"column":1},"end":{"line":1247,"column":1}},"key":"B39VMq4K70"}],"key":"YbpuV0p6nm"},{"type":"heading","depth":4,"position":{"start":{"line":1249,"column":1},"end":{"line":1249,"column":1}},"children":[{"type":"text","value":"调整出场价格","position":{"start":{"line":1249,"column":1},"end":{"line":1249,"column":1}},"key":"HyiqWVIkwG"}],"identifier":"id","label":"调整出场价格","html_id":"id-28","implicit":true,"key":"rmJ4PzcP45"},{"type":"paragraph","position":{"start":{"line":1251,"column":1},"end":{"line":1251,"column":1}},"children":[{"type":"text","value":"策略开发者可以使用 ","position":{"start":{"line":1251,"column":1},"end":{"line":1251,"column":1}},"key":"XJZYwyCoVc"},{"type":"inlineCode","value":"adjust_exit_price()","position":{"start":{"line":1251,"column":1},"end":{"line":1251,"column":1}},"key":"HbQhF2Vj2F"},{"type":"text","value":" 回调在新K线到达时刷新/替换出场限价订单。","position":{"start":{"line":1251,"column":1},"end":{"line":1251,"column":1}},"key":"ILtDRJAR28"}],"key":"ClQBAAtK52"},{"type":"paragraph","position":{"start":{"line":1253,"column":1},"end":{"line":1253,"column":1}},"children":[{"type":"text","value":"这是 ","position":{"start":{"line":1253,"column":1},"end":{"line":1253,"column":1}},"key":"M9AuRZ0BbG"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1253,"column":1},"end":{"line":1253,"column":1}},"key":"K2rFNV5yxA"},{"type":"text","value":" 的一个子集，仅用于出场订单。","position":{"start":{"line":1253,"column":1},"end":{"line":1253,"column":1}},"key":"TgNnO2xMHP"}],"key":"GTlP0MJeeV"},{"type":"paragraph","position":{"start":{"line":1255,"column":1},"end":{"line":1255,"column":1}},"children":[{"type":"text","value":"其余所有行为与 ","position":{"start":{"line":1255,"column":1},"end":{"line":1255,"column":1}},"key":"ricIamFJtD"},{"type":"inlineCode","value":"adjust_order_price()","position":{"start":{"line":1255,"column":1},"end":{"line":1255,"column":1}},"key":"EqU6laugIL"},{"type":"text","value":" 相同。","position":{"start":{"line":1255,"column":1},"end":{"line":1255,"column":1}},"key":"GDa3N80PzD"}],"key":"aIAgRd8uvR"},{"type":"heading","depth":3,"position":{"start":{"line":1257,"column":1},"end":{"line":1257,"column":1}},"children":[{"type":"text","value":"杠杆回调","position":{"start":{"line":1257,"column":1},"end":{"line":1257,"column":1}},"key":"camdYbpuxf"}],"identifier":"id","label":"杠杆回调","html_id":"id-29","implicit":true,"key":"Mn6vrKcfqN"},{"type":"paragraph","position":{"start":{"line":1259,"column":1},"end":{"line":1259,"column":1}},"children":[{"type":"text","value":"在允许杠杆交易的市场中，此方法必须返回所需的杠杆倍数（默认为 1 -> 无杠杆）。","position":{"start":{"line":1259,"column":1},"end":{"line":1259,"column":1}},"key":"qNNNWhuj5l"}],"key":"Emj3dEoyy9"},{"type":"paragraph","position":{"start":{"line":1261,"column":1},"end":{"line":1261,"column":1}},"children":[{"type":"text","value":"假设资金为 500USDT，杠杆倍数为 3 的交易将产生 500 x 3 = 1500 USDT 的仓位。","position":{"start":{"line":1261,"column":1},"end":{"line":1261,"column":1}},"key":"GYZZcj7C7h"}],"key":"p4KbqLq8pM"},{"type":"paragraph","position":{"start":{"line":1263,"column":1},"end":{"line":1264,"column":1}},"children":[{"type":"text","value":"超过 ","position":{"start":{"line":1263,"column":1},"end":{"line":1263,"column":1}},"key":"siKcj987dz"},{"type":"inlineCode","value":"max_leverage","position":{"start":{"line":1263,"column":1},"end":{"line":1263,"column":1}},"key":"ZA3Q5LZVkA"},{"type":"text","value":" 的值将被调整为 ","position":{"start":{"line":1263,"column":1},"end":{"line":1263,"column":1}},"key":"ZDwvTxjQ6K"},{"type":"inlineCode","value":"max_leverage","position":{"start":{"line":1263,"column":1},"end":{"line":1263,"column":1}},"key":"R0MDH4DvzR"},{"type":"text","value":"。\n对于不支持杠杆的市场/交易所，此方法将被忽略。","position":{"start":{"line":1263,"column":1},"end":{"line":1263,"column":1}},"key":"rOaYBUInRt"}],"key":"n9xRQCjHO7"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n    def leverage(self, pair: str, current_time: datetime, current_rate: float,\n                 proposed_leverage: float, max_leverage: float, entry_tag: str | None, side: str,\n                 **kwargs) -> float:\n        \"\"\"\n        Customize leverage for each new trade. This method is only called in futures mode.\n\n        :param pair: Pair that's currently analyzed\n        :param current_time: datetime object, containing the current datetime\n        :param current_rate: Rate, calculated based on pricing settings in exit_pricing.\n        :param proposed_leverage: A leverage proposed by the bot.\n        :param max_leverage: Max leverage allowed on this pair\n        :param entry_tag: Optional entry_tag (buy_tag) if provided with the buy signal.\n        :param side: \"long\" or \"short\" - indicating the direction of the proposed trade\n        :return: A leverage amount, which is between 1.0 and max_leverage.\n        \"\"\"\n        return 1.0","position":{"start":{"line":1266,"column":1},"end":{"line":1286,"column":1}},"key":"WLYhlzQ36j"},{"type":"paragraph","position":{"start":{"line":1288,"column":1},"end":{"line":1288,"column":1}},"children":[{"type":"text","value":"所有利润计算都包含杠杆。止损和 ROI 的计算也包含杠杆。","position":{"start":{"line":1288,"column":1},"end":{"line":1288,"column":1}},"key":"ikMuqC6TIM"}],"key":"crQlKd9iYT"},{"type":"paragraph","position":{"start":{"line":1290,"column":1},"end":{"line":1290,"column":1}},"children":[{"type":"text","value":"在 10 倍杠杆下设置 10% 的止损，将在价格下跌 1% 时触发止损。","position":{"start":{"line":1290,"column":1},"end":{"line":1290,"column":1}},"key":"OlDsZ8tl0t"}],"key":"PL016xoX2p"},{"type":"heading","depth":3,"position":{"start":{"line":1292,"column":1},"end":{"line":1292,"column":1}},"children":[{"type":"text","value":"订单成交回调","position":{"start":{"line":1292,"column":1},"end":{"line":1292,"column":1}},"key":"QHz5ol61h8"}],"identifier":"id","label":"订单成交回调","html_id":"id-30","implicit":true,"key":"jAiZu7ssWT"},{"type":"paragraph","position":{"start":{"line":1294,"column":1},"end":{"line":1294,"column":1}},"children":[{"type":"inlineCode","value":"order_filled()","position":{"start":{"line":1294,"column":1},"end":{"line":1294,"column":1}},"key":"dGsx8JwmJz"},{"type":"text","value":" 回调可用于在订单成交后根据当前交易状态执行特定操作。","position":{"start":{"line":1294,"column":1},"end":{"line":1294,"column":1}},"key":"znppp2a58I"}],"key":"wpfhirGBQI"},{"type":"paragraph","position":{"start":{"line":1296,"column":1},"end":{"line":1296,"column":1}},"children":[{"type":"text","value":"它将独立于订单类型（入场、出场、止损或仓位调整）被调用。","position":{"start":{"line":1296,"column":1},"end":{"line":1296,"column":1}},"key":"FnBemELXve"}],"key":"itpPrsdev3"},{"type":"paragraph","position":{"start":{"line":1298,"column":1},"end":{"line":1298,"column":1}},"children":[{"type":"text","value":"假设你的策略需要在开仓时存储该 K 线的最高价，可以通过如下示例所示的回调实现这一点。","position":{"start":{"line":1298,"column":1},"end":{"line":1298,"column":1}},"key":"gSGpPjtEG7"}],"key":"y0clYgWc0i"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n    def order_filled(self, pair: str, trade: Trade, order: Order, current_time: datetime, **kwargs) -> None:\n        \"\"\"\n        Called right after an order fills. \n        Will be called for all order types (entry, exit, stoploss, position adjustment).\n        :param pair: Pair for trade\n        :param trade: trade object.\n        :param order: Order object.\n        :param current_time: datetime object, containing the current datetime\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        \"\"\"\n        # Obtain pair dataframe (just to show how to access it)\n        dataframe, _ = self.dp.get_analyzed_dataframe(trade.pair, self.timeframe)\n        last_candle = dataframe.iloc[-1].squeeze()\n        \n        if (trade.nr_of_successful_entries == 1) and (order.ft_order_side == trade.entry_side):\n            trade.set_custom_data(key=\"entry_candle_high\", value=last_candle[\"high\"])\n\n        return None\n","position":{"start":{"line":1300,"column":1},"end":{"line":1323,"column":1}},"key":"WSgnT3iXxr"},{"type":"heading","depth":3,"position":{"start":{"line":1325,"column":1},"end":{"line":1325,"column":1}},"children":[{"type":"text","value":"图表注释回调","position":{"start":{"line":1325,"column":1},"end":{"line":1325,"column":1}},"key":"RpwLIGVcfG"}],"identifier":"id","label":"图表注释回调","html_id":"id-31","implicit":true,"key":"rKbnlCWwoI"},{"type":"paragraph","position":{"start":{"line":1327,"column":1},"end":{"line":1328,"column":1}},"children":[{"type":"text","value":"每当 freqUI 请求显示图表数据时，都会调用图表注释回调。\n此回调在交易周期中没有实际意义，仅用于图表展示。","position":{"start":{"line":1327,"column":1},"end":{"line":1327,"column":1}},"key":"yt3e3C6EGA"}],"key":"cZ0ViiKgFf"},{"type":"paragraph","position":{"start":{"line":1330,"column":1},"end":{"line":1331,"column":1}},"children":[{"type":"text","value":"策略可以返回一个 ","position":{"start":{"line":1330,"column":1},"end":{"line":1330,"column":1}},"key":"kgWDi44IgE"},{"type":"inlineCode","value":"AnnotationType","position":{"start":{"line":1330,"column":1},"end":{"line":1330,"column":1}},"key":"xWYWAFQRU6"},{"type":"text","value":" 对象列表，这些对象会显示在图表上。\n根据返回内容，图表可以显示水平区域、垂直区域或框选区域。","position":{"start":{"line":1330,"column":1},"end":{"line":1330,"column":1}},"key":"WyCnDeofxV"}],"key":"zZRSDh0jtc"},{"type":"paragraph","position":{"start":{"line":1333,"column":1},"end":{"line":1333,"column":1}},"children":[{"type":"text","value":"完整对象如下所示：","position":{"start":{"line":1333,"column":1},"end":{"line":1333,"column":1}},"key":"SqEXclvEzj"}],"key":"tM6hivHzUU"},{"type":"code","lang":"json","value":"{\n    \"type\": \"area\", // Type of the annotation, currently only \"area\" is supported\n    \"start\": \"2024-01-01 15:00:00\", // Start date of the area\n    \"end\": \"2024-01-01 16:00:00\",  // End date of the area\n    \"y_start\": 94000.2,  // Price / y axis value\n    \"y_end\": 98000, // Price / y axis value\n    \"color\": \"\",\n    \"label\": \"some label\"\n}","position":{"start":{"line":1335,"column":1},"end":{"line":1345,"column":1}},"key":"xdv7gzDakU"},{"type":"paragraph","position":{"start":{"line":1347,"column":1},"end":{"line":1348,"column":1}},"children":[{"type":"text","value":"下面的示例将在图表上标记第 8 小时和第 15 小时的区域，使用灰色突出显示市场开盘和收盘时间。\n这显然是一个非常基础的示例。","position":{"start":{"line":1347,"column":1},"end":{"line":1347,"column":1}},"key":"dWhwVzemGT"}],"key":"rqZh6ofYJ6"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n    def plot_annotations(\n        self, pair: str, start_date: datetime, end_date: datetime, dataframe: DataFrame, **kwargs\n    ) -> list[AnnotationType]:\n        \"\"\"\n        Retrieve area annotations for a chart.\n        Must be returned as array, with type, label, color, start, end, y_start, y_end.\n        All settings except for type are optional - though it usually makes sense to include either\n        \"start and end\" or \"y_start and y_end\" for either horizontal or vertical plots\n        (or all 4 for boxes).\n        :param pair: Pair that's currently analyzed\n        :param start_date: Start date of the chart data being requested\n        :param end_date: End date of the chart data being requested\n        :param dataframe: DataFrame with the analyzed data for the chart\n        :param **kwargs: Ensure to keep this here so updates to this won't break your strategy.\n        :return: List of AnnotationType objects\n        \"\"\"\n        annotations = []\n        while start_dt < end_date:\n            start_dt += timedelta(hours=1)\n            if start_dt.hour in (8, 15):\n                annotations.append(\n                    {\n                        \"type\": \"area\",\n                        \"label\": \"Trade open and close hours\",\n                        \"start\": start_dt,\n                        \"end\": start_dt + timedelta(hours=1),\n                        # Omitting y_start and y_end will result in a vertical area spanning the whole height of the main Chart\n                        \"color\": \"rgba(133, 133, 133, 0.4)\",\n                    }\n                )\n\n        return annotations\n","position":{"start":{"line":1350,"column":1},"end":{"line":1387,"column":1}},"key":"blcfwbldKf"},{"type":"paragraph","position":{"start":{"line":1389,"column":1},"end":{"line":1389,"column":1}},"children":[{"type":"text","value":"所有条目都将被验证，如果不符合预期的模式，将不会被传递给 UI，并且会记录错误。","position":{"start":{"line":1389,"column":1},"end":{"line":1389,"column":1}},"key":"UNwP4lNV9q"}],"key":"TxXQeCHUez"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"过多图片注释","position":{"start":{"line":1391,"column":1},"end":{"line":1391,"column":1}},"key":"aRwjVMhmsS"}],"key":"GKxNzefJsc"},{"type":"paragraph","position":{"start":{"line":1392,"column":1},"end":{"line":1392,"column":1}},"children":[{"type":"text","value":"使用过多注释可能导致 UI 卡顿，特别是在绘制大量历史数据时。","position":{"start":{"line":1392,"column":1},"end":{"line":1392,"column":1}},"key":"G0auDId9GF"}],"key":"D8eojgV7QJ"},{"type":"paragraph","position":{"start":{"line":1394,"column":1},"end":{"line":1394,"column":1}},"children":[{"type":"text","value":"请谨慎使用注释功能。","position":{"start":{"line":1394,"column":1},"end":{"line":1394,"column":1}},"key":"OTxkQ6Aumu"}],"key":"UKOjrpgvfz"}],"key":"wEZXizBETh"},{"type":"heading","depth":4,"position":{"start":{"line":1397,"column":1},"end":{"line":1397,"column":1}},"children":[{"type":"text","value":"图表注释示例","position":{"start":{"line":1397,"column":1},"end":{"line":1397,"column":1}},"key":"R1ppa9fkFK"}],"identifier":"id","label":"图表注释示例","html_id":"id-32","implicit":true,"key":"Rf2JTQ9usX"},{"type":"paragraph","position":{"start":{"line":1399,"column":1},"end":{"line":1400,"column":1}},"children":[{"type":"image","url":"/freqUI-chart-annotat-6ca425e986932e863842497203176546.png","alt":"FreqUI - 图表注释","position":{"start":{"line":1399,"column":1},"end":{"line":1399,"column":1}},"key":"Wcgds4U4iQ","urlSource":"assets/freqUI-chart-annotations-dark.png","urlOptimized":"/freqUI-chart-annotat-6ca425e986932e863842497203176546.webp"},{"type":"text","value":"\n","position":{"start":{"line":1399,"column":1},"end":{"line":1399,"column":1}},"key":"sR5RadteYv"},{"type":"image","url":"/freqUI-chart-annotat-1e4333673f820e578805f2b84b0b8eca.png","alt":"FreqUI - 图表注释","position":{"start":{"line":1399,"column":1},"end":{"line":1399,"column":1}},"key":"rDlhGcn71H","urlSource":"assets/freqUI-chart-annotations-light.png","urlOptimized":"/freqUI-chart-annotat-1e4333673f820e578805f2b84b0b8eca.webp"}],"key":"Sc6ykqHMod"},{"type":"admonition","kind":"important","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"上图使用的代码","position":{"start":{"line":1402,"column":1},"end":{"line":1402,"column":1}},"key":"hKEpAy7Jmx"}],"key":"sEe19eMPzl"},{"type":"paragraph","position":{"start":{"line":1403,"column":1},"end":{"line":1403,"column":1}},"children":[{"type":"text","value":"这是一个示例代码，仅供参考。","position":{"start":{"line":1403,"column":1},"end":{"line":1403,"column":1}},"key":"jl7AHTIka9"}],"key":"uwgjIE8wQ7"},{"type":"code","lang":"python","value":"# Default imports\n\nclass AwesomeStrategy(IStrategy):\n    def plot_annotations(\n        self, pair: str, start_date: datetime, end_date: datetime, dataframe: DataFrame, **kwargs\n    ) -> list[AnnotationType]:\n        annotations = []\n        while start_dt < end_date:\n            start_dt += timedelta(hours=1)\n            if (start_dt.hour % 4) == 0:\n                mark_areas.append(\n                    {\n                        \"type\": \"area\",\n                        \"label\": \"4h\",\n                        \"start\": start_dt,\n                        \"end\": start_dt + timedelta(hours=1),\n                        \"color\": \"rgba(133, 133, 133, 0.4)\",\n                    }\n                )\n            elif (start_dt.hour % 2) == 0:\n            price = dataframe.loc[dataframe[\"date\"] == start_dt, [\"close\"]].mean()\n                mark_areas.append(\n                    {\n                        \"type\": \"area\",\n                        \"label\": \"2h\",\n                        \"start\": start_dt,\n                        \"end\": start_dt + timedelta(hours=1),\n                        \"y_end\": price * 1.01,\n                        \"y_start\": price * 0.99,\n                        \"color\": \"rgba(0, 255, 0, 0.4)\",\n                    }\n                )\n\n        return annotations\n","position":{"start":{"line":1405,"column":1},"end":{"line":1441,"column":1}},"key":"ULdm2XO11r"}],"key":"o1EUVz0WrV"}],"key":"jJEE7R5mzf"}],"key":"kUbSchloW4"},"references":{"cite":{"order":[],"data":{}}}}