{"version":2,"kind":"Article","sha256":"c20e7c2b7345dad028c8e9b83b796c8e21d1d492a9f892da5e86a68506fd34dc","slug":"strategy-advanced","location":"/strategy-advanced.md","dependencies":[],"frontmatter":{"title":"Freqtrade 高级策略指南","description":"本文档详细介绍了 Freqtrade 交易机器人的高级策略开发概念,包括持久化存储、回调方法等进阶功能。","short_title":"高级策略","subtitle":"高级策略开发概念和方法","subject":"Freqtrade 策略开发","authors":[{"id":"Freqtrade","name":"Freqtrade"}],"github":"https://github.com/freqtrade-cn/docs_zh-CN","keywords":["Freqtrade","中文文档","交易机器人","量化交易","加密货币","数字货币","区块链","人工智能","机器学习"],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/freqtrade-cn/docs_zh-CN/blob/main/strategy-advanced.md","exports":[{"format":"md","filename":"strategy-advanced.md","url":"/build/strategy-advanced-44b168ff9bc29e2855ed2f871cecbe37.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"高级策略","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"WzLf65Ax3o"}],"identifier":"id","label":"高级策略","html_id":"id","implicit":true,"key":"efUZpOhTME"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"本页解释了一些可用于策略的高级概念。\n如果你是初学者，请先熟悉 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"CXF8GPAOQt"},{"type":"link","url":"/bot-basics","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Freqtrade 基础","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"neDbLQL0KI"}],"urlSource":"bot-basics.md","dataUrl":"/bot-basics.json","internal":true,"protocol":"file","key":"LRdOdsuKIw"},{"type":"text","value":" 和 ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"yYuV4snlU3"},{"type":"link","url":"/strategy-customization","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"策略定制","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"WnSEZS7TyY"}],"urlSource":"strategy-customization.md","dataUrl":"/strategy-customization.json","internal":true,"protocol":"file","key":"s8FvluckIP"},{"type":"text","value":" 中描述的方法。","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ksVH5DlBip"}],"key":"nAqUy1hXau"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"这里描述的方法的调用顺序在 ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"oEhT08k5YC"},{"type":"crossReference","url":"/bot-basics","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"机器人执行逻辑","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"XQZ0dgx9sS"}],"urlSource":"bot-basics.md#bot-execution-logic","dataUrl":"/bot-basics.json","identifier":"bot-execution-logic","label":"bot-execution-logic","remote":true,"protocol":"file","kind":"heading","template":"{name}","resolved":true,"html_id":"bot-execution-logic","key":"zWIsWTgFa0"},{"type":"text","value":" 中有详细说明。这些文档也有助于决定哪种方法最适合你的定制需求。","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"Kfrgrat07T"}],"key":"jbmPesoUUq"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"Jp40ljXp6t"}],"key":"ZxKQPTJsrO"},{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"回调方法应该","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"ESgC38z5Ma"},{"type":"emphasis","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"只","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"RoY4OimdDX"}],"key":"DOdyQoLmMx"},{"type":"text","value":"在策略使用它们时实现。","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"osHT7JKIRw"}],"key":"OV1Q4x0l6B"}],"key":"zB1SpDehM0"},{"type":"admonition","kind":"tip","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Tip","key":"qHoy8JiTwa"}],"key":"iztAkwASHC"},{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"通过运行 ","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"XExupt3pn8"},{"type":"inlineCode","value":"freqtrade new-strategy --strategy MyAwesomeStrategy --template advanced","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"WpM638OlAd"},{"type":"text","value":" 来获取包含所有可用回调方法的策略模板","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"XwEI7V17mf"}],"key":"Fex3VYrIKN"}],"key":"jTxo0Y0IhU"},{"type":"heading","depth":3,"position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"存储信息（持久化）","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"hjkaGeZFWw"}],"identifier":"id","label":"存储信息（持久化）","html_id":"id-1","implicit":true,"key":"GadtVObGmY"},{"type":"paragraph","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"text","value":"Freqtrade 允许在数据库中存储/检索与特定交易相关的用户自定义信息。","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"slpjpEzUJu"}],"key":"mMXDzG9SdU"},{"type":"paragraph","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"text","value":"使用交易对象，可以使用 ","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"g75euxWg5n"},{"type":"inlineCode","value":"trade.set_custom_data(key='my_key', value=my_value)","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"EQmqCI8hhY"},{"type":"text","value":" 存储信息，使用 ","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"PL3ohULY7g"},{"type":"inlineCode","value":"trade.get_custom_data(key='my_key')","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"BPFmhhzr2b"},{"type":"text","value":" 检索信息。每个数据条目都与一个交易和一个用户提供的键（类型为 ","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"MoUvG4pIrD"},{"type":"inlineCode","value":"string","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"ParMV33HzI"},{"type":"text","value":"）相关联。这意味着这只能在也提供交易对象的回调中使用。","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"IFOkC5EymT"}],"key":"tl0jppxVj3"},{"type":"paragraph","position":{"start":{"line":30,"column":1},"end":{"line":31,"column":1}},"children":[{"type":"text","value":"为了使数据能够存储在数据库中，freqtrade 必须序列化数据。这是通过将数据转换为 JSON 格式的字符串来完成的。\nFreqtrade 将在检索时尝试反转此操作，因此从策略的角度来看，这应该无关紧要。","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"xQItbrqpsM"}],"key":"ocnBNZTB7P"},{"type":"code","lang":"python","value":"from freqtrade.persistence import Trade\nfrom datetime import timedelta\n\nclass AwesomeStrategy(IStrategy):\n\n    def bot_loop_start(self, **kwargs) -> None:\n        for trade in Trade.get_open_order_trades():\n            fills = trade.select_filled_orders(trade.entry_side)\n            if trade.pair == 'ETH/USDT':\n                trade_entry_type = trade.get_custom_data(key='entry_type')\n                if trade_entry_type is None:\n                    trade_entry_type = 'breakout' if 'entry_1' in trade.enter_tag else 'dip'\n                elif fills > 1:\n                    trade_entry_type = 'buy_up'\n                trade.set_custom_data(key='entry_type', value=trade_entry_type)\n        return super().bot_loop_start(**kwargs)\n\n    def adjust_entry_price(self, trade: Trade, order: Order | None, pair: str,\n                           current_time: datetime, proposed_rate: float, current_order_rate: float,\n                           entry_tag: str | None, side: str, **kwargs) -> float:\n        # 对于 BTC/USDT 交易对，在入场触发后的前 10 分钟内使用限价单并跟随 SMA200 作为价格目标。\n        if (\n            pair == 'BTC/USDT' \n            and entry_tag == 'long_sma200' \n            and side == 'long' \n            and (current_time - timedelta(minutes=10)) > trade.open_date_utc \n            and order.filled == 0.0\n        ):\n            dataframe, _ = self.dp.get_analyzed_dataframe(pair=pair, timeframe=self.timeframe)\n            current_candle = dataframe.iloc[-1].squeeze()\n            # 存储入场调整信息\n            existing_count = trade.get_custom_data('num_entry_adjustments', default=0)\n            if not existing_count:\n                existing_count = 1\n            else:\n                existing_count += 1\n            trade.set_custom_data(key='num_entry_adjustments', value=existing_count)\n\n            # 调整订单价格\n            return current_candle['sma_200']\n\n        # 默认：维持现有订单\n        return current_order_rate\n\n    def custom_exit(self, pair: str, trade: Trade, current_time: datetime, current_rate: float, current_profit: float, **kwargs):\n\n        entry_adjustment_count = trade.get_custom_data(key='num_entry_adjustments')\n        trade_entry_type = trade.get_custom_data(key='entry_type')\n        if entry_adjustment_count is None:\n            if current_profit > 0.01 and (current_time - timedelta(minutes=100) > trade.open_date_utc):\n                return True, 'exit_1'\n        else\n            if entry_adjustment_count > 0 and if current_profit > 0.05:\n                return True, 'exit_2'\n            if trade_entry_type == 'breakout' and current_profit > 0.1:\n                return True, 'exit_3\n\n        return False, None","position":{"start":{"line":33,"column":1},"end":{"line":92,"column":1}},"key":"Jtu3TPyhkf"},{"type":"paragraph","position":{"start":{"line":94,"column":1},"end":{"line":94,"column":1}},"children":[{"type":"text","value":"上面是一个简单的例子 - 有更简单的方法来检索交易数据，如入场调整。","position":{"start":{"line":94,"column":1},"end":{"line":94,"column":1}},"key":"FiEoPCOIAM"}],"key":"MAWqPdUQDG"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"heiTocTCi3"}],"key":"smOFJKRTuN"},{"type":"paragraph","position":{"start":{"line":97,"column":1},"end":{"line":97,"column":1}},"children":[{"type":"text","value":"建议使用简单的数据类型 ","position":{"start":{"line":97,"column":1},"end":{"line":97,"column":1}},"key":"z9ceDrxET6"},{"type":"inlineCode","value":"[bool, int, float, str]","position":{"start":{"line":97,"column":1},"end":{"line":97,"column":1}},"key":"QnG2BVsW1Q"},{"type":"text","value":" 以确保序列化需要存储的数据时不会出现问题。","position":{"start":{"line":97,"column":1},"end":{"line":97,"column":1}},"key":"Kh79xBhZJ1"}],"key":"bzSh7ibgEy"},{"type":"paragraph","position":{"start":{"line":99,"column":1},"end":{"line":99,"column":1}},"children":[{"type":"text","value":"存储大量数据可能会导致意外的副作用，如数据库变大（因此也会变慢）。","position":{"start":{"line":99,"column":1},"end":{"line":99,"column":1}},"key":"Z6rylkwcC4"}],"key":"MXp8Ajkrpa"}],"key":"Yvxg2vQhyv"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"不可序列化的数据","position":{"start":{"line":102,"column":1},"end":{"line":102,"column":1}},"key":"blTxvsT7ve"}],"key":"tdRNmhhIVq"},{"type":"paragraph","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"children":[{"type":"text","value":"如果提供的数据无法序列化，将记录警告，并且指定 ","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"gyNpVX2Azo"},{"type":"inlineCode","value":"key","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"nqpAcPmPkw"},{"type":"text","value":" 的条目将包含 ","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"tMbMLtgZdY"},{"type":"inlineCode","value":"None","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"FCBwZhqWwR"},{"type":"text","value":" 作为数据。","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"q5z8FIWKMc"}],"key":"CkA0gNIEGC"}],"key":"WfPPeSF3U2"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"所有属性","position":{"start":{"line":106,"column":1},"end":{"line":106,"column":1}},"key":"VUH3nU5udZ"}],"key":"mu0jqbzzKb"},{"type":"paragraph","position":{"start":{"line":107,"column":1},"end":{"line":107,"column":1}},"children":[{"type":"text","value":"通过 Trade 对象（下面假设为 ","position":{"start":{"line":107,"column":1},"end":{"line":107,"column":1}},"key":"xJ2wOvxBrY"},{"type":"inlineCode","value":"trade","position":{"start":{"line":107,"column":1},"end":{"line":107,"column":1}},"key":"YAXMk4QwE1"},{"type":"text","value":"）可以访问以下自定义数据访问器：","position":{"start":{"line":107,"column":1},"end":{"line":107,"column":1}},"key":"AGZtrNsPJu"}],"key":"Iz2CpVjOAf"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":109,"column":1},"end":{"line":112,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":109,"column":1},"end":{"line":109,"column":1}},"children":[{"type":"inlineCode","value":"trade.get_custom_data(key='something', default=0)","position":{"start":{"line":109,"column":1},"end":{"line":109,"column":1}},"key":"LjvIB3sbPF"},{"type":"text","value":" - 返回以提供的类型给出的实际值。","position":{"start":{"line":109,"column":1},"end":{"line":109,"column":1}},"key":"iDhr3puKDe"}],"key":"UEUyIaiuKb"},{"type":"listItem","spread":true,"position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"children":[{"type":"inlineCode","value":"trade.get_custom_data_entry(key='something')","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"key":"MZxpgAMjMY"},{"type":"text","value":" - 返回条目 - 包括元数据。可以通过 ","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"key":"oUxdG1mIlO"},{"type":"inlineCode","value":".value","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"key":"yqIlwX3Ly0"},{"type":"text","value":" 属性访问值。","position":{"start":{"line":110,"column":1},"end":{"line":110,"column":1}},"key":"kLXboNccB6"}],"key":"PVXbUFayfa"},{"type":"listItem","spread":true,"position":{"start":{"line":111,"column":1},"end":{"line":112,"column":1}},"children":[{"type":"inlineCode","value":"trade.set_custom_data(key='something', value={'some': 'value'})","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"key":"jNFx2YDOuw"},{"type":"text","value":" - 设置或更新此交易的相应键。值必须是可序列化的 - 我们建议保持存储的数据相对较小。","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"key":"XyUuecLNyl"}],"key":"UN3UDBqxtp"}],"key":"r6YjsvWzrI"},{"type":"paragraph","position":{"start":{"line":113,"column":1},"end":{"line":113,"column":1}},"children":[{"type":"text","value":"“value” 可以是任何类型（在设置和接收时都是）- 但必须是 json 可序列化的。","position":{"start":{"line":113,"column":1},"end":{"line":113,"column":1}},"key":"BbMQUgczpI"}],"key":"b9el8vXXM1"}],"key":"S1DTO1VBKM"},{"type":"heading","depth":3,"position":{"start":{"line":116,"column":1},"end":{"line":116,"column":1}},"children":[{"type":"text","value":"存储信息（非持久化）","position":{"start":{"line":116,"column":1},"end":{"line":116,"column":1}},"key":"gUyQTYc4ZF"}],"identifier":"id","label":"存储信息（非持久化）","html_id":"id-2","implicit":true,"key":"C5ZJrE3QgU"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"已弃用","position":{"start":{"line":118,"column":1},"end":{"line":118,"column":1}},"key":"yR0udviNhL"}],"key":"KGRsKE001Q"},{"type":"paragraph","position":{"start":{"line":119,"column":1},"end":{"line":120,"column":1}},"children":[{"type":"text","value":"这种存储信息的方法已弃用，我们建议不要使用非持久化存储。\n请改用","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"FAtcTsYpqr"},{"type":"link","url":"#storing-information-persistent","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"children":[{"type":"text","value":"持久化存储","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"L0hRlbZHHs"}],"urlSource":"#storing-information-persistent","key":"h1sYITjKRZ"},{"type":"text","value":"。","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"hPfuRADgXV"}],"key":"W3LAYT3DJ6"},{"type":"paragraph","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"children":[{"type":"text","value":"因此其内容已被折叠。","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"key":"L3nx8mysFl"}],"key":"zGBeDyi6L3"}],"key":"Ew5bcnZOC3"},{"type":"admonition","kind":"attention","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"存储信息","position":{"start":{"line":125,"column":1},"end":{"line":125,"column":1}},"key":"GU29ZIA7Tt"}],"key":"kBsCAOgyY5"},{"type":"paragraph","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"children":[{"type":"text","value":"可以通过在策略类中创建新字典来存储信息。","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"ido1YWWmvJ"}],"key":"rlnkkb1gzj"},{"type":"paragraph","position":{"start":{"line":128,"column":1},"end":{"line":128,"column":1}},"children":[{"type":"text","value":"变量的名称可以随意选择，但应该以 ","position":{"start":{"line":128,"column":1},"end":{"line":128,"column":1}},"key":"vk186QOf18"},{"type":"inlineCode","value":"custom_","position":{"start":{"line":128,"column":1},"end":{"line":128,"column":1}},"key":"JXBPjYsU1m"},{"type":"text","value":" 为前缀，以避免与预定义的策略变量发生命名冲突。","position":{"start":{"line":128,"column":1},"end":{"line":128,"column":1}},"key":"zcIKbzaS6l"}],"key":"za3iJLVSsH"},{"type":"code","lang":"python","value":"class AwesomeStrategy(IStrategy):\n    # 创建自定义字典\n    custom_info = {}\n\n    def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:\n        # 检查条目是否已存在\n        if not metadata[\"pair\"] in self.custom_info:\n            # 为此交易对创建空条目\n            self.custom_info[metadata[\"pair\"]] = {}\n\n        if \"crosstime\" in self.custom_info[metadata[\"pair\"]]:\n            self.custom_info[metadata[\"pair\"]][\"crosstime\"] += 1\n        else:\n            self.custom_info[metadata[\"pair\"]][\"crosstime\"] = 1","position":{"start":{"line":130,"column":1},"end":{"line":145,"column":1}},"key":"fR9GrC34me"}],"key":"dTy1Yc5nCt"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"LywniQc80O"}],"key":"IpDMpIi1Ee"},{"type":"paragraph","position":{"start":{"line":149,"column":1},"end":{"line":149,"column":1}},"children":[{"type":"text","value":"数据在机器人重启（或配置重载）后不会持久化。此外，数据量应该保持较小（不要使用 DataFrame 等），否则机器人将开始消耗大量内存，最终耗尽内存并崩溃。","position":{"start":{"line":149,"column":1},"end":{"line":149,"column":1}},"key":"Nd3m3vKJFr"}],"key":"gAMTawGK9K"}],"key":"ODazSgLzXr"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"ez4lplBqac"}],"key":"NGsefgQmBB"},{"type":"paragraph","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"children":[{"type":"text","value":"如果数据是特定于交易对的，请确保在字典中使用交易对作为键之一。","position":{"start":{"line":153,"column":1},"end":{"line":153,"column":1}},"key":"wKcP9IDnby"}],"key":"fR0qLln4hK"}],"key":"QYdox3KzHM"},{"type":"heading","depth":3,"position":{"start":{"line":157,"column":1},"end":{"line":157,"column":1}},"children":[{"type":"text","value":"数据框访问","position":{"start":{"line":157,"column":1},"end":{"line":157,"column":1}},"key":"DPhUXWG2gE"}],"identifier":"id","label":"数据框访问","html_id":"id-3","implicit":true,"key":"gYerhfuGVR"},{"type":"paragraph","position":{"start":{"line":159,"column":1},"end":{"line":159,"column":1}},"children":[{"type":"text","value":"你可以通过从数据提供者查询来在各种策略函数中访问数据框。","position":{"start":{"line":159,"column":1},"end":{"line":159,"column":1}},"key":"NyvJnu0q5I"}],"key":"Qfg5UJBJ7k"},{"type":"code","lang":"python","value":"from freqtrade.exchange import timeframe_to_prev_date\n\nclass AwesomeStrategy(IStrategy):\n    def confirm_trade_exit(self, pair: str, trade: 'Trade', order_type: str, amount: float,\n                           rate: float, time_in_force: str, exit_reason: str,\n                           current_time: 'datetime', **kwargs) -> bool:\n        # 获取交易对数据框。\n        dataframe, _ = self.dp.get_analyzed_dataframe(pair, self.timeframe)\n\n        # 获取最后一个可用的蜡烛图。不要使用 current_time 查找最新的蜡烛图，因为\n        # current_time 指向当前未完成的蜡烛图，其数据不可用。\n        last_candle = dataframe.iloc[-1].squeeze()\n        # <...>\n\n        # 在模拟/实盘运行中，交易开始日期不会匹配蜡烛图开始日期，因此必须\n        # 进行四舍五入。\n        trade_date = timeframe_to_prev_date(self.timeframe, trade.open_date_utc)\n        # 查找交易蜡烛图。\n        trade_candle = dataframe.loc[dataframe['date'] == trade_date]\n        # 对于刚刚开始的交易，trade_candle 可能为空，因为它仍然未完成。\n        if not trade_candle.empty:\n            trade_candle = trade_candle.squeeze()\n            # <...>","position":{"start":{"line":161,"column":1},"end":{"line":185,"column":1}},"key":"bogLj7iz8M"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"使用 .iloc[-1]","position":{"start":{"line":187,"column":1},"end":{"line":187,"column":1}},"key":"c0kT0m8YV8"}],"key":"RqAcxTfBgM"},{"type":"paragraph","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"children":[{"type":"text","value":"你可以在这里使用 ","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"key":"tj7kSlBfCi"},{"type":"inlineCode","value":".iloc[-1]","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"key":"SxCHOuCcMo"},{"type":"text","value":"，因为 ","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"key":"XZSnaeZhyB"},{"type":"inlineCode","value":"get_analyzed_dataframe()","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"key":"jKR90no2x5"},{"type":"text","value":" 只返回回测允许看到的蜡烛图。","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"key":"Ce9x73PW2B"}],"key":"fyN79PnyWj"},{"type":"paragraph","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"children":[{"type":"text","value":"这在 ","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"key":"ufRYWALrdy"},{"type":"inlineCode","value":"populate_*","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"key":"L0Bl9QW5bW"},{"type":"text","value":" 方法中不起作用，所以确保不要在该区域使用 ","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"key":"F5sdPvSQoU"},{"type":"inlineCode","value":".iloc[]","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"key":"MdMyoEG5Sa"},{"type":"text","value":"。","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"key":"dMAWYMIGUs"}],"key":"WjBSAVnB50"},{"type":"paragraph","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"children":[{"type":"text","value":"此外，这只能从 2021.5 版本开始工作。","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"oKXd1LfKbV"}],"key":"VASw3G0m78"}],"key":"X2uYrB1h1H"},{"type":"heading","depth":3,"position":{"start":{"line":195,"column":1},"end":{"line":195,"column":1}},"children":[{"type":"text","value":"入场标签","position":{"start":{"line":195,"column":1},"end":{"line":195,"column":1}},"key":"TpuHjQFElh"}],"identifier":"id","label":"入场标签","html_id":"id-4","implicit":true,"key":"hbArdHy6vo"},{"type":"paragraph","position":{"start":{"line":197,"column":1},"end":{"line":198,"column":1}},"children":[{"type":"text","value":"当你的策略有多个买入信号时，你可以命名触发的信号。\n然后你可以在 ","position":{"start":{"line":197,"column":1},"end":{"line":197,"column":1}},"key":"rDW0OdQvuY"},{"type":"inlineCode","value":"custom_exit","position":{"start":{"line":197,"column":1},"end":{"line":197,"column":1}},"key":"z5fPBAHjKy"},{"type":"text","value":" 中访问你的买入信号","position":{"start":{"line":197,"column":1},"end":{"line":197,"column":1}},"key":"SFZBnNC1Yc"}],"key":"My4GN9PwmT"},{"type":"code","lang":"python","value":"def populate_entry_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:\n    dataframe.loc[\n        (\n            (dataframe['rsi'] < 35) &\n            (dataframe['volume'] > 0)\n        ),\n        ['enter_long', 'enter_tag']] = (1, 'buy_signal_rsi')\n\n    return dataframe\n\ndef custom_exit(self, pair: str, trade: Trade, current_time: datetime, current_rate: float,\n                current_profit: float, **kwargs):\n    dataframe, _ = self.dp.get_analyzed_dataframe(pair, self.timeframe)\n    last_candle = dataframe.iloc[-1].squeeze()\n    if trade.enter_tag == 'buy_signal_rsi' and last_candle['rsi'] > 80:\n        return 'sell_signal_rsi'\n    return None\n","position":{"start":{"line":200,"column":1},"end":{"line":219,"column":1}},"key":"j0nbJ3S8N7"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"XEP1L1KUXb"}],"key":"JPwbCQRrWi"},{"type":"paragraph","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"children":[{"type":"inlineCode","value":"enter_tag","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"GUQjqojjM4"},{"type":"text","value":" 限制为 100 个字符，剩余数据将被截断。","position":{"start":{"line":222,"column":1},"end":{"line":222,"column":1}},"key":"sINAFPfBAA"}],"key":"HqBOCpBKNb"}],"key":"tVeMNrnWzr"},{"type":"admonition","kind":"warning","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"y1xN8RMcxJ"}],"key":"MNd264abpc"},{"type":"paragraph","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"children":[{"type":"text","value":"只有一个 ","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"izvAKNnWao"},{"type":"inlineCode","value":"enter_tag","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"PubpSmsCv8"},{"type":"text","value":" 列，用于做多和做空交易。","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"mHMV9tZNLi"}],"key":"qewe0IyCNb"},{"type":"paragraph","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"children":[{"type":"text","value":"因此，必须将此列视为\"最后写入获胜\"（毕竟它只是一个数据框列）。","position":{"start":{"line":228,"column":1},"end":{"line":228,"column":1}},"key":"imbVIiC97A"}],"key":"PFBaupqf7L"},{"type":"paragraph","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"children":[{"type":"text","value":"在复杂的情况下，当多个信号冲突（或如果信号基于不同条件再次停用）时，这可能导致奇怪的结果，错误的标签应用于入场信号。","position":{"start":{"line":230,"column":1},"end":{"line":230,"column":1}},"key":"Vl4hlIYeN6"}],"key":"V624TCMGDQ"},{"type":"paragraph","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"children":[{"type":"text","value":"这些结果是策略覆盖先前标签的结果 - 最后一个标签将\"粘住\"，并将是 freqtrade 使用的标签。","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"h5zO0m5YLe"}],"key":"dx2aAq09Pc"}],"key":"UZIdKdvwNb"},{"type":"heading","depth":3,"position":{"start":{"line":235,"column":1},"end":{"line":235,"column":1}},"children":[{"type":"text","value":"出场标签","position":{"start":{"line":235,"column":1},"end":{"line":235,"column":1}},"key":"qnVJB8czm1"}],"identifier":"id","label":"出场标签","html_id":"id-5","implicit":true,"key":"vasnjYO23Y"},{"type":"paragraph","position":{"start":{"line":237,"column":1},"end":{"line":237,"column":1}},"children":[{"type":"text","value":"类似于","position":{"start":{"line":237,"column":1},"end":{"line":237,"column":1}},"key":"NaGvQtCjiy"},{"type":"link","url":"#enter-tag","position":{"start":{"line":237,"column":1},"end":{"line":237,"column":1}},"children":[{"type":"text","value":"入场标签","position":{"start":{"line":237,"column":1},"end":{"line":237,"column":1}},"key":"qBWPWgb2yb"}],"urlSource":"#enter-tag","key":"iaN1JG3XEp"},{"type":"text","value":"，你也可以指定出场标签。","position":{"start":{"line":237,"column":1},"end":{"line":237,"column":1}},"key":"jhEy6DOMYo"}],"key":"UF79yf3xmn"},{"type":"code","lang":"python","value":"def populate_exit_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:\n    dataframe.loc[\n        (\n            (dataframe['rsi'] > 70) &\n            (dataframe['volume'] > 0)\n        ),\n        ['exit_long', 'exit_tag']] = (1, 'exit_rsi')\n\n    return dataframe","position":{"start":{"line":239,"column":1},"end":{"line":249,"column":1}},"key":"dNrLgdUYBY"},{"type":"paragraph","position":{"start":{"line":251,"column":1},"end":{"line":251,"column":1}},"children":[{"type":"text","value":"提供的出场标签然后用作卖出原因 - 并在回测结果中显示为如此。","position":{"start":{"line":251,"column":1},"end":{"line":251,"column":1}},"key":"O2VsjvuReo"}],"key":"FDkWeYP11I"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"dfK2dUA3Dn"}],"key":"UAIa8TJnV1"},{"type":"paragraph","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"children":[{"type":"inlineCode","value":"exit_reason","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"key":"jly1JTuO4g"},{"type":"text","value":" 限制为 100 个字符，剩余数据将被截断。","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"key":"MHGU1VtaRg"}],"key":"XJIYzlDWS9"}],"key":"ebib35z5Li"},{"type":"heading","depth":3,"position":{"start":{"line":257,"column":1},"end":{"line":257,"column":1}},"children":[{"type":"text","value":"策略版本","position":{"start":{"line":257,"column":1},"end":{"line":257,"column":1}},"key":"ZaIMdQZ5LT"}],"identifier":"id","label":"策略版本","html_id":"id-6","implicit":true,"key":"G6m5J08eLJ"},{"type":"paragraph","position":{"start":{"line":259,"column":1},"end":{"line":259,"column":1}},"children":[{"type":"text","value":"你可以通过使用 “version” 方法来实现自定义策略版本控制，并返回你希望此策略具有的版本。","position":{"start":{"line":259,"column":1},"end":{"line":259,"column":1}},"key":"HGM6lgFDCX"}],"key":"kPc59sGwpb"},{"type":"code","lang":"python","value":"def version(self) -> str:\n    \"\"\"\n    返回策略的版本。\n    \"\"\"\n    return \"1.1\"","position":{"start":{"line":261,"column":1},"end":{"line":267,"column":1}},"key":"Mqzz1J8rKR"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"GLvvCYmbMb"}],"key":"N2GCcuKxdE"},{"type":"paragraph","position":{"start":{"line":270,"column":1},"end":{"line":270,"column":1}},"children":[{"type":"text","value":"你应该确保同时实现适当的版本控制（如 git 仓库），因为 freqtrade 不会保留你的策略的历史版本，所以由用户负责能够最终回滚到策略的先前版本。","position":{"start":{"line":270,"column":1},"end":{"line":270,"column":1}},"key":"mwsPsODgKW"}],"key":"I4512YwxFg"}],"key":"Fw7BAcKs1H"},{"type":"heading","depth":3,"position":{"start":{"line":273,"column":1},"end":{"line":273,"column":1}},"children":[{"type":"text","value":"派生策略","position":{"start":{"line":273,"column":1},"end":{"line":273,"column":1}},"key":"ACm10Vb9T5"}],"identifier":"id","label":"派生策略","html_id":"id-7","implicit":true,"key":"fxhsvs0Ltl"},{"type":"paragraph","position":{"start":{"line":275,"column":1},"end":{"line":275,"column":1}},"children":[{"type":"text","value":"策略可以从其他策略派生。这避免了自定义策略代码的重复。你可以使用这种技术来覆盖主策略的小部分，保持其余部分不变：","position":{"start":{"line":275,"column":1},"end":{"line":275,"column":1}},"key":"yjRoDP3cEU"}],"key":"F0TJyFxAsT"},{"type":"code","lang":"python","value":"class MyAwesomeStrategy(IStrategy):\n    ...\n    stoploss = 0.13\n    trailing_stop = False\n    # 所有其他属性和方法都在这里，就像\n    # 在任何自定义策略中一样...\n    ...\n","position":{"start":{"line":277,"column":1},"end":{"line":286,"column":1}},"key":"ueeXm1k2qB"},{"type":"code","lang":"python","value":"from myawesomestrategy import MyAwesomeStrategy\nclass MyAwesomeStrategy2(MyAwesomeStrategy):\n    # 覆盖某些内容\n    stoploss = 0.08\n    trailing_stop = True","position":{"start":{"line":288,"column":1},"end":{"line":294,"column":1}},"key":"nGITnQZfvK"},{"type":"paragraph","position":{"start":{"line":296,"column":1},"end":{"line":296,"column":1}},"children":[{"type":"text","value":"属性和方法都可以被覆盖，以你需要的方式改变原始策略的行为。","position":{"start":{"line":296,"column":1},"end":{"line":296,"column":1}},"key":"Oot4SJMdBR"}],"key":"eOos7z2g0F"},{"type":"paragraph","position":{"start":{"line":298,"column":1},"end":{"line":298,"column":1}},"children":[{"type":"text","value":"虽然在技术上可以在同一文件中保持子类，但这可能会导致超优化参数文件的一些问题，因此我们建议使用单独的策略文件，并如上所示导入父策略。","position":{"start":{"line":298,"column":1},"end":{"line":298,"column":1}},"key":"NEetFyQ9Ig"}],"key":"eWYc2fHQmX"},{"type":"heading","depth":3,"position":{"start":{"line":300,"column":1},"end":{"line":300,"column":1}},"children":[{"type":"text","value":"嵌入策略","position":{"start":{"line":300,"column":1},"end":{"line":300,"column":1}},"key":"bpV7VkAjAp"}],"identifier":"id","label":"嵌入策略","html_id":"id-8","implicit":true,"key":"bU2ZIhVKyw"},{"type":"paragraph","position":{"start":{"line":302,"column":1},"end":{"line":303,"column":1}},"children":[{"type":"text","value":"Freqtrade 为你提供了一种简单的方法来将策略嵌入到配置文件中。\n这是通过利用 BASE64 编码并在你选择的配置文件的策略配置字段中提供此字符串来完成的。","position":{"start":{"line":302,"column":1},"end":{"line":302,"column":1}},"key":"aueWyHAYGM"}],"key":"j9eyXZssmx"},{"type":"heading","depth":4,"position":{"start":{"line":305,"column":1},"end":{"line":305,"column":1}},"children":[{"type":"text","value":"将字符串编码为 BASE64","position":{"start":{"line":305,"column":1},"end":{"line":305,"column":1}},"key":"gsF7SFX7Ug"}],"identifier":"id-base64","label":"将字符串编码为 BASE64","html_id":"id-base64","implicit":true,"key":"Hlfe11UAE7"},{"type":"paragraph","position":{"start":{"line":307,"column":1},"end":{"line":307,"column":1}},"children":[{"type":"text","value":"这是一个快速示例，如何在 python 中生成 BASE64 字符串","position":{"start":{"line":307,"column":1},"end":{"line":307,"column":1}},"key":"NCPA2zjXcm"}],"key":"yhWvTy3l48"},{"type":"code","lang":"python","value":"from base64 import urlsafe_b64encode\n\nwith open(file, 'r') as f:\n    content = f.read()\ncontent = urlsafe_b64encode(content.encode('utf-8'))","position":{"start":{"line":309,"column":1},"end":{"line":315,"column":1}},"key":"Moerj0SgKx"},{"type":"paragraph","position":{"start":{"line":317,"column":1},"end":{"line":317,"column":1}},"children":[{"type":"text","value":"变量 ‘content’ 将包含 BASE64 编码形式的策略文件。现在可以在配置文件中设置如下","position":{"start":{"line":317,"column":1},"end":{"line":317,"column":1}},"key":"Pmezw7Dt1b"}],"key":"oYaJKb6QuJ"},{"type":"code","lang":"json","value":"\"strategy\": \"NameOfStrategy:BASE64String\"","position":{"start":{"line":319,"column":1},"end":{"line":321,"column":1}},"key":"Sen3g1cezE"},{"type":"paragraph","position":{"start":{"line":323,"column":1},"end":{"line":323,"column":1}},"children":[{"type":"text","value":"请确保 ‘NameOfStrategy’ 与策略名称完全相同！","position":{"start":{"line":323,"column":1},"end":{"line":323,"column":1}},"key":"tUGg54Dpag"}],"key":"jlyI0Qfmiw"},{"type":"heading","depth":3,"position":{"start":{"line":325,"column":1},"end":{"line":325,"column":1}},"children":[{"type":"text","value":"性能警告","position":{"start":{"line":325,"column":1},"end":{"line":325,"column":1}},"key":"mlil6fc5yL"}],"identifier":"id","label":"性能警告","html_id":"id-9","implicit":true,"key":"BkJU0veOtH"},{"type":"paragraph","position":{"start":{"line":327,"column":1},"end":{"line":327,"column":1}},"children":[{"type":"text","value":"在执行策略时，有时会在日志中看到以下内容","position":{"start":{"line":327,"column":1},"end":{"line":327,"column":1}},"key":"qOeuogWn7v"}],"key":"khZuh4TcmK"},{"type":"blockquote","position":{"start":{"line":329,"column":1},"end":{"line":329,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":329,"column":1},"end":{"line":329,"column":1}},"children":[{"type":"text","value":"PerformanceWarning: DataFrame is highly fragmented.","position":{"start":{"line":329,"column":1},"end":{"line":329,"column":1}},"key":"yhAxGJO15t"}],"key":"f1pfLHVPGV"}],"key":"Kr2IrZtWtJ"},{"type":"paragraph","position":{"start":{"line":331,"column":1},"end":{"line":333,"column":1}},"children":[{"type":"text","value":"这是来自 ","position":{"start":{"line":331,"column":1},"end":{"line":331,"column":1}},"key":"Vh3o8TBslQ"},{"type":"link","url":"https://github.com/pandas-dev/pandas","position":{"start":{"line":331,"column":1},"end":{"line":331,"column":1}},"children":[{"type":"inlineCode","value":"pandas","position":{"start":{"line":331,"column":1},"end":{"line":331,"column":1}},"key":"ljsDYxColZ"}],"urlSource":"https://github.com/pandas-dev/pandas","error":true,"key":"f6d4kgMaHx"},{"type":"text","value":" 的警告，正如警告继续说的：\n使用 ","position":{"start":{"line":331,"column":1},"end":{"line":331,"column":1}},"key":"fTCg0nCHP2"},{"type":"inlineCode","value":"pd.concat(axis=1)","position":{"start":{"line":331,"column":1},"end":{"line":331,"column":1}},"key":"oKOWzQhHnU"},{"type":"text","value":"。\n这可能会有轻微的性能影响，通常只在超优化期间可见（在优化指标时）。","position":{"start":{"line":331,"column":1},"end":{"line":331,"column":1}},"key":"xl1WBF4lVt"}],"key":"d3fAfgcJxr"},{"type":"paragraph","position":{"start":{"line":335,"column":1},"end":{"line":335,"column":1}},"children":[{"type":"text","value":"例如：","position":{"start":{"line":335,"column":1},"end":{"line":335,"column":1}},"key":"SfcfIGvdvp"}],"key":"ThBhchqTW7"},{"type":"code","lang":"python","value":"for val in self.buy_ema_short.range:\n    dataframe[f'ema_short_{val}'] = ta.EMA(dataframe, timeperiod=val)","position":{"start":{"line":337,"column":1},"end":{"line":340,"column":1}},"key":"ni5VgEDuzq"},{"type":"paragraph","position":{"start":{"line":342,"column":1},"end":{"line":342,"column":1}},"children":[{"type":"text","value":"应该重写为","position":{"start":{"line":342,"column":1},"end":{"line":342,"column":1}},"key":"ne2qifYPnX"}],"key":"tIitiVmHDY"},{"type":"code","lang":"python","value":"frames = [dataframe]\nfor val in self.buy_ema_short.range:\n    frames.append(DataFrame({\n        f'ema_short_{val}': ta.EMA(dataframe, timeperiod=val)\n    }))\n\n# 组合所有数据框，并重新分配原始数据框列\ndataframe = pd.concat(frames, axis=1)","position":{"start":{"line":344,"column":1},"end":{"line":353,"column":1}},"key":"cXS62c4yAH"},{"type":"paragraph","position":{"start":{"line":355,"column":1},"end":{"line":355,"column":1}},"children":[{"type":"text","value":"然而，Freqtrade 通过在 ","position":{"start":{"line":355,"column":1},"end":{"line":355,"column":1}},"key":"ccbiiCGlkR"},{"type":"inlineCode","value":"populate_indicators()","position":{"start":{"line":355,"column":1},"end":{"line":355,"column":1}},"key":"pTxfetDC88"},{"type":"text","value":" 方法之后立即运行 ","position":{"start":{"line":355,"column":1},"end":{"line":355,"column":1}},"key":"HtA5roJBUI"},{"type":"inlineCode","value":"dataframe.copy()","position":{"start":{"line":355,"column":1},"end":{"line":355,"column":1}},"key":"pz31wuF1rj"},{"type":"text","value":" 来抵消这一点 - 因此这的性能影响应该很低或不存在。","position":{"start":{"line":355,"column":1},"end":{"line":355,"column":1}},"key":"iX7zxpUu6o"}],"key":"rz8NOmAGm4"}],"key":"O2AFpUBy9a"}],"key":"X0wKgYwruG"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"递归分析指南","short_title":"递归分析","url":"/recursive-analysis","group":"高级话题"},"next":{"title":"高级超参数优化","short_title":"高级超参数优化","url":"/advanced-hyperopt","group":"高级话题"}}},"domain":"http://localhost:3002"}